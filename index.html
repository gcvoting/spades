<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              display: ['Outfit', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              brand: {
                obsidian: '#050505',
                charcoal: '#0a0a0a',
                card: '#121212',
                red: '#d92323',
                deepRed: '#500808',
                gold: '#e2b15b',
                goldDim: '#8a6d3b',
              }
            },
            animation: {
              'pulse-slow': 'pulse 8s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'float': 'float 10s ease-in-out infinite',
              'shine': 'shine 6s linear infinite',
              'shimmer': 'shimmer 3s ease-in-out infinite alternate',
              'glow': 'glow 4s ease-in-out infinite alternate',
            },
            keyframes: {
              float: {
                '0%, 100%': { transform: 'translateY(0)' },
                '50%': { transform: 'translateY(-15px)' },
              },
              shine: {
                '0%': { backgroundPosition: '200% center' },
                '100%': { backgroundPosition: '-200% center' },
              },
              shimmer: {
                '0%': { opacity: 0.5 },
                '100%': { opacity: 1 },
              },
              glow: {
                '0%': { boxShadow: '0 0 10px rgba(217, 35, 35, 0.1)' },
                '100%': { boxShadow: '0 0 30px rgba(217, 35, 35, 0.3), 0 0 15px rgba(226, 177, 91, 0.1)' }
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #020202;
        color: #f5f5f5;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      /* Ultra-Premium Background */
      .cinematic-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: -1;
        background: radial-gradient(circle at 50% -20%, #1a0505 0%, #020202 50%);
        pointer-events: none;
      }

      .noise-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.04;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        pointer-events: none;
        mix-blend-mode: overlay;
      }

      /* Refined Scrollbar */
      ::-webkit-scrollbar {
        width: 4px;
      }
      ::-webkit-scrollbar-track {
        background: #020202;
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #d92323;
      }
      
      /* High-End Glassmorphism */
      .glass-panel {
        background: rgba(10, 10, 10, 0.6);
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      }
      
      .glass-card-hover {
        transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      }
      .glass-card-hover:hover {
        background: rgba(20, 20, 20, 0.8);
        border-color: rgba(255, 255, 255, 0.1);
        transform: translateY(-4px);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
      }

      /* Gold Text Effect */
      .text-gradient-gold {
        background: linear-gradient(135deg, #fceeb5 0%, #e2b15b 50%, #8a6d3b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 100% auto;
      }
      
      /* Red Text Effect */
      .text-gradient-red {
        background: linear-gradient(135deg, #ff8080 0%, #d92323 60%, #500808 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.32.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "path": "https://esm.sh/path@^0.12.7",
    "vite": "https://esm.sh/vite@^7.3.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>

</head>
  <body>
    <div class="cinematic-bg"></div>
    <div class="noise-overlay"></div>
    <div id="root"></div>
    
  
<script type="module-shim" data-module="./types.js">

export 
export 

export 

export ;
  isAdmin= 'CHAT',
  STUDIO = 'STUDIO',
  LIVE = 'LIVE',
  SETTINGS = 'SETTINGS',
}

export const LiveConnectionState = {
  DISCONNECTED = 'Disconnected',
  CONNECTING = 'Connecting',
  CONNECTED = 'Connected',
  ERROR = 'Error',
};

</script>

<script type="module-shim" data-module="./App.js">

import React, { useState, useEffect, useCallback } from 'react';
import { storage } from './services/storageService';
import { User, SystemSettings, RankID } from './types';
import { RANKS } from './constants';
import Nav from './components/Nav';
import Feed from './components/Feed';
import Dashboard from './components/Dashboard';
import Leaderboard from './components/Leaderboard';
import CouncilChamber from './components/CouncilChamber';
import AceControls from './components/AceControls';
import ArtGallery from './components/ArtGallery';
import FocusRealm from './components/FocusRealm';
import Portfolio from './components/Portfolio';
import Guide from './components/Guide';
import Settings from './components/Settings';

const AuthScreen) => void; onBack) => void }> = ({ onLogin, onBack }) => {
  const [mode, setMode] = useState('login');
  const [id, setId] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [settings, setSettings] = useState(null);

  useEffect(() => {
    storage.getSettings().then(setSettings);
  }, []);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setIsProcessing(true);

    const normalizedId = id.toUpperCase();
    const idMatch = normalizedId.match(/^S25(\d{4,5})$/);
    
    if (!idMatch) {
        setError('ACCESS DENIED // INVALID FORMAT);
        setIsProcessing(false);
        return;
    }

    if (mode === 'login') {
        const user = await storage.getUser(normalizedId);
        if (user) {
            if (user.studentId === 'S253456' && user.isBanned) {
                const correctedAce = { ...user, isBanned);
                onLogin(correctedAce);
                setIsProcessing(false);
                return;
            }

            if (user.isBanned) {
                setError('ACCESS REVOKED // YOUR ACCOUNT HAS BEEN BANNED BY THE ACE.');
                setIsProcessing(false);
                return;
            } 
            
            if (user.passwordHash === password) {
                onLogin(user);
            } else {
                setError('AUTHENTICATION FAILED // INVALID KEY');
            }
        } else {
            setError('ACCESS DENIED // ACCOUNT NOT FOUND.');
        }
    } else {
        if (password.length < 8) {
            setError('REGISTRATION FAILED // PASSWORD TOO WEAK');
        } else {
            const exists = await storage.userExists(normalizedId);
            if (exists) {
                setError('REGISTRATION FAILED // ID ALREADY REGISTERED');
            } else {
                const newUser: User = {
                    studentId,
                    username,
                    passwordHash,
                    currentRank,
                    currentCard,
                    totalPoints,
                    joinDate).toISOString(),
                    lastActive).toISOString(),
                    yearGroup,
                    house, 'Dragon', 'Griffin', 'Raven'][Math.floor(Math.random() * 4)],
                    stats, commentsCreated, votesGiven, resourcesShared, moderationsPerformed, minutesStudied,
                    isAdmin: normalizedId === 'S253456', 
                    requiresPasswordChange,
                    inventory);
                onLogin(newUser);
            }
        }
    }
    setIsProcessing(false);
  };

  const handleGuestLogin = async () => {
    setIsProcessing(true);
    const guestId = `GUEST-${Math.floor(1000 + Math.random() * 9000)}`;
    const guestUser: User = {
        studentId,
        username,
        passwordHash,
        currentRank,
        currentCard,
        totalPoints,
        joinDate).toISOString(),
        lastActive).toISOString(),
        yearGroup,
        house,
        stats, commentsCreated, votesGiven, resourcesShared, moderationsPerformed, minutesStudied,
        isAdmin,
        requiresPasswordChange,
        inventory,
        isGuest);
    onLogin(guestUser);
  };

  return (
    <div className="min-h-screen bg-[#020202] flex items-center justify-center p-4 relative overflow-hidden font-sans">
      <div className="absolute inset-0 bg-[url('https)] opacity-[0.4] mix-blend-overlay"></div>
      
      <div className="max-w-[900px] w-full grid grid-cols-1 md:grid-cols-2 bg-[#050505]/80 backdrop-blur-3xl border border-white/5 rounded-[32px] shadow-2xl relative overflow-hidden">
        <button onClick={onBack} className="absolute top-6 left-6 text-neutral-600 hover:text-white transition-colors z-30">
            <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
        </button>

        <div className="relative p-12 bg-black/50">
            <h1 className="text-6xl font-display font-black text-white tracking-tighter mb-4">SPA<span className="text-brand-red">DES</span></h1>
            <p className="text-brand-gold font-mono text-xs uppercase tracking-[0.4em] font-bold opacity-80">The Spades Protocol</p>
        </div>

        <div className="p-12 bg-[#080808] border-l border-white/5 flex flex-col justify-center">
            <div className="flex gap-4 mb-10 border-b border-white/5">
                {['login', 'register'].map(m => (
                    <button key={m} onClick={() => { setMode(m); setError(''); }} className={`pb-2 text-xs font-bold uppercase tracking-widest ${mode === m ? 'text-white border-b-2 border-brand-red' : 'text-neutral-500 hover))}
            </div>

            <form onSubmit={handleSubmit} className="space-y-6">
                <div className="space-y-2">
                    <label className="text-[10px] font-bold text-neutral-500 uppercase tracking-widest">Student ID</label>
                    <input type="text" value={id} onChange={(e) => setId(e.target.value)} placeholder="S25XXXX" maxLength={8} className="w-full bg-[#111] border border-[#222] rounded-xl p-4 text-white font-mono" />
                </div>
                <div className="space-y-2">
                    <label className="text-[10px] font-bold text-neutral-500 uppercase tracking-widest">Security Key</label>
                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" className="w-full bg-[#111] border border-[#222] rounded-xl p-4 text-white font-mono" />
                </div>
                {error && <div className="p-3 bg-red-950/20 border border-red-900/40 rounded-lg text-red-400 text-[10px] font-mono uppercase leading-relaxed">{error}</div>}
                <button type="submit" disabled={isProcessing} className="w-full bg-white text-black font-bold py-4 rounded-xl hover:scale-[1.01] transition-all uppercase tracking-widest text-xs">
                    {isProcessing ? 'Processing...' : (mode === 'login' ? 'Authenticate' : 'Initiate Identity')}
                </button>
            </form>

            {settings?.allowGuestAccess && (
                <div className="mt-6 pt-6 border-t border-white/5">
                    <button onClick={handleGuestLogin} disabled={isProcessing} className="w-full py-3 text-neutral-500 hover:text-white font-mono text-xs uppercase tracking-widest transition-colors flex items-center justify-center gap-2">
                        <span>Continue</span>
                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                    </button>
                </div>
            )}
        </div>
      </div>
    </div>
  );
};

const PasswordResetScreen) => void }> = ({ user, onSuccess }) => {
    const [password, setPassword] = useState('');
    const [confirm, setConfirm] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        if (password.length < 8) return setError('Password must be at least 8 characters.');
        if (password !== confirm) return setError('Passwords do not match.');
        
        setLoading(true);
        await storage.updatePassword(user.studentId, password);
        setLoading(false);
        onSuccess();
    };

    return (
        <div className="min-h-screen bg-[#020202] flex items-center justify-center p-4">
             <div className="max-w-md w-full bg-[#080808] border border-red-900/40 rounded-3xl p-10 shadow-[0_0_50px_rgba(220,38,38,0.2)]">
                 <div className="flex justify-center mb-6">
                     <div className="w-16 h-16 rounded-full bg-red-900/20 flex items-center justify-center animate-pulse">
                         <svg className="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                     </div>
                 </div>
                 <h2 className="text-2xl font-display font-bold text-white text-center mb-2">SECURITY ALERT</h2>
                 <p className="text-center text-neutral-500 text-xs font-mono uppercase tracking-widest mb-8">Protocol Requires Mandatory Key Change</p>
                 
                 <form onSubmit={handleSubmit} className="space-y-4">
                     <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="New Secure Key" className="w-full bg-[#111] border border-[#222] rounded-xl p-4 text-white font-mono" />
                     <input type="password" value={confirm} onChange={e => setConfirm(e.target.value)} placeholder="Confirm Secure Key" className="w-full bg-[#111] border border-[#222] rounded-xl p-4 text-white font-mono" />
                     {error && <div className="p-3 bg-red-950/20 text-red-400 text-xs font-bold text-center">{error}</div>}
                     <button type="submit" disabled={loading} className="w-full bg-brand-red text-white font-bold py-4 rounded-xl uppercase tracking-widest text-xs hover);
};

const App: React.FC = () => {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('portfolio');
  const [activeTab, setActiveTab] = useState('dashboard');
  const [dataVersion, setDataVersion] = useState(0); 

  const checkRankUp = useCallback(async (u) => {
      const rankSequence: RankID[] = ['2â™ ', '3â™ ', '4â™ ', '5â™ ', '6â™ ', '7â™ ', '8â™ ', '9â™ ', '10â™ ', 'Jâ™ ', 'Qâ™ ', 'Kâ™ ', 'Aâ™ '];
      let currentRankIdx = rankSequence.indexOf(u.currentCard);

      // Determine rank based on point total
      let highestEligibleIdxByPoints = 0;
      for (let i = 0; i < rankSequence.length; i++) {
          if (u.totalPoints >= RANKS[rankSequence[i]].minPoints) {
              highestEligibleIdxByPoints = i;
          }
      }

      /**
       * CRITICAL LOGIC),
       * the system won't automatically pull them back down to their point-bracket.
       */
      if (highestEligibleIdxByPoints > currentRankIdx) {
          const newRankId = rankSequence[highestEligibleIdxByPoints];
          const updatedUser = { ...u, currentCard, currentRank);
          setUser(updatedUser);
      } else {
          // Maintaining manual override or current standing
          setUser(u);
      }
  }, []);

  const refreshData = useCallback(async () => {
      const savedId = localStorage.getItem('session_user_id');
      if (!savedId) return;
      const freshUser = await storage.getUser(savedId);
      if (freshUser) {
          if (freshUser.isBanned && freshUser.studentId !== 'S253456') handleLogout();
          else {
              // Ensure we don't cause infinite state loop if checkRankUp just returns u
              setUser(freshUser);
              checkRankUp(freshUser);
              setDataVersion(v => v + 1);
          }
      }
  }, [checkRankUp]);

  useEffect(() => {
    const savedId = localStorage.getItem('session_user_id');
    if (savedId) {
       storage.getUser(savedId).then(u => {
           if (u) {
               if (u.studentId === 'S253456' && u.isBanned) {
                   storage.updateUserStatus('S253456', { isBanned).then(() => {
                        const fixedAce = { ...u, isBanned);
                        setView('app');
                   });
                   return;
               }

               if (u.isBanned) {
                   handleLogout();
               } else {
                   setUser(u);
                   setView('app');
                   checkRankUp(u);
               }
           }
       });
    }

    const handleStorageUpdate = (e) => {
        if (e.key === 'users' || e.key === 'art_pieces') {
            refreshData();
        }
    };
    
    const handleInternalUpdate = () => {
        refreshData();
    };

    window.addEventListener('storage', handleStorageUpdate);
    window.addEventListener('storage_update', handleInternalUpdate);
    
    return () => {
        window.removeEventListener('storage', handleStorageUpdate);
        window.removeEventListener('storage_update', handleInternalUpdate);
    };
  }, [refreshData, checkRankUp]);

  const handleLogin = (u) => {
    localStorage.setItem('session_user_id', u.studentId);
    setUser(u);
    setView('app');
    checkRankUp(u);
  };

  const handleLogout = () => {
    localStorage.removeItem('session_user_id');
    setUser(null);
    setView('portfolio');
  };

  if (view === 'portfolio') return <Portfolio onEnterSystem={() => setView('auth')} />;
  if (view === 'auth' && !user) return <AuthScreen onLogin={handleLogin} onBack={() => setView('portfolio')} />;

  if (!user) return <Portfolio onEnterSystem={() => setView('auth')} />;

  if (user.requiresPasswordChange && !user.isGuest) {
      return <PasswordResetScreen user={user} onSuccess={refreshData} />;
  }

  return (
    <div className="min-h-screen bg-[#020202] text-neutral-100 flex font-sans">
      <Nav user={user} activeTab={activeTab} onTabChange={setActiveTab} onLogout={handleLogout} />
      <main className="flex-1 md:ml-72 p-4 md:p-10 overflow-x-hidden relative">
        <div className="max-w-6xl mx-auto mt-20 md:mt-0 relative z-10">
          {activeTab === 'dashboard' && <Dashboard user={user} />}
          {activeTab === 'feed' && <Feed currentUser={user} refreshTrigger={dataVersion} onActivity={refreshData} />}
          {activeTab === 'focus' && <FocusRealm currentUser={user} onActivity={refreshData} />}
          {activeTab === 'gallery' && <ArtGallery currentUser={user} onPurchase={refreshData} />}
          {activeTab === 'leaderboard' && <Leaderboard />}
          {activeTab === 'council' && <CouncilChamber currentUser={user} refreshTrigger={dataVersion} onActivity={refreshData} />}
          {activeTab === 'guide' && <Guide />}
          {activeTab === 'settings' && <Settings currentUser={user} onUpdate={refreshData} />}
          {activeTab === 'admin' && user.isAdmin && <AceControls currentUser={user} onActivity={refreshData} />}
        </div>
      </main>
    </div>
  );
};

export default App;

</script>

<script type="module-shim" data-module="./constants.js">

import { Rank, RankID } from './types';

export const RANKS, Rank> = {
  "2â™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote"], voteWeight,
  "3â™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote", "post", "comment"], voteWeight,
  "4â™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote", "post", "comment"], voteWeight,
  "5â™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote", "post", "comment"], voteWeight,
  "6â™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote", "post", "comment", "createPoll", "award"], voteWeight,
  "7â™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote", "post", "comment", "createPoll", "award"], voteWeight,
  "8â™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote", "post", "comment", "createPoll", "award"], voteWeight,
  "9â™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote", "post", "comment", "createPoll", "award", "submitPolicy", "studyGroups"], voteWeight,
  "10â™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote", "post", "comment", "createPoll", "award", "submitPolicy", "studyGroups"], voteWeight,
  "Jâ™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote", "post", "comment", "createPoll", "award", "submitPolicy", "studyGroups", "instantPost", "nominate"], voteWeight,
  "Qâ™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote", "post", "comment", "createPoll", "award", "submitPolicy", "studyGroups", "instantPost", "nominate", "moderate", "messageCouncil"], voteWeight,
  "Kâ™ ": { id, name, minPoints, maxPoints, tier, permissions, "vote", "post", "comment", "createPoll", "award", "submitPolicy", "studyGroups", "instantPost", "nominate", "moderate", "messageCouncil", "messageAce", "createChallenge", "finalModeration"], voteWeight,
  "Aâ™ ": { id, name, minPoints, maxPoints, tier, permissions, voteWeight: 100 }
};

export const HOUSES = ['Phoenix', 'Dragon', 'Griffin', 'Raven'];

export const INITIAL_USER_STATE = {
  stats,
    commentsCreated,
    votesGiven,
    resourcesShared,
    moderationsPerformed,
    minutesStudied: 0
  }
};

export const POINT_VALUES = {
  POST,
  COMMENT,
  UPVOTE_RECEIVED, 
  VOTE_ACTION,
  LOGIN,
  STUDY_MINUTE, 
};

</script>

<script type="module-shim" data-module="./vite.config.js">
import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');
    return {
      server,
        host,
      },
      plugins)],
      define),
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY)
      },
      resolve),
        }
      }
    };
});
</script>

<script type="module-shim" data-module="./index.js">
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import { storage } from './services/storageService';

// Initialize storage
storage.init().then(() => {
  const rootElement = document.getElementById('root');
  if (!rootElement) throw new Error('Failed to find the root element');
  
  const root = ReactDOM.createRoot(rootElement);
  root.render(
    <React.StrictMode>
      <App />
    </React.StrictMode>
  );
});

</script>

<script type="module-shim" data-module="./components/Sidebar.js">

import React from 'react';
import { AppTab } from '../types';



const Sidebar: React.FC<SidebarProps> = ({ activeTab, onTabChange }) => {
  const tabs = [
    { id, label, icon,
    { id, label, icon,
    { id, label, icon,
    { id, label, icon,
  ];

  return (
    <div className="flex flex-col h-full glass border-r border-white/5 p-4">
      <div className="flex items-center gap-3 mb-10 px-2">
        <div className="w-10 h-10 rounded-xl bg-gradient-to-tr from-blue-600 via-purple-600 to-pink-600 flex items-center justify-center shadow-lg shadow-purple-900/20">
          <i className="fas fa-sparkles text-white text-lg"></i>
        </div>
        <div>
          <h1 className="font-bold text-xl tracking-tight">Gemini Hub</h1>
          <p className="text-[10px] text-gray-500 uppercase tracking-widest font-semibold">Pro Studio</p>
        </div>
      </div>

      <nav className="space-y-2 flex-1">
        {tabs.map((tab) => (
          <button
            key={tab.id}
            onClick={() => onTabChange(tab.id)}
            className={`
              w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-200 group
              ${activeTab === tab.id 
                ? 'bg-gradient-to-r from-blue-600/10 to-purple-600/10 text-blue-400 border border-blue-500/20 shadow-inner' 
                : 'text-gray-400 hover:bg-white/5 hover:text-white border border-transparent'}
            `}
          >
            <i className={`fas ${tab.icon} w-5 text-center group-hover:scale-110 transition-transform`}></i>
            <span className="font-medium">{tab.label}</span>
          </button>
        ))}
      </nav>

      <div className="mt-auto space-y-4">
        <div className="p-4 glass rounded-2xl border-white/5 space-y-3">
          <div className="flex items-center justify-between text-xs">
            <span className="text-gray-500">API Usage</span>
            <span className="text-gray-400 font-medium">82%</span>
          </div>
          <div className="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
            <div className="bg-gradient-to-r from-blue-500 to-purple-500 h-full w-[82%]"></div>
          </div>
          <p className="text-[10px] text-gray-500">Upgrade to Enterprise for limitless tokens and dedicated support.</p>
        </div>

        <div className="flex items-center gap-3 px-2 py-3 border-t border-white/5">
          <img src="https://picsum.photos/seed/gemini/40/40" className="w-10 h-10 rounded-full border border-white/10" alt="User" />
          <div className="flex-1 min-w-0">
            <p className="text-sm font-semibold truncate">Senior Engineer</p>
            <p className="text-xs text-gray-500 truncate">Pro Account</p>
          </div>
          <button className="text-gray-500 hover:text-white">
            <i className="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </div>
  );
};

export default Sidebar;

</script>

<script type="module-shim" data-module="./components/ChatView.js">

import React, { useState, useRef, useEffect, useCallback } from 'react';
import { GoogleGenAI, GenerateContentResponse } from "@google/genai";
import { ChatMessage } from '../types';

const ChatView: React.FC = () => {
  const [messages, setMessages] = useState([]);
  const [inputValue, setInputValue] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [thinkingBudget, setThinkingBudget] = useState(0); // 0 = off
  const [useSearch, setUseSearch] = useState(false);
  const scrollRef = useRef(null);

  const scrollToBottom = () => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const handleSend = async () => {
    if (!inputValue.trim() || isTyping) return;

    const userMsg: ChatMessage = {
      id).toString(),
      role,
      text,
      timestamp),
    };

    setMessages(prev => [...prev, userMsg]);
    setInputValue('');
    setIsTyping(true);

    const modelMsgId = (Date.now() + 1).toString();
    const initialModelMsg: ChatMessage = {
      id,
      role,
      text,
      timestamp),
      isStreaming: true
    };
    
    setMessages(prev => [...prev, initialModelMsg]);

    try {
      const ai = new GoogleGenAI({ apiKey);
      const config: any = {
        thinkingConfig,
      };

      if (useSearch) {
        config.tools = [{ googleSearch: {} }];
      }

      const stream = await ai.models.generateContentStream({
        model,
        contents,
        config
      });

      let fullText = '';
      let groundingUrls: any[] = [];

      for await (const chunk of stream) {
        const c = chunk;
        if (c.text) {
          fullText += c.text;
          setMessages(prev => 
            prev.map(m => m.id === modelMsgId ? { ...m, text)
          );
        }
        
        // Extract grounding metadata and URLs if present
        const chunks = c.candidates?.[0]?.groundingMetadata?.groundingChunks;
        if (chunks) {
           const urls = chunks
            .filter((chunk) => chunk.web)
            .map((chunk) => ({
              uri,
              title));
           groundingUrls = [...groundingUrls, ...urls];
        }
      }

      // Finalize model message with grounding data
      setMessages(prev => 
        prev.map(m => m.id === modelMsgId ? { 
          ...m, 
          isStreaming, 
          groundingUrls)
      );

    } catch (error) {
      console.error('Chat error, error);
      setMessages(prev => 
        prev.map(m => m.id === modelMsgId ? { ...m, text, isStreaming)
      );
    } finally {
      setIsTyping(false);
    }
  };

  return (
    <div className="flex flex-col h-full bg-transparent">
      {/* Header Info */}
      <div className="flex items-center justify-between px-6 py-4 border-b border-white/5 glass">
        <div className="flex items-center gap-3">
          <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
          <div>
            <h2 className="text-sm font-bold">Gemini 3 Flash</h2>
            <p className="text-[10px] text-gray-500 uppercase tracking-tighter">Streaming Enabled â€¢ Ultra Low Latency</p>
          </div>
        </div>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-2 px-3 py-1.5 glass rounded-full border-white/5">
             <i className="fas fa-search text-xs text-gray-400"></i>
             <span className="text-xs text-gray-300">Search</span>
             <button 
                onClick={() => setUseSearch(!useSearch)}
                className={`w-8 h-4 rounded-full transition-colors relative ${useSearch ? 'bg-blue-600' : 'bg-gray-700'}`}
             >
                <div className={`absolute top-0.5 w-3 h-3 bg-white rounded-full transition-all ${useSearch ? 'left-4.5' : 'left-0.5'}`}></div>
             </button>
          </div>
          <div className="flex items-center gap-2 px-3 py-1.5 glass rounded-full border-white/5">
             <i className="fas fa-brain text-xs text-gray-400"></i>
             <span className="text-xs text-gray-300">Reasoning</span>
             <select 
                value={thinkingBudget} 
                onChange={(e) => setThinkingBudget(Number(e.target.value))}
                className="bg-transparent text-xs text-blue-400 focus:outline-none cursor-pointer"
             >
                <option value={0}>Off</option>
                <option value={1000}>Lite (1k)</option>
                <option value={8000}>Pro (8k)</option>
                <option value={24576}>Max (24k)</option>
             </select>
          </div>
        </div>
      </div>

      {/* Messages */}
      <div ref={scrollRef} className="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth">
        {messages.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-full text-center space-y-6 opacity-40">
             <div className="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center text-3xl">
                <i className="fas fa-ghost"></i>
             </div>
             <div>
                <h3 className="text-lg font-medium">Start a new conversation</h3>
                <p className="text-sm">Gemini is ready to help you with coding, creative writing, or complex reasoning.</p>
             </div>
          </div>
        )=> (
            <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
              <div className={`max-w-[85%] lg:max-w-[70%] space-y-2`}>
                <div className={`
                  px-5 py-3.5 rounded-2xl text-sm leading-relaxed
                  ${msg.role === 'user' 
                    ? 'bg-blue-600 text-white rounded-tr-none' 
                    : 'glass border-white/5 text-gray-200 rounded-tl-none'}
                `}>
                  {msg.text || (msg.isStreaming && <span className="animate-pulse">|</span>)}
                </div>
                {msg.groundingUrls && msg.groundingUrls.length > 0 && (
                  <div className="flex flex-wrap gap-2 pt-1">
                    {msg.groundingUrls.map((url, i) => (
                      <a 
                        key={i} 
                        href={url.uri} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="text-[10px] px-2 py-1 glass rounded-md border-white/5 text-blue-400 hover:text-blue-300 transition-colors"
                      >
                        <i className="fas fa-link mr-1"></i> {url.title || 'Source'}
                      </a>
                    ))}
                  </div>
                )}
                <p className="text-[10px] text-gray-500 px-1">
                  {new Date(msg.timestamp).toLocaleTimeString([], { hour, minute)}
                </p>
              </div>
            </div>
          ))
        )}
        {isTyping && messages[messages.length-1]?.role === 'user' && (
           <div className="flex justify-start">
             <div className="glass border-white/5 px-4 py-2 rounded-2xl rounded-tl-none flex gap-1">
                <div className="w-1.5 h-1.5 bg-gray-500 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                <div className="w-1.5 h-1.5 bg-gray-500 rounded-full animate-bounce" style={{ animationDelay: '200ms' }}></div>
                <div className="w-1.5 h-1.5 bg-gray-500 rounded-full animate-bounce" style={{ animationDelay)}
      </div>

      {/* Input */}
      <div className="p-6">
        <div className="relative glass rounded-2xl border-white/10 p-1 focus-within:border-blue-500/50 transition-all duration-300 shadow-2xl">
          <textarea
            rows={1}
            value={inputValue}
            onChange={(e) => {
              setInputValue(e.target.value);
              e.target.style.height = 'auto';
              e.target.style.height = `${e.target.scrollHeight}px`;
            }}
            onKeyDown={(e) => {
              if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
              }
            }}
            placeholder="Ask anything... (Shift+Enter for newline)"
            className="w-full bg-transparent border-none focus:ring-0 text-white placeholder-gray-500 p-4 max-h-48 resize-none text-sm"
          />
          <div className="flex items-center justify-between p-2 border-t border-white/5">
            <div className="flex gap-2">
               <button className="p-2 text-gray-400 hover:text-white transition-colors rounded-lg hover:bg-white/5"><i className="fas fa-paperclip"></i></button>
               <button className="p-2 text-gray-400 hover:text-white transition-colors rounded-lg hover:bg-white/5"><i className="fas fa-image"></i></button>
            </div>
            <button
              onClick={handleSend}
              disabled={!inputValue.trim() || isTyping}
              className={`
                px-4 py-2 rounded-xl flex items-center gap-2 transition-all duration-300
                ${!inputValue.trim() || isTyping ? 'bg-gray-800 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-500 shadow-lg shadow-blue-900/40'}
              `}
            >
              <span className="text-sm font-semibold">{isTyping ? 'Gemini is thinking...' : 'Send Message'}</span>
              <i className="fas fa-paper-plane text-xs"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ChatView;

</script>

<script type="module-shim" data-module="./components/StudioView.js">

import React, { useState, useEffect } from 'react';
import { GoogleGenAI } from "@google/genai";
import { GeneratedMedia } from '../types';

/* Removed conflicting declare global block to fix TS errors is already defined globally */

const StudioView: React.FC = () => {
  const [prompt, setPrompt] = useState('');
  const [mediaType, setMediaType] = useState('image');
  const [isGenerating, setIsGenerating] = useState(false);
  const [status, setStatus] = useState('');
  const [gallery, setGallery] = useState([]);
  const [hasSelectedKey, setHasSelectedKey] = useState(null);

  // Check for API key on mount and when media type changes
  useEffect(() => {
    const checkKey = async () => {
      // Use casting to access pre-configured aistudio to avoid interface conflict
      const aistudio = (window).aistudio;
      if (aistudio) {
        const has = await aistudio.hasSelectedApiKey();
        setHasSelectedKey(has);
      }
    };
    checkKey();
  }, [mediaType]);

  const handleOpenKeySelector = async () => {
    const aistudio = (window).aistudio;
    if (aistudio) {
      await aistudio.openSelectKey();
      // Assume success after triggering per instructions to avoid race conditions
      setHasSelectedKey(true);
    }
  };

  const handleGenerate = async () => {
    if (!prompt.trim() || isGenerating) return;

    setIsGenerating(true);
    setStatus('Initializing AI engines...');

    try {
      if (mediaType === 'image') {
        // Create instance right before call to use latest API key from environment
        const ai = new GoogleGenAI({ apiKey);
        setStatus('Visualizing your imagination...');
        const response = await ai.models.generateContent({
          model,
          contents,
          config);

        let imageUrl = '';
        for (const part of response.candidates?.[0]?.content?.parts || []) {
          if (part.inlineData) {
            imageUrl = `data,${part.inlineData.data}`;
            break;
          }
        }

        if (imageUrl) {
          const newMedia: GeneratedMedia = {
            id).toString(),
            type,
            url,
            prompt,
            timestamp)
          };
          setGallery(prev => [newMedia, ...prev]);
        }
      } else {
        // Video generation logic (Veo)
        setStatus('Verifying Video Studio Access...');
        const aistudio = (window).aistudio;
        const hasKey = aistudio ? await aistudio.hasSelectedApiKey(){
          await handleOpenKeySelector();
        }

        setStatus('Dreaming in 24 frames per second...');
        // Create instance right before call to use latest API key from dialog
        const ai = new GoogleGenAI({ apiKey);
        let operation = await ai.models.generateVideos({
          model,
          prompt,
          config,
            resolution,
            aspectRatio);

        while (!operation.done) {
          setStatus('Processing cinematic frames (this may take 1-2 mins)...');
          await new Promise(resolve => setTimeout(resolve, 10000));
          operation = await ai.operations.getVideosOperation({ operation);
        }

        const downloadLink = operation.response?.generatedVideos?.[0]?.video?.uri;
        if (downloadLink) {
           setStatus('Finalizing video file...');
           const res = await fetch(`${downloadLink}&key=${process.env.API_KEY}`);
           const blob = await res.blob();
           const videoUrl = URL.createObjectURL(blob);
           
           const newMedia: GeneratedMedia = {
             id).toString(),
             type,
             url,
             prompt,
             timestamp)
           };
           setGallery(prev => [newMedia, ...prev]);
        }
      }
    } catch (error) {
      console.error('Generation failed, error);
      if (error.message?.includes('Requested entity was not found')) {
        setStatus('Error);
        setHasSelectedKey(false);
        await handleOpenKeySelector();
      } else {
        setStatus(`Error);
      }
    } finally {
      setIsGenerating(false);
      setPrompt('');
    }
  };

  return (
    <div className="flex flex-col h-full overflow-hidden">
      {/* Creation Pane */}
      <div className="p-8 border-b border-white/5 glass bg-white/2">
        <div className="max-w-4xl mx-auto space-y-6">
          <div className="flex items-center justify-between">
            <h1 className="text-2xl font-bold gradient-text">Media Studio</h1>
            <div className="flex p-1 glass rounded-xl border-white/10">
              <button 
                onClick={() => setMediaType('image')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${mediaType === 'image' ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
              >
                <i className="fas fa-image mr-2"></i> Image
              </button>
              <button 
                onClick={() => setMediaType('video')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${mediaType === 'video' ? 'bg-purple-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
              >
                <i className="fas fa-video mr-2"></i> Video (Veo)
              </button>
            </div>
          </div>

          {/* Mandatory API Key selection for Video guidelines */}
          {mediaType === 'video' && hasSelectedKey === false && (
            <div className="p-4 glass rounded-2xl border border-yellow-500/30 bg-yellow-500/5 flex items-center justify-between animate-in fade-in slide-in-from-top-4 duration-500">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-500">
                  <i className="fas fa-key"></i>
                </div>
                <div>
                  <p className="text-sm font-bold text-yellow-200">Paid API Key Required</p>
                  <p className="text-xs text-yellow-500/80">Veo requires a billing-enabled project. Use the key selector to proceed.</p>
                </div>
              </div>
              <div className="flex items-center gap-4">
                <a 
                  href="https://ai.google.dev/gemini-api/docs/billing" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="text-xs text-gray-400 hover:text-white underline transition-colors"
                >
                  Billing Docs
                </a>
                <button 
                  onClick={handleOpenKeySelector}
                  className="px-6 py-2 bg-yellow-600 hover)}

          <div className="relative">
            <textarea
              value={prompt}
              onChange={(e) => setPrompt(e.target.value)}
              placeholder={`Describe your vision for the ${mediaType}... e.g. "A cyberpunk city in the rain with neon lights, cinematic lighting, 8k resolution"`}
              className="w-full h-32 glass border-white/10 rounded-2xl p-4 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500/50 resize-none transition-all shadow-xl"
            />
            <button
              onClick={handleGenerate}
              disabled={!prompt.trim() || isGenerating || (mediaType === 'video' && hasSelectedKey === false)}
              className={`
                absolute bottom-4 right-4 px-6 py-3 rounded-xl flex items-center gap-3 font-bold transition-all
                ${!prompt.trim() || isGenerating || (mediaType === 'video' && hasSelectedKey === false)
                  ? 'bg-gray-800 text-gray-500 cursor-not-allowed' 
                  : mediaType === 'image' 
                    ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/40' 
                    : 'bg-purple-600 hover:bg-purple-500 text-white shadow-lg shadow-purple-900/40'}
              `}
            >
              {isGenerating ? (
                <>
                  <i className="fas fa-circle-notch fa-spin"></i>
                  <span>Creating...</span>
                </>
              )="fas fa-magic"></i>
                  <span>Generate</span>
                </>
              )}
            </button>
          </div>
          
          {isGenerating && (
            <div className="flex items-center gap-3 text-sm text-gray-400 animate-pulse">
               <i className="fas fa-info-circle text-blue-400"></i>
               {status}
            </div>
          )}
        </div>
      </div>

      {/* Gallery */}
      <div className="flex-1 overflow-y-auto p-8 bg-black/40">
        <div className="max-w-6xl mx-auto space-y-8">
          <div className="flex items-center justify-between">
            <h3 className="text-xl font-semibold">Your Creations</h3>
            <span className="text-sm text-gray-500">{gallery.length} items</span>
          </div>

          {gallery.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-24 text-center glass rounded-3xl border-dashed border-white/10 opacity-30">
               <div className="text-6xl mb-6">ðŸŽ¨</div>
               <h4 className="text-xl font-medium">No masterpieces yet</h4>
               <p className="mt-2">Use the prompt box above to generate your first AI artwork.</p>
            </div>
          )="grid grid-cols-1 md) => (
                <div key={item.id} className="group relative glass rounded-2xl overflow-hidden border-white/5 shadow-xl hover:scale-[1.02] transition-transform duration-300">
                  <div className="aspect-video relative overflow-hidden bg-white/5">
                    {item.type === 'image' ? (
                      <img src={item.url} alt={item.prompt} className="w-full h-full object-cover" />
                    )={item.url} controls className="w-full h-full object-cover" />
                    )}
                    <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                       <p className="text-xs text-white line-clamp-2 italic mb-2">"{item.prompt}"</p>
                       <div className="flex gap-2">
                          <button onClick={() => window.open(item.url, '_blank')} className="flex-1 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-xs font-semibold backdrop-blur-md">View Full</button>
                          <a href={item.url} download={`gemini-${item.id}.png`} className="p-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-xs"><i className="fas fa-download"></i></a>
                       </div>
                    </div>
                  </div>
                  <div className="p-3 flex items-center justify-between">
                     <span className={`text-[10px] px-2 py-0.5 rounded-full ${item.type === 'image' ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400'}`}>
                        {item.type.toUpperCase()}
                     </span>
                     <span className="text-[10px] text-gray-500">{new Date(item.timestamp).toLocaleDateString()}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default StudioView;

</script>

<script type="module-shim" data-module="./components/LiveView.js">

import React, { useState, useRef, useEffect } from 'react';
import { GoogleGenAI, LiveServerMessage, Modality } from '@google/genai';

// Audio Helpers
function decode(base64) {
  const binaryString = atob(base64);
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  return bytes;
}

function encode(bytes) {
  let binary = '';
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

async function decodeAudioData(
  data,
  ctx,
  sampleRate,
  numChannels,
){
  const dataInt16 = new Int16Array(data.buffer);
  const frameCount = dataInt16.length / numChannels;
  const buffer = ctx.createBuffer(numChannels, frameCount, sampleRate);

  for (let channel = 0; channel < numChannels; channel++) {
    const channelData = buffer.getChannelData(channel);
    for (let i = 0; i < frameCount; i++) {
      channelData[i] = dataInt16[i * numChannels + channel] / 32768.0;
    }
  }
  return buffer;
}

const LiveView: React.FC = () => {
  const [isActive, setIsActive] = useState(false);
  const [transcription, setTranscription] = useState([]);
  const [currentPrompt, setCurrentPrompt] = useState('');
  const [isModelSpeaking, setIsModelSpeaking] = useState(false);
  
  const audioContextRef = useRef(null);
  const outputAudioContextRef = useRef(null);
  const sessionRef = useRef(null);
  const sourcesRef = useRef<Set<AudioBufferSourceNode>>(new Set());
  const nextStartTimeRef = useRef(0);
  const streamRef = useRef(null);

  const startSession = async () => {
    try {
      const ai = new GoogleGenAI({ apiKey);
      
      streamRef.current = await navigator.mediaDevices.getUserMedia({ audio);
      audioContextRef.current = new (window.AudioContext || (window).webkitAudioContext)({ sampleRate);
      outputAudioContextRef.current = new (window.AudioContext || (window).webkitAudioContext)({ sampleRate);
      
      const sessionPromise = ai.live.connect({
        model,
        callbacks) => {
            console.log('Session opened');
            setIsActive(true);
            
            // Setup microphone stream
            if (audioContextRef.current && streamRef.current) {
              const source = audioContextRef.current.createMediaStreamSource(streamRef.current);
              const scriptProcessor = audioContextRef.current.createScriptProcessor(4096, 1, 1);
              
              scriptProcessor.onaudioprocess = (e) => {
                const inputData = e.inputBuffer.getChannelData(0);
                const int16 = new Int16Array(inputData.length);
                for (let i = 0; i < inputData.length; i++) {
                  int16[i] = inputData[i] * 32768;
                }
                
                const pcmBlob = {
                  data)),
                  mimeType: 'audio/pcm;rate=16000',
                };
                
                sessionPromise.then(session => {
                  session.sendRealtimeInput({ media);
                });
              };
              
              source.connect(scriptProcessor);
              scriptProcessor.connect(audioContextRef.current.destination);
            }
          },
          onmessage) => {
            // Handle Transcription
            if (message.serverContent?.outputTranscription) {
              setTranscription(prev => [...prev, `Model);
            } else if (message.serverContent?.inputTranscription) {
               setTranscription(prev => [...prev, `You);
            }

            // Handle Audio
            const base64Audio = message.serverContent?.modelTurn?.parts[0]?.inlineData?.data;
            if (base64Audio && outputAudioContextRef.current) {
              setIsModelSpeaking(true);
              const ctx = outputAudioContextRef.current;
              nextStartTimeRef.current = Math.max(nextStartTimeRef.current, ctx.currentTime);
              
              const audioBuffer = await decodeAudioData(decode(base64Audio), ctx, 24000, 1);
              const source = ctx.createBufferSource();
              source.buffer = audioBuffer;
              source.connect(ctx.destination);
              source.addEventListener('ended', () => {
                sourcesRef.current.delete(source);
                if (sourcesRef.current.size === 0) setIsModelSpeaking(false);
              });
              
              source.start(nextStartTimeRef.current);
              nextStartTimeRef.current += audioBuffer.duration;
              sourcesRef.current.add(source);
            }

            if (message.serverContent?.interrupted) {
              sourcesRef.current.forEach(s => s.stop());
              sourcesRef.current.clear();
              nextStartTimeRef.current = 0;
              setIsModelSpeaking(false);
            }
          },
          onerror) => console.error('Live session error, e),
          onclose) => {
            setIsActive(false);
            console.log('Session closed');
          }
        },
        config,
          speechConfig,
          inputAudioTranscription,
          outputAudioTranscription,
          systemInstruction, real-time voice assistant. Keep responses conversational and concise.'
        }
      });
      
      sessionRef.current = await sessionPromise;

    } catch (err) {
      console.error('Failed to start session, err);
      setIsActive(false);
    }
  };

  const stopSession = () => {
    if (sessionRef.current) {
      sessionRef.current.close();
      sessionRef.current = null;
    }
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
    }
    setIsActive(false);
    setIsModelSpeaking(false);
    setTranscription([]);
  };

  useEffect(() => {
    return () => {
      stopSession();
    };
  }, []);

  return (
    <div className="h-full flex flex-col items-center justify-center bg-transparent p-8">
      <div className="max-w-3xl w-full flex flex-col items-center gap-12">
        
        {/* Visualizer Circle */}
        <div className="relative group">
           <div className={`
              absolute inset-0 bg-blue-500/20 rounded-full blur-3xl transition-all duration-1000
              ${isActive ? 'opacity-100 scale-125' : 'opacity-0 scale-75'}
              ${isModelSpeaking ? 'bg-purple-500/30 animate-pulse' : ''}
           `}></div>
           
           <div className={`
              w-64 h-64 rounded-full glass border-2 flex flex-col items-center justify-center relative z-10 transition-all duration-500
              ${isActive ? 'border-blue-500/50 scale-105 shadow-[0_0_50px_rgba(59,130,246,0.2)]' : 'border-white/10 grayscale'}
           `}>
              <div className="flex gap-1.5 mb-4">
                 {[...Array(8)].map((_, i) => (
                    <div 
                      key={i} 
                      className={`w-1.5 rounded-full transition-all duration-300 ${isActive ? 'bg-blue-400' : 'bg-gray-600'}`}
                      style={{ 
                        height) * 40}px` : '10px',
                        animation,
                        animationDelay))}
              </div>
              <p className={`text-sm font-bold tracking-widest uppercase transition-colors ${isActive ? 'text-blue-400' : 'text-gray-500'}`}>
                {isActive ? (isModelSpeaking ? 'Gemini Speaking' : 'Listening...'){`
              @keyframes wave {
                0%, 100% { transform); }
                50% { transform); }
              }
           `}</style>
        </div>

        {/* Info & Transcript */}
        <div className="text-center space-y-4 w-full">
           <h2 className="text-3xl font-bold gradient-text">Real-time Voice Conversation</h2>
           <p className="text-gray-400 max-w-md mx-auto text-sm">Experience ultra-low latency audio interactions. No typing, just natural human-like dialogue powered by Gemini Flash.</p>
           
           <div className="h-32 w-full glass rounded-2xl p-4 overflow-y-auto border-white/5 text-left flex flex-col-reverse gap-2 text-xs">
              {transcription.slice().reverse().map((t, i) => (
                 <div key={i} className={`p-2 rounded-lg ${t.startsWith('You') ? 'bg-blue-600/10 text-blue-300 ml-4' : 'bg-purple-600/10 text-purple-300 mr-4'}`}>
                    {t}
                 </div>
              ))}
              {transcription.length === 0 && <span className="text-gray-600 italic text-center w-full">Transcript will appear here...</span>}
           </div>
        </div>

        {/* Controls */}
        <div className="flex gap-6">
           {!isActive ? (
             <button 
              onClick={startSession}
              className="px-10 py-5 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white rounded-full font-bold shadow-2xl shadow-blue-900/40 flex items-center gap-4 group transition-all"
             >
                <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                   <i className="fas fa-play text-xs ml-1"></i>
                </div>
                <span>Initialize Voice Engine</span>
             </button>
           )={stopSession}
              className="px-10 py-5 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/20 rounded-full font-bold shadow-2xl flex items-center gap-4 group transition-all"
             >
                <div className="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                   <i className="fas fa-stop text-xs"></i>
                </div>
                <span>End Interaction</span>
             </button>
           )}
        </div>

        <div className="flex items-center gap-6 text-xs text-gray-500">
           <div className="flex items-center gap-2"><i className="fas fa-shield-alt text-green-500"></i> Encrypted Session</div>
           <div className="flex items-center gap-2"><i className="fas fa-bolt text-yellow-500"></i> &lt;200ms Latency</div>
           <div className="flex items-center gap-2"><i className="fas fa-volume-up text-blue-500"></i> Zephyr Voice</div>
        </div>
      </div>
    </div>
  );
};

export default LiveView;

</script>

<script type="module-shim" data-module="./components/ChatInterface.js">
import React, { useState, useRef, useEffect } from 'react';
import { Send, Image, Loader2, User, Bot, Trash2 } from 'lucide-react';
import { GoogleGenAI, GenerateContentResponse } from '@google/genai';
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { ChatMessage, TokenUsageData } from '../types';



const ChatInterface: React.FC<ChatInterfaceProps> = ({ apiKey }) => {
  const [messages, setMessages] = useState([]);
  const [inputText, setInputText] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [selectedImage, setSelectedImage] = useState(null);
  const messagesEndRef = useRef(null);
  const fileInputRef = useRef(null);
  const [usageData, setUsageData] = useState([]);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior);
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const handleImageUpload = (e) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setSelectedImage(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSendMessage = async () => {
    if ((!inputText.trim() && !selectedImage) || isLoading) return;

    const newUserMsg: ChatMessage = {
      id).toString(),
      role,
      text,
      image,
      timestamp),
    };

    setMessages((prev) => [...prev, newUserMsg]);
    setInputText('');
    setSelectedImage(null);
    setIsLoading(true);

    try {
      const ai = new GoogleGenAI({ apiKey });
      
      const parts: any[] = [];
      
      if (newUserMsg.image) {
        // Strip data, prefix
        const base64Data = newUserMsg.image.split(',')[1];
        const mimeType = newUserMsg.image.substring(
            newUserMsg.image.indexOf(":") + 1, 
            newUserMsg.image.indexOf(";")
        );
        parts.push({
          inlineData,
            mimeType);
      }
      
      if (newUserMsg.text) {
        parts.push({ text);
      }

      // Using standard generateContentStream for text/image
      const streamResult = await ai.models.generateContentStream({
        model,
        contents,
      });

      let fullResponseText = '';
      const responseId = (Date.now() + 1).toString();
      
      setMessages((prev) => [
        ...prev,
        {
          id,
          role,
          text,
          timestamp),
        },
      ]);

      for await (const chunk of streamResult) {
          const chunkText = chunk.text || '';
          fullResponseText += chunkText;
          
          setMessages((prev) => 
            prev.map((msg) => 
                msg.id === responseId ? { ...msg, text)
          );
      }

      // Update usage data (simulated count based on length for visualization purposes usage isn't always in stream chunk immediately)
      const tokenCountEstimate = fullResponseText.length / 4; 
      setUsageData(prev => {
        const newData = [...prev, {
            timestamp).toLocaleTimeString([], { hour, minute, second),
            tokens)
        }];
        return newData.slice(-20); // Keep last 20
      });

    } catch (error) {
      console.error('Error generating content, error);
      setMessages((prev) => [
        ...prev,
        {
          id).toString(),
          role,
          text, I encountered an error processing your request.",
          timestamp),
        },
      ]);
    } finally {
      setIsLoading(false);
    }
  };

  const handleClearChat = () => {
    setMessages([]);
    setUsageData([]);
  };

  return (
    <div className="flex flex-col h-full bg-slate-900">
      {/* Header / Stats */}
      <div className="flex-none p-4 border-b border-slate-700 bg-slate-800/50 backdrop-blur-sm">
        <div className="flex justify-between items-center mb-4">
            <h2 className="text-lg font-semibold text-slate-100 flex items-center gap-2">
                <Bot className="w-5 h-5 text-indigo-400" />
                Gemini 3 Flash
            </h2>
             <button
                onClick={handleClearChat}
                className="p-2 text-slate-400 hover:text-red-400 hover:bg-slate-700/50 rounded-lg transition-colors"
                title="Clear Chat"
            >
                <Trash2 className="w-4 h-4" />
            </button>
        </div>
        
        {/* Token Usage Chart */}
        <div className="h-32 w-full">
            <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={usageData}>
                    <defs>
                        <linearGradient id="colorTokens" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="5%" stopColor="#818cf8" stopOpacity={0.3}/>
                            <stop offset="95%" stopColor="#818cf8" stopOpacity={0}/>
                        </linearGradient>
                    </defs>
                    <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                    <XAxis dataKey="timestamp" hide />
                    <YAxis hide />
                    <Tooltip 
                        contentStyle={{ backgroundColor, border, borderRadius: '8px' }}
                        itemStyle={{ color: '#e2e8f0' }}
                    />
                    <Area type="monotone" dataKey="tokens" stroke="#818cf8" fillOpacity={1} fill="url(#colorTokens)" />
                </AreaChart>
            </ResponsiveContainer>
            {usageData.length === 0 && (
                <div className="absolute inset-0 flex items-center justify-center text-xs text-slate-500 pointer-events-none h-32">
                    Usage activity will appear here
                </div>
            )}
        </div>
      </div>

      {/* Messages Area */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-full text-slate-500 space-y-4">
            <Bot className="w-16 h-16 opacity-20" />
            <p className="text-center max-w-md">
              Start a conversation with Gemini. You can ask questions, brainstorm ideas, or upload images for analysis.
            </p>
          </div>
        )=> (
            <div
              key={msg.id}
              className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
            >
              <div
                className={`max-w-[80%] rounded-2xl p-4 ${
                  msg.role === 'user'
                    ? 'bg-indigo-600 text-white rounded-br-none'
                    : 'bg-slate-700 text-slate-200 rounded-bl-none'
                }`}
              >
                <div className="flex items-center gap-2 mb-2 opacity-70 text-xs">
                    {msg.role === 'user' ? <User className="w-3 h-3" /> : <Bot className="w-3 h-3" />}
                    <span>{msg.role === 'user' ? 'You' : 'Gemini'}</span>
                </div>
                {msg.image && (
                  <img
                    src={msg.image}
                    alt="Uploaded content"
                    className="max-w-full rounded-lg mb-2 max-h-60 object-cover"
                  />
                )}
                <div className="whitespace-pre-wrap leading-relaxed">
                  {msg.text}
                </div>
              </div>
            </div>
          ))
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* Input Area */}
      <div className="flex-none p-4 bg-slate-800 border-t border-slate-700">
        {selectedImage && (
            <div className="mb-2 relative inline-block">
                <img src={selectedImage} alt="Preview" className="h-20 rounded-lg border border-slate-600" />
                <button 
                    onClick={() => setSelectedImage(null)}
                    className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600"
                >
                    <Trash2 className="w-3 h-3" />
                </button>
            </div>
        )}
        <div className="flex gap-2">
          <button
            onClick={() => fileInputRef.current?.click()}
            className="p-3 text-slate-400 hover:text-indigo-400 hover:bg-slate-700 rounded-xl transition-colors"
            title="Upload Image"
          >
            <ImageIcon className="w-6 h-6" />
          </button>
          <input
            type="file"
            ref={fileInputRef}
            onChange={handleImageUpload}
            accept="image/*"
            className="hidden"
          />
          <input
            type="text"
            value={inputText}
            onChange={(e) => setInputText(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}
            placeholder="Type a message..."
            className="flex-1 bg-slate-900 text-white placeholder-slate-500 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-slate-700"
            disabled={isLoading}
          />
          <button
            onClick={handleSendMessage}
            disabled={isLoading || (!inputText.trim() && !selectedImage)}
            className={`p-3 rounded-xl transition-all ${
              isLoading || (!inputText.trim() && !selectedImage)
                ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                : 'bg-indigo-600 text-white hover:bg-indigo-500 shadow-lg shadow-indigo-500/20'
            }`}
          >
            {isLoading ? <Loader2 className="w-6 h-6 animate-spin" /> : <Send className="w-6 h-6" />}
          </button>
        </div>
      </div>
    </div>
  );
};

export default ChatInterface;
</script>

<script type="module-shim" data-module="./components/LiveInterface.js">
import React, { useState, useRef, useEffect, useCallback } from 'react';
import { GoogleGenAI, LiveServerMessage, Modality } from '@google/genai';
import { Mic, MicOff, Activity, AlertCircle, Volume2 } from 'lucide-react';
import { createPcmBlob, decodeAudioData, base64ToUint8Array } from '../services/audioUtils';
import { LiveConnectionState } from '../types';



const LiveInterface: React.FC<LiveInterfaceProps> = ({ apiKey }) => {
  const [connectionState, setConnectionState] = useState(LiveConnectionState.DISCONNECTED);
  const [errorMsg, setErrorMsg] = useState(null);
  const [volume, setVolume] = useState(0);

  // Audio Context Refs
  const inputAudioContextRef = useRef(null);
  const outputAudioContextRef = useRef(null);
  const mediaStreamRef = useRef(null);
  const workletNodeRef = useRef(null);
  
  // Connection Refs
  const sessionRef = useRef(null); // To store the session object
  const nextStartTimeRef = useRef(0);
  const sourcesRef = useRef<Set<AudioBufferSourceNode>>(new Set());

  // Visualizer Canvas
  const canvasRef = useRef(null);
  const animationRef = useRef(null);

  const drawVisualizer = useCallback(() => {
    if (!canvasRef.current) return;
    const ctx = canvasRef.current.getContext('2d');
    if (!ctx) return;

    const width = canvasRef.current.width;
    const height = canvasRef.current.height;

    // Clear with fade effect
    ctx.fillStyle = 'rgba(15, 23, 42, 0.2)'; // Slate 900 fade
    ctx.fillRect(0, 0, width, height);

    if (connectionState === LiveConnectionState.CONNECTED) {
        // Draw wave
        ctx.beginPath();
        const amplitude = Math.max(volume * height * 0.4, 2);
        const frequency = 0.1;
        const time = Date.now() / 100;
        
        ctx.moveTo(0, height / 2);
        
        for (let x = 0; x < width; x++) {
            const y = height / 2 + Math.sin(x * frequency + time) * amplitude * Math.sin(x / width * Math.PI);
            ctx.lineTo(x, y);
        }

        ctx.strokeStyle = '#818cf8'; // Indigo 400
        ctx.lineWidth = 3;
        ctx.stroke();

        // Mirrored wave
        ctx.beginPath();
        ctx.moveTo(0, height / 2);
         for (let x = 0; x < width; x++) {
            const y = height / 2 - Math.sin(x * frequency + time) * amplitude * Math.sin(x / width * Math.PI);
            ctx.lineTo(x, y);
        }
        ctx.strokeStyle = '#c084fc'; // Purple 400
        ctx.lineWidth = 2;
        ctx.stroke();
    } else {
        // Flat line
        ctx.beginPath();
        ctx.moveTo(0, height/2);
        ctx.lineTo(width, height/2);
        ctx.strokeStyle = '#334155';
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    animationRef.current = requestAnimationFrame(drawVisualizer);
  }, [connectionState, volume]);

  useEffect(() => {
    drawVisualizer();
    return () => {
        if (animationRef.current) cancelAnimationFrame(animationRef.current);
    };
  }, [drawVisualizer]);


  const startSession = async () => {
    setErrorMsg(null);
    setConnectionState(LiveConnectionState.CONNECTING);

    try {
      // 1. Setup AudioContexts
      inputAudioContextRef.current = new (window.AudioContext || (window).webkitAudioContext)({ sampleRate);
      outputAudioContextRef.current = new (window.AudioContext || (window).webkitAudioContext)({ sampleRate);

      // 2. Get Microphone Stream
      const stream = await navigator.mediaDevices.getUserMedia({ audio);
      mediaStreamRef.current = stream;

      // 3. Initialize Gemini Client
      const ai = new GoogleGenAI({ apiKey });
      
      // Connect to Gemini Live
      const sessionPromise = ai.live.connect({
        model,
        config,
          speechConfig,
          },
          systemInstruction, witty, and concise AI assistant.",
        },
        callbacks) => {
            console.log("Live Session Opened");
            setConnectionState(LiveConnectionState.CONNECTED);
            
            // Start processing microphone input
            const source = inputAudioContextRef.current!.createMediaStreamSource(stream);
            const scriptProcessor = inputAudioContextRef.current!.createScriptProcessor(4096, 1, 1);
            workletNodeRef.current = scriptProcessor;

            scriptProcessor.onaudioprocess = (audioProcessingEvent) => {
              const inputData = audioProcessingEvent.inputBuffer.getChannelData(0);
              
              // Calculate volume for visualizer
              let sum = 0;
              for (let i = 0; i < inputData.length; i++) {
                sum += inputData[i] * inputData[i];
              }
              setVolume(Math.sqrt(sum / inputData.length));

              const pcmBlob = createPcmBlob(inputData);
              sessionPromise.then((session) => {
                 session.sendRealtimeInput({ media);
              });
            };

            source.connect(scriptProcessor);
            scriptProcessor.connect(inputAudioContextRef.current!.destination);
          },
          onmessage) => {
            // Handle Audio Output
            const base64Audio = message.serverContent?.modelTurn?.parts?.[0]?.inlineData?.data;
            if (base64Audio) {
              const ctx = outputAudioContextRef.current!;
              // Reset nextStartTime if it's behind current time (drift correction)
              nextStartTimeRef.current = Math.max(nextStartTimeRef.current, ctx.currentTime);
              
              const audioBuffer = await decodeAudioData(
                base64ToUint8Array(base64Audio),
                ctx,
                24000,
                1
              );
              
              const source = ctx.createBufferSource();
              source.buffer = audioBuffer;
              source.connect(ctx.destination);
              source.addEventListener('ended', () => {
                 sourcesRef.current.delete(source);
              });
              
              source.start(nextStartTimeRef.current);
              nextStartTimeRef.current += audioBuffer.duration;
              sourcesRef.current.add(source);
            }

            // Handle Interruption
            if (message.serverContent?.interrupted) {
                console.log("Interrupted");
                sourcesRef.current.forEach(src => src.stop());
                sourcesRef.current.clear();
                nextStartTimeRef.current = 0;
            }
          },
          onclose) => {
            console.log("Session Closed");
            setConnectionState(LiveConnectionState.DISCONNECTED);
            setVolume(0);
          },
          onerror) => {
            console.error("Session Error", err);
            setConnectionState(LiveConnectionState.ERROR);
            setErrorMsg("Connection error occurred.");
            setVolume(0);
          }
        }
      });
      
      // Await the session to ensure we store it for closing later (though the API is promise based)
      sessionRef.current = await sessionPromise;

    } catch (e) {
      console.error(e);
      setConnectionState(LiveConnectionState.ERROR);
      setErrorMsg(e.message || "Failed to initialize audio session.");
    }
  };

  const stopSession = async () => {
    // 1. Stop Microphone
    if (mediaStreamRef.current) {
        mediaStreamRef.current.getTracks().forEach(track => track.stop());
        mediaStreamRef.current = null;
    }

    // 2. Disconnect Script Processor
    if (workletNodeRef.current && inputAudioContextRef.current) {
        workletNodeRef.current.disconnect();
        workletNodeRef.current = null;
    }

    // 3. Close Audio Contexts
    if (inputAudioContextRef.current) {
        await inputAudioContextRef.current.close();
        inputAudioContextRef.current = null;
    }
    if (outputAudioContextRef.current) {
        await outputAudioContextRef.current.close();
        outputAudioContextRef.current = null;
    }

    // 4. Close Gemini Session
    // Since sessionRef is the object returned by connect, assume it has a close method if specified in SDK
    // The prompt says, use `session.close()`"
    if (sessionRef.current) {
        sessionRef.current.close();
        sessionRef.current = null;
    }

    setConnectionState(LiveConnectionState.DISCONNECTED);
    setVolume(0);
    sourcesRef.current.clear();
  };

  return (
    <div className="flex flex-col items-center justify-center h-full bg-slate-900 p-8 relative overflow-hidden">
      
      {/* Background Pulse Effect */}
      {connectionState === LiveConnectionState.CONNECTED && (
        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div className="w-96 h-96 bg-indigo-500/10 rounded-full blur-3xl animate-pulse"></div>
        </div>
      )}

      {/* Visualizer */}
      <div className="relative z-10 w-full max-w-2xl h-64 bg-slate-800/50 backdrop-blur-md rounded-3xl border border-slate-700 shadow-2xl overflow-hidden mb-8">
        <canvas ref={canvasRef} width={800} height={300} className="w-full h-full" />
        <div className="absolute top-4 left-4 flex items-center gap-2">
            <div className={`w-3 h-3 rounded-full ${
                connectionState === LiveConnectionState.CONNECTED ? 'bg-green-500 animate-pulse' : 
                connectionState === LiveConnectionState.CONNECTING ? 'bg-yellow-500 animate-bounce' : 
                connectionState === LiveConnectionState.ERROR ? 'bg-red-500' : 'bg-slate-500'
            }`}></div>
            <span className="text-xs font-mono text-slate-400 uppercase tracking-wider">{connectionState}</span>
        </div>
      </div>

      {/* Controls */}
      <div className="relative z-10 flex flex-col items-center gap-6">
        <div className="text-slate-300 text-center space-y-2">
            <h2 className="text-2xl font-bold">Gemini Live</h2>
            <p className="text-slate-400 max-w-md">
                Experience real-time, low-latency voice conversations with Gemini 2.5 Flash.
            </p>
        </div>

        {errorMsg && (
            <div className="flex items-center gap-2 text-red-400 bg-red-900/20 px-4 py-2 rounded-lg border border-red-900/50">
                <AlertCircle className="w-4 h-4" />
                <span className="text-sm">{errorMsg}</span>
            </div>
        )}

        <button
            onClick={connectionState === LiveConnectionState.CONNECTED ? stopSession : startSession}
            disabled={connectionState === LiveConnectionState.CONNECTING}
            className={`group relative flex items-center justify-center w-20 h-20 rounded-full transition-all duration-300 ${
                connectionState === LiveConnectionState.CONNECTED
                    ? 'bg-red-500 hover,68,68,0.5)]'
                    : 'bg-indigo-600 hover,102,241,0.5)]'
            } ${connectionState === LiveConnectionState.CONNECTING ? 'opacity-70 scale-95 cursor-wait' : 'scale-100'}`}
        >
            {connectionState === LiveConnectionState.CONNECTED ? (
                <MicOff className="w-8 h-8 text-white" />
            )="w-8 h-8 text-white group-hover)}
            
            {/* Ripple rings */}
            {connectionState === LiveConnectionState.CONNECTED && (
                 <>
                    <span className="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-20 animate-ping"></span>
                    <span className="absolute inline-flex h-[120%] w-[120%] rounded-full bg-red-400 opacity-10 animate-ping animation-delay-200"></span>
                 </>
            )}
        </button>

        <div className="flex items-center gap-2 text-slate-500 text-sm">
            {connectionState === LiveConnectionState.CONNECTED ? (
                <div className="flex items-center gap-2">
                    <Activity className="w-4 h-4 animate-pulse text-green-400" />
                    <span>Listening...</span>
                </div>
            )="flex items-center gap-2">
                    <Volume2 className="w-4 h-4" />
                    <span>Ready to connect</span>
                </div>
            )}
        </div>
      </div>
    </div>
  );
};

export default LiveInterface;
</script>

<script type="module-shim" data-module="./components/CardVisual.js">
import React from 'react';
import { RankID } from '../types';



const CardVisual: React.FC<CardVisualProps> = ({ rankId, size = 'md', className = '' }) => {
  const sizeClasses = {
    sm, // Reduced text size for sm
    md,
    lg,
  };

  const suit = 'â™ '; 
  const value = rankId.replace('â™ ', '');
  const isFaceCard = ['J', 'Q', 'K', 'A'].includes(value);
  const isAce = value === 'A';

  return (
    <div className={`
      relative bg-[#080808] shadow-2xl 
      flex flex-col items-center justify-center font-display font-bold select-none
      border border-white/10 overflow-hidden text-neutral-200
      transition-all duration-500 group-hover,177,91,0.1)] border-brand-gold/20' : ''}
      ${isAce ? 'shadow-[0_0_50px_rgba(217,35,35,0.25)] border-brand-red/40' : ''}
    `}>
        {/* Metallic Texture */}
        <div className="absolute inset-0 opacity-20 bg-[url('https)] mix-blend-overlay"></div>
        
        {/* Holographic Sheen on Hover */}
        <div className="absolute inset-0 bg-gradient-to-tr from-transparent via-white/5 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000 ease-in-out pointer-events-none z-20"></div>

        {/* Inner Border/Frame */}
        <div className="absolute inset-0.5 border border-white/5 rounded-[inherit] pointer-events-none"></div>

        {/* Corner Top Left */}
        <div className="absolute top-1 left-1.5 leading-none flex flex-col items-center">
            <span className={`${isAce ? 'text-brand-red' : isFaceCard ? 'text-brand-gold' : 'text-neutral-300'} font-display tracking-tight`}>{value}</span>
            <span className="text-[0.5em] text-neutral-600">{suit}</span>
        </div>

        {/* Center Symbol */}
        <div className={`relative z-10 transform group-hover,35,35,0.6)] text-2xl md,177,91,0.4)]' : 'text-neutral-800'}
        `}>
           <span className={size === 'sm' && isAce ? 'text-xl' : ''}>{suit}</span> 
        </div>

        {/* Large Watermark */}
        {size === 'lg' && (
            <div className={`absolute inset-0 flex items-center justify-center opacity-5 font-black text-9xl pointer-events-none 
                ${isAce ? 'text-brand-red' : 'text-white'}`}>
                {value}
            </div>
        )}

        {/* Corner Bottom Right */}
        <div className="absolute bottom-1 right-1.5 leading-none flex flex-col items-center rotate-180">
            <span className={`${isAce ? 'text-brand-red' : isFaceCard ? 'text-brand-gold' : 'text-neutral-300'} font-display tracking-tight`}>{value}</span>
            <span className="text-[0.5em] text-neutral-600">{suit}</span>
        </div>

        {/* Ace Active Glow Animation */}
        {isAce && (
             <>
                <div className="absolute inset-0 bg-gradient-to-t from-brand-red/10 to-transparent opacity-50"></div>
                <div className="absolute bottom-0 left-0 right-0 h-2/3 bg-gradient-to-t from-brand-red/20 to-transparent blur-xl opacity-30 animate-pulse-slow"></div>
             </>
        )}
        
        {/* Face Card Gold Glow */}
        {!isAce && isFaceCard && (
             <div className="absolute inset-0 bg-gradient-to-tr from-brand-gold/5 via-transparent to-brand-gold/5 pointer-events-none"></div>
        )}
    </div>
  );
};

export default CardVisual;
</script>

<script type="module-shim" data-module="./components/Nav.js">

import React from 'react';
import { User } from '../types';
import CardVisual from './CardVisual';



const Nav: React.FC<NavProps> = ({ user, activeTab, onTabChange, onLogout }) => {
  const tabs = [
    { id, label, icon,
    // Guide moved here, styled specifically
    { id, label, icon,
    { id, label, icon,
    { id, label, icon,
    { id, label, icon,
    { id, label, icon,
    { id, label, icon,
    { id, label, icon,
  ];

  if (user.isAdmin) {
      tabs.push({ id, label, icon);
  }

  return (
    <>
      <aside className="hidden md:flex flex-col w-72 h-screen fixed left-0 top-0 glass-panel border-r border-white/5 z-50">
        <div className="p-8 border-b border-white/5 relative overflow-hidden group">
          <div className="absolute top-0 left-0 w-1 h-full bg-brand-red shadow-[0_0_10px_#dc2626]"></div>
          <div className="absolute inset-0 bg-brand-red/5 opacity-0 group-hover:opacity-100 transition-opacity duration-1000"></div>
          <h1 className="text-3xl font-display font-black text-white tracking-widest leading-none">SPADES</h1>
          <p className="text-[10px] text-brand-red mt-2 uppercase tracking-[0.3em] font-bold">Presidential System</p>
        </div>

        <div className="flex-1 overflow-y-auto py-8 space-y-2 px-4">
          {tabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => onTabChange(tab.id)}
              className={`group w-full flex items-center gap-4 px-4 py-4 rounded-xl transition-all duration-300 relative overflow-hidden ${
                activeTab === tab.id 
                  ? 'bg-gradient-to-r from-brand-red/20 to-transparent text-white border border-brand-red/10 shadow-[0_0_15px_rgba(220,38,38,0.1)]' 
                  : 'text-neutral-500 hover:bg-white/5 hover:text-white border border-transparent'
              }`}
            >
              <div className={`absolute left-0 top-0 bottom-0 w-0.5 transition-all duration-300 ${activeTab === tab.id ? 'bg-brand-red opacity-100' : 'bg-brand-red opacity-0 group-hover:opacity-50'}`}></div>
              <svg className={`w-5 h-5 transition-transform duration-300 ${activeTab === tab.id ? 'scale-110 text-brand-red' : 'group-hover:scale-110'} ${tab.id === 'guide' ? 'text-brand-gold' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
                 <path strokeLinecap="round" strokeLinejoin="round" d={tab.icon} />
              </svg>
              <span className={`font-display font-medium tracking-wide text-sm ${tab.id === 'guide' ? 'text-brand-gold font-bold' : ''}`}>{tab.label}</span>
            </button>
          ))}
        </div>

        <div className="p-4 mx-4 mb-4 rounded-xl bg-black/40 border border-white/10 relative overflow-hidden group hover:border-brand-gold/30 transition-colors duration-500">
          <div className="absolute inset-0 bg-gradient-to-t from-brand-gold/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>
          
          <div className="flex gap-4 items-center mb-3">
             <div className="shrink-0 transform group-hover:scale-105 transition-transform duration-500">
                <CardVisual rankId={user.currentCard} size="sm" />
             </div>
             <div className="min-w-0 flex-1">
                 <p className="text-sm font-bold text-white truncate font-display tracking-wide">{user.username}</p>
                 <div className="flex items-center gap-2 mt-1">
                     <div className="h-1.5 w-1.5 rounded-full bg-brand-red animate-pulse"></div>
                     <p className="text-[10px] text-neutral-400 font-mono truncate">{user.totalPoints.toLocaleString()} PTS</p>
                 </div>
             </div>
          </div>
          
          <button 
            type="button"
            onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                onLogout();
            }}
            className="w-full py-2.5 rounded-lg bg-neutral-900 border border-white/5 hover:bg-red-950/20 hover:text-red-400 hover:border-red-900/30 text-[10px] text-neutral-500 font-bold uppercase tracking-widest transition-all relative z-10"
          >
            Terminate Session
          </button>
        </div>
      </aside>

      <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-black/95 backdrop-blur-xl border-t border-white/10 z-50 pb-safe">
        <div className="flex justify-around items-center h-20 px-2 overflow-x-auto">
          {tabs.map(tab => (
             <button
                key={tab.id}
                onClick={() => onTabChange(tab.id)}
                className={`flex flex-col items-center justify-center min-w-[60px] h-full space-y-1.5 transition-all duration-300 ${activeTab === tab.id ? 'text-brand-red' : 'text-neutral-600'}`}
             >
                <div className={`p-1.5 rounded-full ${activeTab === tab.id ? 'bg-brand-red/10' : ''}`}>
                    <svg className={`w-5 h-5 ${tab.id === 'guide' ? 'text-brand-gold' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" d={tab.icon} />
                    </svg>
                </div>
                <span className="text-[9px] uppercase font-bold tracking-wider">{tab.id === 'guide' ? 'GUIDE' : tab.label.split(' ')[0]}</span>
             </button>
          ))}
        </div>
      </nav>
    </>
  );
};

export default Nav;

</script>

<script type="module-shim" data-module="./components/Feed.js">

import React, { useState, useEffect } from 'react';
import { Post, User, Comment, RankID, SystemSettings } from '../types';
import { storage } from '../services/storageService';
import { checkContentSafety, sanitizeContent } from '../services/geminiService';
import { POINT_VALUES, RANKS } from '../constants';
import CardVisual from './CardVisual';



const Feed: React.FC<FeedProps> = ({ currentUser, refreshTrigger, onActivity }) => {
  const [posts, setPosts] = useState([]);
  const [settings, setSettings] = useState(null);
  const [allUsers, setAllUsers] = useState<Record<string, User>>({});
  const [newPostContent, setNewPostContent] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isPollMode, setIsPollMode] = useState(false);
  const [pollOptions, setPollOptions] = useState(['', '']);
  
  const [feedMode, setFeedMode] = useState('public');
  const [expandedTickets, setExpandedTickets] = useState([]);
  const [ticketReply, setTicketReply] = useState<Record<string, string>>({});

  useEffect(() => {
    loadData();
  }, [refreshTrigger, feedMode]);

  const loadData = async () => {
    const [allPosts, s, usersList] = await Promise.all([
        storage.getPosts(), 
        storage.getSettings(),
        storage.getAllUsers()
    ]);
    
    // Create user map for live resolution of name/rank
    const userMap, User> = {};
    usersList.forEach(u => userMap[u.studentId] = u);
    setAllUsers(userMap);

    let filteredPosts: Post[] = [];

    if (feedMode === 'public') {
        filteredPosts = allPosts.filter(p => (p.category === 'general' || p.category === 'poll' || p.category === 'announcement'));
    } else {
        if (isCouncilMember(currentUser)) {
            filteredPosts = allPosts.filter(p => p.category === 'ticket');
        } else {
            filteredPosts = allPosts.filter(p => p.category === 'ticket' && p.authorId === currentUser.studentId);
        }
    }
    setPosts(filteredPosts);
    setSettings(s);
  };

  const rankOrder: RankID[] = ['2â™ ', '3â™ ', '4â™ ', '5â™ ', '6â™ ', '7â™ ', '8â™ ', '9â™ ', '10â™ ', 'Jâ™ ', 'Qâ™ ', 'Kâ™ ', 'Aâ™ '];
  const userRankIdx = rankOrder.indexOf(currentUser.currentCard);
  const minRankIdx = settings ? rankOrder.indexOf(settings.minRankToPost)= (u) => {
      const idx = rankOrder.indexOf(u.currentCard);
      return idx >= 9 || u.isAdmin; 
  };

  const canPost = (userRankIdx >= minRankIdx || currentUser.isAdmin) && feedMode === 'public';
  const canSendTicket = feedMode === 'council'; 

  const handleCreatePost = async () => {
    if (!newPostContent.trim()) return;
    setIsSubmitting(true);
    
    // First sanitize (hashtags) then check extreme safety
    const sanitizedText = await sanitizeContent(newPostContent);
    const safetyCheck = await checkContentSafety(sanitizedText);
    const category = feedMode === 'council' ? 'ticket' : (isPollMode ? 'poll' : 'general');
    
    const newPost: Post = {
      id)}`,
      authorId,
      authorName,
      authorRank,
      content,
      category,
      status,
      upvotes,
      downvotes,
      comments,
      pollOptions: isPollMode ? pollOptions.map(text => ({ text, votes)){ ...currentUser, totalPoints);
    
    setNewPostContent('');
    setIsSubmitting(false);
    loadData();
    onActivity();
  };

  const handleReplyToTicket = async (postId) => {
      const content = ticketReply[postId];
      if (!content?.trim()) return;

      const post = posts.find(p => p.id === postId);
      if (!post) return;

      const sanitizedComment = await sanitizeContent(content);

      const newComment: Comment = {
          id)}`,
          authorId,
          authorName,
          content,
          createdAt).toISOString()
      };

      const updatedPost = {
          ...post,
          comments), newComment]
      };
      await storage.savePost(updatedPost);
      setTicketReply({...ticketReply, [postId]: ''});
      loadData();
  };

  const handlePurgePost = async (e, postId) => {
      e.stopPropagation();
      e.preventDefault();
      setPosts(prev => prev.filter(p => p.id !== postId));
      await storage.deletePost(postId);
      onActivity();
  };

  const handleDeleteComment = async (e, postId, commentId) => {
      e.stopPropagation();
      e.preventDefault();
      setPosts(prevPosts => prevPosts.map(p => {
          if (p.id === postId) {
              return { ...p, comments: p.comments.filter(c => c.id !== commentId) };
          }
          return p;
      }));
      await storage.deleteComment(postId, commentId);
  };

  const toggleTicket = (id) => {
      if (expandedTickets.includes(id)) setExpandedTickets(prev => prev.filter(i => i !== id));
      else setExpandedTickets(prev => [...prev, id]);
  };

  return (
    <div className="max-w-3xl mx-auto space-y-8 pb-32 animate-in fade-in duration-500">
      
      <div className="flex bg-black border border-white/10 rounded-xl p-1 relative z-10">
          <button 
            onClick={() => setFeedMode('public')}
            className={`flex-1 py-3 text-xs font-bold uppercase tracking-widest rounded-lg transition-all ${feedMode === 'public' ? 'bg-white text-black shadow-lg' : 'text-neutral-500 hover:text-white'}`}
          >
              Public Broadcast
          </button>
          <button 
            onClick={() => setFeedMode('council')}
            className={`flex-1 py-3 text-xs font-bold uppercase tracking-widest rounded-lg transition-all flex items-center justify-center gap-2 ${feedMode === 'council' ? 'bg-emerald-900/50 text-emerald-400 border border-emerald-500/50 shadow-[0_0_20px_rgba(16,185,129,0.2)]' : 'text-neutral-500 hover:text-emerald-500'}`}
          >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
              Council Uplink
          </button>
      </div>

      <div className="flex justify-between items-center px-2">
         <h2 className={`text-xl font-display font-bold ${feedMode === 'council' ? 'text-emerald-500' : 'text-white'}`}>
            {feedMode === 'public' ? 'Global Network' : 'Secure Channel'}
         </h2>
         <div className="text-[10px] font-mono text-neutral-500 uppercase tracking-widest">
             Frequency: {feedMode === 'public' ? 'Open' : 'Encrypted'}
         </div>
      </div>

      {(canPost || canSendTicket) && (
          <div className={`glass-panel rounded-2xl border p-6 shadow-2xl relative overflow-hidden ${feedMode === 'council' ? 'border-emerald-500/20' : 'border-white/5'}`}>
            <div className={`absolute top-0 left-0 w-1 h-full bg-gradient-to-b ${feedMode === 'council' ? 'from-emerald-500 to-transparent' : 'from-brand-red to-transparent'}`}></div>
            <div className="flex gap-6">
                <div className="flex-1">
                    <textarea 
                        value={newPostContent} 
                        onChange={(e) => setNewPostContent(e.target.value)} 
                        placeholder={feedMode === 'council' ? "Send secure message to the High Table..." : "Share intelligence..."}
                        className="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-sm text-white outline-none h-24 resize-none focus:border-white/20" 
                    />
                    <div className="flex justify-between items-center mt-4">
                        {feedMode === 'public' ? (
                             <button onClick={() => setIsPollMode(!isPollMode)} className="text-[10px] text-neutral-500 font-bold uppercase tracking-widest hover)="text-[10px] text-emerald-600 font-mono flex items-center gap-2">
                                 <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                                 ENCRYPTED
                             </div>
                        )}
                        <button 
                            onClick={handleCreatePost} 
                            disabled={isSubmitting} 
                            className={`px-6 py-2 text-white text-xs font-bold uppercase rounded-lg shadow-lg ${
                                feedMode === 'council' 
                                ? 'bg-emerald-700 hover:bg-emerald-600' 
                                : 'bg-brand-red hover:bg-brand-red/80'
                            }`}
                        >
                            {isSubmitting ? '...' : (feedMode === 'council' ? 'Transmit' : 'Post')}
                        </button>
                    </div>
                </div>
            </div>
          </div>
      )}

      <div className="space-y-6">
        {posts.map(post => {
            const isAuthor = post.authorId === currentUser.studentId;
            const canDeletePost = currentUser.isAdmin || isAuthor;
            
            // Resolve current display name and rank from allUsers map
            const authorData = allUsers[post.authorId];
            const currentName = authorData?.username || post.authorName;
            const currentRank = authorData?.currentCard || post.authorRank;

            return (
            <div 
                key={post.id} 
                className={`glass-panel border rounded-2xl p-6 relative group ${
                    post.category === 'ticket' ? 'border-emerald-500/20 bg-emerald-950/10' : 'border-white/5'
                }`}
            >
                {canDeletePost && (
                    <button 
                        onClick={(e) => handlePurgePost(e, post.id)} 
                        className="absolute top-4 right-4 z-50 p-2 bg-black hover:bg-red-500 text-neutral-500 hover:text-white rounded-lg transition-all border border-white/10 hover:border-red-500 shadow-xl cursor-pointer"
                        title="Purge Post"
                    >
                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                )}
                
                <div className="flex items-center gap-4 mb-4">
                    <CardVisual rankId={currentRank} size="sm" />
                    <div>
                        <div className={`font-bold text-sm ${post.category === 'ticket' ? 'text-emerald-400' : 'text-white'}`}>
                            {currentName}
                            {post.category === 'ticket' && <span className="ml-2 text-[10px] bg-emerald-500/20 px-1.5 py-0.5 rounded border border-emerald-500/30">TICKET</span>}
                        </div>
                        <div className="text-[10px] text-neutral-600 font-mono">{new Date(post.createdAt).toLocaleDateString()}</div>
                    </div>
                </div>
                
                <p className="text-neutral-300 text-sm font-light leading-relaxed whitespace-pre-wrap">{post.content}</p>

                {post.category === 'ticket' && (
                    <div className="mt-6 border-t border-emerald-500/20 pt-4">
                        <button 
                            onClick={() => toggleTicket(post.id)}
                            className="text-[10px] font-bold uppercase tracking-widest text-emerald-600 hover) ? 'Hide Responses' : `View Responses (${post.comments?.length || 0})`}
                        </button>

                        {expandedTickets.includes(post.id) && (
                            <div className="mt-4 space-y-4 animate-in fade-in slide-in-from-top-2">
                                <div className="space-y-3 max-h-40 overflow-y-auto custom-scrollbar">
                                    {post.comments?.map(c => {
                                        const canDeleteComment = currentUser.isAdmin || c.authorId === currentUser.studentId;
                                        const commentAuthorData = allUsers[c.authorId];
                                        const currentCommenterName = commentAuthorData?.username || c.authorName;

                                        return (
                                            <div key={c.id} className="bg-emerald-900/20 border border-emerald-500/10 p-3 rounded-lg relative group/comment hover:bg-emerald-900/30 transition-colors">
                                                {canDeleteComment && (
                                                    <button 
                                                        onClick={(e) => handleDeleteComment(e, post.id, c.id)}
                                                        className="absolute top-2 right-2 bg-black text-neutral-500 hover:text-red-500 p-1.5 rounded transition-colors z-50 cursor-pointer border border-white/5"
                                                        title="Delete Comment"
                                                    >
                                                        <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                                    </button>
                                                )}
                                                
                                                <div className="flex justify-between items-baseline mb-1 mr-8">
                                                    <span className="text-emerald-400 text-xs font-bold">{currentCommenterName}</span>
                                                    <span className="text-[9px] text-emerald-700/70">{new Date(c.createdAt).toLocaleTimeString()}</span>
                                                </div>
                                                <p className="text-neutral-300 text-xs pr-2">{c.content}</p>
                                            </div>
                                        );
                                    })}
                                    {(!post.comments || post.comments.length === 0) && <div className="text-neutral-600 text-xs italic">Awaiting Council Response...</div>}
                                </div>
                                
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={ticketReply[post.id] || ''}
                                        onChange={e => setTicketReply({...ticketReply, [post.id]: e.target.value})}
                                        placeholder="Add response..."
                                        className="flex-1 bg-black/40 border border-emerald-500/30 rounded px-3 py-2 text-xs text-white outline-none focus:border-emerald-500"
                                    />
                                    <button 
                                        onClick={() => handleReplyToTicket(post.id)}
                                        className="px-4 py-2 bg-emerald-800 text-emerald-100 text-[10px] font-bold uppercase rounded hover)}
                    </div>
                )}
            </div>
            );
        })}
        
        {posts.length === 0 && (
            <div className="text-center py-20 text-neutral-600 font-mono text-sm border-2 border-dashed border-white/5 rounded-2xl">
                {feedMode === 'public' ? 'No signals detected on the network.' : 'Secure Channel Clear. No tickets.'}
            </div>
        )}
      </div>
    </div>
  );
};

export default Feed;

</script>

<script type="module-shim" data-module="./components/Dashboard.js">

import React from 'react';
import { User, RankID } from '../types';
import { RANKS } from '../constants';
import CardVisual from './CardVisual';



const Dashboard: React.FC<DashboardProps> = ({ user }) => {
  const currentRank = RANKS[user.currentCard];
  const isMaxRank = user.currentCard === 'Aâ™ ';
  
  // Define absolute rank order to avoid confusing 'A' with low values
  const rankSequence: RankID[] = ['2â™ ', '3â™ ', '4â™ ', '5â™ ', '6â™ ', '7â™ ', '8â™ ', '9â™ ', '10â™ ', 'Jâ™ ', 'Qâ™ ', 'Kâ™ ', 'Aâ™ '];
  const currentIndex = rankSequence.indexOf(user.currentCard);
  
  const nextRankId = isMaxRank 
    ? 'Aâ™ ' 
    : rankSequence[currentIndex + 1] || 'Aâ™ ';
  
  const nextRank = RANKS[nextRankId];
  
  const progress = isMaxRank 
    ? 100, Math.max(0, 
        ((user.totalPoints - currentRank.minPoints) / (nextRank.minPoints - currentRank.minPoints)) * 100
      ));

  const influencePower = currentRank.voteWeight;

  return (
    <div className="space-y-8 pb-32 animate-in fade-in duration-700 slide-in-from-bottom-4">
      
      <div className="flex flex-col md:flex-row justify-between items-end gap-4 border-b border-white/5 pb-6">
          <div>
            <h3 className="text-brand-red font-mono text-xs uppercase tracking-[0.3em] mb-2">Welcome Back</h3>
            <h1 className="text-4xl md:text-5xl font-display font-bold text-white tracking-tight">
                {user.username}
            </h1>
          </div>
          <div className="text-right hidden md:block">
             <div className="text-xs text-neutral-500 font-mono tracking-widest uppercase mb-1">Student ID</div>
             <div className="text-xl text-neutral-300 font-display font-bold tracking-wider">{user.studentId}</div>
          </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div className="lg:col-span-7 glass-panel rounded-2xl p-8 relative overflow-hidden group">
            <div className="absolute inset-0 bg-gradient-to-br from-neutral-800/50 to-black/50 z-0"></div>
            <div className="absolute top-0 right-0 p-8 opacity-5 text-9xl font-display font-bold text-white select-none group-hover, '')}
            </div>
            
            <div className="relative z-10 flex flex-col sm:flex-row items-center sm:items-start gap-8">
                <div className="transform hover:scale-105 transition-transform duration-500 hover:rotate-2 shadow-2xl shadow-black/50">
                    <CardVisual rankId={user.currentCard} size="lg" />
                </div>
                <div className="flex-1 w-full text-center sm:text-left">
                    <div className="inline-block px-3 py-1 bg-brand-red/10 border border-brand-red/20 rounded-full text-brand-red text-[10px] font-bold uppercase tracking-[0.2em] mb-3">
                        {currentRank.tier} Clearance
                    </div>
                    <h2 className="text-3xl font-display font-bold text-white mb-2 tracking-wide">{currentRank.name}</h2>
                    <p className="text-neutral-400 text-sm leading-relaxed mb-8 max-w-sm">
                        {isMaxRank 
                          ? "You have attained the ultimate authority: Ace of Spades. The system recognizes your absolute sovereignty."
                          : `You have ascended to the tier of ${currentRank.tier}. Your influence is growing within the system. Maintain momentum to reach the Council.`
                        }
                    </p>

                    <div className="space-y-2">
                        <div className="flex justify-between text-xs font-mono font-medium text-neutral-400">
                            <span className="text-brand-gold">{user.totalPoints.toLocaleString()} PTS</span>
                            <span>{isMaxRank ? 'MAX CLEARANCE' : `${nextRank.minPoints.toLocaleString()} PTS`}</span>
                        </div>
                        <div className="h-1.5 bg-neutral-900 rounded-full overflow-hidden border border-white/5">
                            <div 
                                className="h-full bg-gradient-to-r from-brand-red via-brand-crimson to-brand-gold shadow-[0_0_10px_rgba(220,38,38,0.5)]"
                                style={{ width, transition, 0, 0.2, 1)' }}
                            />
                        </div>
                        <p className="text-right text-[10px] text-neutral-600 mt-1 uppercase tracking-widest">
                            {isMaxRank ? 'TOP CLEARANCE ATTAINED' : `Target: ${nextRank.name}`}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div className="lg:col-span-5 space-y-4">
             <div className="grid grid-cols-2 gap-4 h-full">
                <div className="glass-panel p-5 rounded-2xl flex flex-col justify-between group hover:bg-white/5 transition-colors">
                    <div className="flex justify-between items-start">
                         <div className="p-2 bg-neutral-900/50 rounded-lg text-neutral-400 group-hover:text-brand-gold transition-colors">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
                         </div>
                    </div>
                    <div>
                        <p className="text-[10px] text-neutral-500 uppercase tracking-widest font-bold mb-1">Impact</p>
                        <p className="text-3xl font-display font-bold text-white">{user.stats.commentsCreated + user.stats.votesGiven + user.stats.postsCreated}</p>
                        <p className="text-[9px] text-neutral-600 font-mono">Total System Interactions</p>
                    </div>
                </div>

                <div className="glass-panel p-5 rounded-2xl flex flex-col justify-between group hover:bg-white/5 transition-colors">
                    <div className="flex justify-between items-start">
                         <div className="p-2 bg-neutral-900/50 rounded-lg text-neutral-400 group-hover:text-brand-red transition-colors">
                             <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                         </div>
                    </div>
                    <div>
                        <p className="text-[10px] text-neutral-500 uppercase tracking-widest font-bold mb-1">Influence</p>
                        <p className="text-3xl font-display font-bold text-white">{influencePower}x</p>
                        <p className="text-[9px] text-neutral-600 font-mono">Weighted Vote Power</p>
                    </div>
                </div>
                
                <div className="col-span-2 glass-panel p-6 rounded-2xl relative overflow-hidden flex items-center justify-center opacity-50">
                    <p className="text-xs font-mono text-neutral-600 uppercase tracking-widest">Protocol Directives Online</p>
                </div>
            </div>
        </div>
      </div>

      <div className="glass-panel rounded-2xl p-8 border-t border-white/5">
         <div className="flex items-center gap-3 mb-6">
             <div className="h-px flex-1 bg-gradient-to-r from-transparent via-neutral-800 to-transparent"></div>
             <h3 className="text-neutral-500 font-mono text-[10px] uppercase tracking-[0.3em]">System Privileges</h3>
             <div className="h-px flex-1 bg-gradient-to-r from-transparent via-neutral-800 to-transparent"></div>
         </div>
         <div className="flex flex-wrap justify-center gap-3">
             {currentRank.permissions.map(perm => (
                 <div key={perm} className="px-4 py-2 bg-black/40 border border-white/5 rounded-lg text-xs text-neutral-400 font-mono hover:border-brand-red/30 hover:text-white transition-colors cursor-default">
                     <span className="text-brand-red/50 mr-2">></span>
                     {perm.toUpperCase().replace(/([A-Z])/g, ' $1').trim()}
                 </div>
             ))}
         </div>
      </div>
    </div>
  );
};

export default Dashboard;

</script>

<script type="module-shim" data-module="./components/Leaderboard.js">
import React, { useEffect, useState } from 'react';
import { User } from '../types';
import { storage } from '../services/storageService';
import CardVisual from './CardVisual';

const Leaderboard: React.FC = () => {
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchUsers = async () => {
      const allUsers = await storage.getAllUsers();
      // Filter out guests and sort by points desc
      const sorted = allUsers
        .filter(u => !u.isGuest)
        .sort((a, b) => b.totalPoints - a.totalPoints);
      setUsers(sorted);
      setLoading(false);
    };
    fetchUsers();
  }, []);

  if (loading) return (
      <div className="flex flex-col items-center justify-center h-64 space-y-4">
          <div className="w-12 h-1 bg-neutral-800 rounded-full overflow-hidden">
              <div className="w-full h-full bg-brand-red animate-shine" style={{backgroundSize: '200% auto'}}></div>
          </div>
          <p className="text-xs font-mono text-neutral-500 uppercase tracking-widest">Accessing Mainframe...</p>
      </div>
  );

  return (
    <div className="pb-32 animate-in fade-in duration-700">
      <div className="flex items-center justify-between mb-12">
        <div>
            <h2 className="text-3xl font-display font-bold text-white tracking-wide">Elite Rankings</h2>
            <p className="text-neutral-500 text-xs mt-1 font-mono uppercase tracking-widest">Global Competition â€¢ Season 1</p>
        </div>
        <div className="flex items-center gap-2">
            <span className="w-2 h-2 bg-brand-red rounded-full animate-pulse"></span>
            <span className="text-[10px] font-mono text-brand-red font-bold">LIVE</span>
        </div>
      </div>

      {/* Top 3 Podium */}
      <div className="flex items-end justify-center gap-4 md:gap-8 mb-16 px-4">
        {users[1] && (
            <div className="flex flex-col items-center group relative w-1/3 max-w-[140px]">
                <div className="absolute inset-0 bg-white/5 blur-2xl rounded-full opacity-0 group-hover:opacity-20 transition-opacity"></div>
                <CardVisual rankId={users[1].currentCard} size="md" className="mb-4 transform group-hover:-translate-y-4 transition-transform duration-500 relative z-10" />
                <div className="w-full bg-gradient-to-b from-neutral-400 to-neutral-600 h-32 flex flex-col items-center justify-start pt-4 rounded-t-xl relative overflow-hidden border-t border-white/20">
                     <div className="absolute top-0 inset-x-0 h-px bg-white/50"></div>
                     <span className="text-4xl font-display font-black text-white/20 mb-1">2</span>
                     <span className="text-xs font-bold text-white truncate w-24 text-center px-2">{users[1].username}</span>
                     <span className="text-[10px] text-neutral-300 font-mono mt-1">{users[1].totalPoints.toLocaleString()}</span>
                </div>
            </div>
        )}
        {users[0] && (
            <div className="flex flex-col items-center group relative w-1/3 max-w-[160px] z-10 -mx-2">
                 <div className="absolute inset-0 bg-brand-gold/10 blur-3xl rounded-full opacity-50 animate-pulse-slow"></div>
                 <div className="relative">
                    <div className="absolute -top-10 left-1/2 -translate-x-1/2 text-brand-gold text-2xl animate-float filter drop-shadow-[0_0_10px_rgba(251,191,36,0.5)]">ðŸ‘‘</div>
                    <CardVisual rankId={users[0].currentCard} size="lg" className="mb-6 transform group-hover,191,36,0.2)]" />
                </div>
                <div className="w-full bg-gradient-to-b from-brand-gold to-yellow-700 h-44 flex flex-col items-center justify-start pt-6 rounded-t-xl relative overflow-hidden border-t border-white/30 shadow-2xl">
                    <div className="absolute top-0 inset-x-0 h-px bg-white/60"></div>
                    <span className="text-5xl font-display font-black text-white/20 mb-2">1</span>
                    <span className="text-sm font-bold text-white truncate w-32 text-center px-2">{users[0].username}</span>
                    <span className="text-[10px] text-yellow-100 font-mono font-bold mt-1 bg-black/20 px-2 py-0.5 rounded">{users[0].totalPoints.toLocaleString()} PTS</span>
                </div>
            </div>
        )}
        {users[2] && (
            <div className="flex flex-col items-center group relative w-1/3 max-w-[140px]">
                <div className="absolute inset-0 bg-brand-red/5 blur-2xl rounded-full opacity-0 group-hover:opacity-20 transition-opacity"></div>
                <CardVisual rankId={users[2].currentCard} size="md" className="mb-4 transform group-hover:-translate-y-4 transition-transform duration-500 relative z-10" />
                <div className="w-full bg-gradient-to-b from-brand-darkRed to-neutral-900 h-24 flex flex-col items-center justify-start pt-4 rounded-t-xl relative overflow-hidden border-t border-white/20">
                    <div className="absolute top-0 inset-x-0 h-px bg-white/40"></div>
                    <span className="text-4xl font-display font-black text-white/20 mb-1">3</span>
                    <span className="text-xs font-bold text-neutral-300 truncate w-24 text-center px-2">{users[2].username}</span>
                    <span className="text-[10px] text-neutral-500 font-mono mt-1">{users[2].totalPoints.toLocaleString()}</span>
                </div>
            </div>
        )}
      </div>

      {/* List */}
      <div className="glass-panel border border-white/5 rounded-2xl overflow-hidden backdrop-blur-md">
        <div className="grid grid-cols-12 gap-4 px-6 py-3 border-b border-white/5 text-[10px] font-mono text-neutral-500 uppercase tracking-widest">
             <div className="col-span-1 text-center">Rank</div>
             <div className="col-span-7">Agent</div>
             <div className="col-span-4 text-right">Score</div>
        </div>
        
        {users.slice(3).map((user, index) => (
            <div key={user.studentId} className="grid grid-cols-12 gap-4 items-center px-6 py-4 border-b border-white/5 hover:bg-white/5 transition-colors group">
                <div className="col-span-1 text-center font-mono font-bold text-neutral-600 group-hover:text-white transition-colors">
                    {index + 4}
                </div>
                <div className="col-span-7 flex items-center gap-4">
                     <div className="w-8 h-10 rounded bg-neutral-900 border border-white/5 flex items-center justify-center text-xs font-bold text-neutral-400 group-hover, '')}
                     </div>
                     <div className="min-w-0">
                        <div className="font-bold text-sm text-neutral-300 group-hover:text-white truncate transition-colors">{user.username}</div>
                        <div className="text-[10px] text-neutral-600 group-hover:text-neutral-500">{user.house}</div>
                     </div>
                </div>
                <div className="col-span-4 text-right">
                    <div className="font-mono text-brand-gold font-bold">{user.totalPoints.toLocaleString()}</div>
                </div>
            </div>
        ))}
      </div>
    </div>
  );
};

export default Leaderboard;
</script>

<script type="module-shim" data-module="./components/CouncilChamber.js">

import React, { useState, useEffect } from 'react';
import { Post, User, RankID, Comment } from '../types';
import { storage } from '../services/storageService';
import { checkContentSafety, sanitizeContent } from '../services/geminiService';
import { POINT_VALUES, RANKS } from '../constants';
import CardVisual from './CardVisual';



const CouncilChamber: React.FC<CouncilChamberProps> = ({ currentUser, refreshTrigger, onActivity }) => {
  const [posts, setPosts] = useState([]);
  const [newProposal, setNewProposal] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [allUsers, setAllUsers] = useState<Record<string, User>>({});
  
  const [commentInputs, setCommentInputs] = useState<Record<string, string>>({});
  const [expandedComments, setExpandedComments] = useState([]);

  const rankOrder: RankID[] = ['2â™ ', '3â™ ', '4â™ ', '5â™ ', '6â™ ', '7â™ ', '8â™ ', '9â™ ', '10â™ ', 'Jâ™ ', 'Qâ™ ', 'Kâ™ ', 'Aâ™ '];
  const userRankIndex = rankOrder.indexOf(currentUser.currentCard);
  const canPropose = userRankIndex > 9; 
  const canModerate = currentUser.isAdmin || userRankIndex >= 11; 

  useEffect(() => {
    loadProposals();
  }, [refreshTrigger]);

  const loadProposals = async () => {
    const [allPosts, usersList] = await Promise.all([storage.getPosts(), storage.getAllUsers()]);
    const userMap, User> = {};
    usersList.forEach(u => userMap[u.studentId] = u);
    setAllUsers(userMap);
    const proposals = allPosts.filter(p => p.category === 'proposal');
    setPosts(proposals);
  };

  const calculateScore = (post) => {
      let score = 0;
      post.upvotes.forEach(uid => {
          const voter = allUsers[uid];
          const weight = voter ? RANKS[voter.currentCard].voteWeight : 1;
          score += weight;
      });
      post.downvotes?.forEach(uid => {
          const voter = allUsers[uid];
          const weight = voter ? RANKS[voter.currentCard].voteWeight : 1;
          score -= weight;
      });
      return score;
  };

  const handleCreateProposal = async () => {
    if (!newProposal.trim() || !canPropose) return;
    setIsSubmitting(true);

    const sanitizedProposal = await sanitizeContent(newProposal);
    const safetyCheck = await checkContentSafety(sanitizedProposal);
    
    let status: Post['status'] = 'approved';
    if (!safetyCheck.safe) status = 'flagged';
    
    const post: Post = {
      id)}`,
      authorId,
      authorName,
      authorRank,
      content,
      category,
      status,
      upvotes,
      downvotes,
      comments,
      createdAt).toISOString(),
    };

    await storage.savePost(post);
    setNewProposal('');
    setIsSubmitting(false);
    loadProposals();
    onActivity();
  };

  const handleVote = async (post, type) => {
    if (post.status === 'passed' || post.status === 'failed') return;
    if (post.upvotes.includes(currentUser.studentId) || (post.downvotes && post.downvotes.includes(currentUser.studentId))) {
        return; 
    }

    const isUp = type === 'up';
    let newUpvotes = [...post.upvotes];
    let newDownvotes = [...(post.downvotes || [])];

    if (isUp) {
        newUpvotes.push(currentUser.studentId);
    } else {
        newDownvotes.push(currentUser.studentId);
    }

    const updatedPost = {
        ...post,
        upvotes,
        downvotes);

    const freshUser = await storage.getUser(currentUser.studentId);
    if (freshUser) {
        const updatedUser = { 
            ...freshUser, 
            totalPoints,
            stats,
                votesGiven);
        onActivity(); 
    }

    loadProposals();
  };

  const handleProposalDecision = async (post, decision) => {
      const newStatus: Post['status'] = decision === 'pass' ? 'passed' : 'failed';
      const updatedPost = { ...post, status);
      loadProposals();
  };

  const handleDeleteProposal = async (e, postId) => {
      e.stopPropagation();
      e.preventDefault();
      setPosts(prev => prev.filter(p => p.id !== postId));
      await storage.deletePost(postId);
      onActivity(); 
  };

  const handleAddComment = async (postId) => {
    const content = commentInputs[postId];
    if (!content?.trim()) return;

    const post = posts.find(p => p.id === postId);
    if (!post) return;

    const sanitizedComment = await sanitizeContent(content);

    const newComment: Comment = {
        id)}`,
        authorId,
        authorName,
        content),
        createdAt).toISOString()
    };

    const updatedPost = {
        ...post,
        comments), newComment]
    };
    await storage.savePost(updatedPost);
    setCommentInputs({ ...commentInputs, [postId]: '' });
    loadProposals();
  };

  const handleDeleteComment = async (e, postId, commentId) => {
      e.stopPropagation();
      e.preventDefault();
      setPosts(prevPosts => prevPosts.map(p => {
          if (p.id === postId && p.comments) {
              return { ...p, comments: p.comments.filter(c => c.id !== commentId) };
          }
          return p;
      }));
      await storage.deleteComment(postId, commentId);
  };

  const toggleComments = (postId) => {
    if (expandedComments.includes(postId)) {
        setExpandedComments(expandedComments.filter(id => id !== postId));
    } else {
        setExpandedComments([...expandedComments, postId]);
    }
  };


  return (
    <div className="max-w-4xl mx-auto space-y-12 pb-32 animate-in fade-in duration-700">
      <div className="text-center py-8 relative">
           <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-brand-gold/5 blur-[80px] rounded-full pointer-events-none"></div>
           <h1 className="text-4xl md:text-5xl font-display font-black text-white tracking-tight relative z-10 mb-2">THE COUNCIL CHAMBER</h1>
           <p className="text-brand-gold font-mono text-xs uppercase tracking-[0.4em] relative z-10">High Table Policy Proposals</p>
      </div>

      {canPropose ? (
          <div className="glass-panel rounded-2xl border border-brand-gold/20 p-8 shadow-[0_0_50px_rgba(0,0,0,0.5)] relative overflow-hidden group">
            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-gold to-transparent"></div>
            <div className="flex gap-8">
                <div className="hidden sm:block">
                    <CardVisual rankId={currentUser.currentCard} size="md" className="shadow-[0_0_20px_rgba(251,191,36,0.1)]" />
                </div>
                <div className="flex-1">
                    <div className="mb-4 flex justify-between items-center">
                        <span className="text-brand-gold font-display font-bold uppercase tracking-widest text-sm">Submit New Directive</span>
                        <div className="px-2 py-1 rounded bg-brand-gold/10 border border-brand-gold/20 text-[10px] text-brand-gold font-mono uppercase">
                            Clearance Verified
                        </div>
                    </div>
                    <textarea
                        value={newProposal}
                        onChange={(e) => setNewProposal(e.target.value)}
                        placeholder="Outline your policy for the future of Greenhead..."
                        className="w-full bg-black/50 border border-brand-gold/20 rounded-xl p-6 text-base text-white placeholder-neutral-600 focus:border-brand-gold focus:ring-1 focus:ring-brand-gold/50 focus:outline-none resize-none h-40 transition-all font-serif italic leading-relaxed"
                    />
                    <div className="flex justify-end mt-6">
                        <button
                            onClick={handleCreateProposal}
                            disabled={isSubmitting || !newProposal.trim()}
                            className={`px-8 py-3 rounded-lg font-bold text-xs uppercase tracking-[0.2em] transition-all duration-300 ${
                                isSubmitting || !newProposal.trim()
                                ? 'bg-neutral-900 text-neutral-600 cursor-not-allowed border border-neutral-800'
                                : 'bg-brand-gold hover,191,36,0.4)] hover,191,36,0.6)]'
                            }`}
                        >
                            {isSubmitting ? 'Submitting...' : 'Table Proposal'}
                        </button>
                    </div>
                </div>
            </div>
          </div>
      )="glass-panel p-6 rounded-xl border border-white/5 text-center flex flex-col items-center gap-4">
              <svg className="w-8 h-8 text-neutral-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
              <p className="text-neutral-500 font-mono text-xs uppercase tracking-widest">Proposal Submission Restricted to Jack+ Clearance</p>
          </div>
      )}

      <div className="space-y-8">
        {posts.map(post => {
            const score = calculateScore(post);
            const isPassed = post.status === 'passed';
            const isFailed = post.status === 'failed';
            const isActive = !isPassed && !isFailed;
            const userVoted = post.upvotes.includes(currentUser.studentId) || (post.downvotes && post.downvotes.includes(currentUser.studentId));
            const isAuthor = post.authorId === currentUser.studentId;
            
            // Resolve live identity for author
            const authorData = allUsers[post.authorId];
            const currentName = authorData?.username || post.authorName;
            const currentRank = authorData?.currentCard || post.authorRank;

            return (
                <div key={post.id} className={`glass-panel border rounded-2xl p-8 transition-all duration-500 group relative overflow-visible ${
                    isPassed ? 'border-emerald-500/30 bg-emerald-950/10' :
                    isFailed ? 'border-red-500/30 bg-red-950/10' :
                    'border-brand-gold/10 hover) && (
                        <button 
                            onClick={(e) => handleDeleteProposal(e, post.id)}
                            className="absolute top-4 right-4 z-50 p-2 bg-black hover:bg-red-500 text-neutral-500 hover:text-white rounded-lg transition-all border border-white/10 hover:border-red-500 shadow-xl cursor-pointer"
                            title="Delete Proposal"
                        >
                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    )}

                    {isPassed && <div className="absolute top-0 right-0 p-4 opacity-10 rotate-12 text-6xl text-emerald-500 font-black border-4 border-emerald-500 rounded-lg pointer-events-none">PASSED</div>}
                    {isFailed && <div className="absolute top-0 right-0 p-4 opacity-10 -rotate-12 text-6xl text-red-500 font-black border-4 border-red-500 rounded-lg pointer-events-none">REJECTED</div>}
                    
                    <div className="flex flex-col md:flex-row gap-8 relative z-10">
                        <div className="flex md:flex-col items-center gap-4 md:gap-2 justify-center md:justify-start min-w-[60px]">
                            <button 
                                onClick={() => handleVote(post, 'up')}
                                disabled={!isActive || userVoted}
                                className={`p-2 rounded-full transition-all duration-200 ${
                                    (!isActive || userVoted) ? 'opacity-30 cursor-not-allowed' : 'hover) ? 'text-green-500 bg-green-500/10' : 'text-neutral-500 hover:text-green-400 hover:bg-white/5'}`}
                                title={userVoted ? "Vote Cast Locked" : "Vote Yes"}
                            >
                                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M5 15l7-7 7 7" /></svg>
                            </button>
                            
                            <span className={`text-2xl font-display font-bold ${score > 0 ? 'text-brand-gold' : score < 0 ? 'text-brand-red' : 'text-white'}`}>
                                {score > 0 ? '+' : ''}{score}
                            </span>
                            
                            <button 
                                onClick={() => handleVote(post, 'down')}
                                disabled={!isActive || userVoted}
                                className={`p-2 rounded-full transition-all duration-200 ${
                                    (!isActive || userVoted) ? 'opacity-30 cursor-not-allowed' : 'hover) ? 'text-red-500 bg-red-500/10' : 'text-neutral-500 hover:text-red-400 hover:bg-white/5'}`}
                                title={userVoted ? "Vote Cast Locked" : "Vote No"}
                            >
                                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 9l-7 7-7-7" /></svg>
                            </button>
                        </div>

                        <div className="flex-1">
                            <div className="flex justify-between items-start mb-6">
                                <div className="flex items-center gap-4">
                                    <CardVisual rankId={currentRank} size="sm" className="w-12 h-16 shadow-lg border border-brand-gold/20" />
                                    <div>
                                        <h3 className="font-display font-bold text-xl text-white tracking-wide">{currentName}</h3>
                                        <div className="flex items-center gap-3 mt-1">
                                            <span className={`text-[10px] px-2 py-0.5 rounded border font-bold uppercase tracking-wider ${
                                                isPassed ? 'text-emerald-500 bg-emerald-500/10 border-emerald-500/20' :
                                                isFailed ? 'text-red-500 bg-red-500/10 border-red-500/20' :
                                                'text-brand-gold bg-brand-gold/10 border-brand-gold/20'
                                            }`}>
                                                {isPassed ? 'Enacted' : isFailed ? 'Failed' : 'Proposal'}
                                            </span>
                                            <span className="text-white bg-black/50 border border-white/10 px-2 py-0.5 rounded text-[10px] font-mono">
                                                Influence) > 0 ? 'Positive' : 'Negative'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <p className="text-neutral-200 text-lg leading-relaxed font-light whitespace-pre-wrap border-l-2 border-brand-gold/20 pl-6 mb-8">
                                {post.content}
                            </p>

                            {canModerate && isActive && (
                                <div className="flex justify-end gap-4 border-t border-white/5 pt-6 mb-6">
                                    <button 
                                        onClick={() => handleProposalDecision(post, 'fail')}
                                        className="px-4 py-2 border border-red-500/30 text-red-500 hover:bg-red-500 hover:text-white rounded text-xs font-bold uppercase tracking-widest transition-all"
                                    >
                                        Reject Motion
                                    </button>
                                    <button 
                                        onClick={() => handleProposalDecision(post, 'pass')}
                                        className="px-4 py-2 border border-emerald-500/30 text-emerald-500 hover)}

                             <div className="border-t border-white/5 pt-4">
                                <button 
                                    onClick={() => toggleComments(post.id)}
                                    className="text-xs text-neutral-500 font-bold uppercase tracking-widest hover:text-white flex items-center gap-2 mb-4"
                                >
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" /></svg>
                                    {expandedComments.includes(post.id) ? 'Hide Deliberation' : `View Deliberation (${post.comments?.length || 0})`}
                                </button>
                                
                                {expandedComments.includes(post.id) && (
                                    <div className="space-y-4 animate-in fade-in slide-in-from-top-2">
                                        <div className="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                            {post.comments?.map(comment => {
                                                const canDeleteComment = currentUser.isAdmin || comment.authorId === currentUser.studentId;
                                                const commentAuthorData = allUsers[comment.authorId];
                                                const currentCommenterName = commentAuthorData?.username || comment.authorName;

                                                return (
                                                    <div key={comment.id} className="bg-white/5 p-3 rounded-lg group/comment relative hover:bg-white/10 transition-colors">
                                                        {canDeleteComment && (
                                                            <button 
                                                                onClick={(e) => handleDeleteComment(e, post.id, comment.id)}
                                                                className="absolute top-2 right-2 bg-black text-neutral-600 hover:text-red-500 p-1.5 rounded transition-colors z-50 cursor-pointer border border-white/5"
                                                                title="Delete Comment"
                                                            >
                                                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                                            </button>
                                                        )}

                                                        <div className="flex justify-between items-baseline mb-1 mr-8">
                                                            <span className="text-brand-gold text-xs font-bold">{currentCommenterName}</span>
                                                            <span className="text-[10px] text-neutral-600 font-mono">{new Date(comment.createdAt).toLocaleDateString()}</span>
                                                        </div>
                                                        <p className="text-sm text-neutral-300 pr-6">{comment.content}</p>
                                                    </div>
                                                );
                                            })}
                                            {(!post.comments || post.comments.length === 0) && (
                                                <div className="text-center text-neutral-600 text-xs italic py-4">No remarks recorded.</div>
                                            )}
                                        </div>
                                        
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                value={commentInputs[post.id] || ''} 
                                                onChange={e => setCommentInputs({...commentInputs, [post.id]: e.target.value})}
                                                placeholder="Add your remark..."
                                                className="flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-brand-gold outline-none"
                                                onKeyDown={(e) => e.key === 'Enter' && handleAddComment(post.id)}
                                            />
                                            <button 
                                                onClick={() => handleAddComment(post.id)}
                                                className="px-4 py-2 bg-white/10 hover)}
                             </div>
                        </div>
                    </div>
                </div>
            );
        })}

        {posts.length === 0 && (
            <div className="text-center py-24 glass-panel rounded-2xl border-dashed border-2 border-white/10">
                <p className="text-neutral-500 font-display font-bold text-2xl mb-2">Chamber Empty</p>
                <p className="text-neutral-600 font-mono text-xs uppercase tracking-widest">No policies currently tabled</p>
            </div>
        )}
      </div>
    </div>
  );
};

export default CouncilChamber;

</script>

<script type="module-shim" data-module="./components/AceControls.js">

import React, { useState, useEffect } from 'react';
import { User, RankID, PurchaseLog, SystemSettings } from '../types';
import { storage } from '../services/storageService';
import { RANKS } from '../constants';
import CardVisual from './CardVisual';



const AceControls: React.FC<AceControlsProps> = ({ currentUser, onActivity }) => {
    const [activeSection, setActiveSection] = useState('operatives');
    const [users, setUsers] = useState([]);
    const [logs, setLogs] = useState([]);
    const [settings, setSettings] = useState(null);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [editingUser, setEditingUser] = useState(null);
    const [editForm, setEditForm] = useState<{ points, rank, username, password, rank, username);

    useEffect(() => { refreshData(); }, [activeSection]);

    const refreshData = async () => {
        setLoading(true);
        const [u, l, s] = await Promise.all([storage.getAllUsers(), storage.getPurchaseLogs(), storage.getSettings()]);
        setUsers(u);
        setLogs(l);
        setSettings(s);
        setLoading(false);
    };

    const handleUpdateProtocol = async (field, value) => {
        await storage.updateSettings({ [field]: value });
        refreshData();
    };

    const handleMarkDelivered = async (logId) => {
        await storage.markDelivered(logId);
        refreshData();
    };

    const handlePurgeOperative = async (studentId) => {
        if (studentId === currentUser.studentId || studentId === 'S253456') {
            alert("PROTOCOL OVERRIDE);
            return;
        }
        if (confirm(`CRITICAL)) {
            await storage.deleteUser(studentId);
            await refreshData();
            onActivity();
        }
    };

    const handleBanOperative = async (studentId) => {
        if (studentId === currentUser.studentId || studentId === 'S253456') {
            alert("PROTOCOL OVERRIDE);
            return;
        }
        if (confirm(`Restrict access for operative ${studentId}? They will be locked out of the system.`)) {
            await storage.updateUserStatus(studentId, { isBanned);
            await refreshData();
            onActivity();
        }
    };

    const handleRecoverOperative = async (studentId) => {
        if (confirm(`Restore access for ${studentId}? They will be able to log in immediately.`)) {
            await storage.updateUserStatus(studentId, { isBanned);
            await refreshData();
            alert(`User ${studentId} restored to active duty.`);
            onActivity();
        }
    };

    const startEdit = (user) => {
        setEditingUser(user.studentId);
        setEditForm({ 
            points, 
            rank, 
            username,
            password);
    };

    const saveEdit = async (studentId) => {
        await storage.updateUserStatus(studentId, {
            totalPoints,
            currentCard,
            currentRank,
            username);

        if (editForm.password && editForm.password.length >= 8) {
            await storage.updatePassword(studentId, editForm.password);
        }

        setEditingUser(null);
        await refreshData();
        onActivity();
    };

    const rankOrder: RankID[] = ['2â™ ', '3â™ ', '4â™ ', '5â™ ', '6â™ ', '7â™ ', '8â™ ', '9â™ ', '10â™ ', 'Jâ™ ', 'Qâ™ ', 'Kâ™ ', 'Aâ™ '];
    const filteredUsers = users.filter(u => u.studentId.includes(searchTerm.toUpperCase()) || u.username.toLowerCase().includes(searchTerm.toLowerCase()));
    const pendingDeliveries = logs.filter(l => !l.delivered).length;

    const getLatestUsername = (id, fallback) => {
        const found = users.find(u => u.studentId === id);
        return found ? found.username : fallback;
    };

    const formatLogDate = (isoString) => {
        const date = new Date(isoString);
        return `${date.toLocaleTimeString([], { hour, minute)} on ${date.toLocaleDateString()}`;
    };

    return (
        <div className="space-y-8 animate-in fade-in duration-700 pb-32">
            <div className="flex flex-col md:flex-row justify-between items-center bg-brand-obsidian p-8 border border-white/5 rounded-3xl shadow-2xl gap-6 relative overflow-hidden">
                <div className="absolute top-0 right-0 p-8 opacity-5">
                    <svg className="w-32 h-32" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2zm0 3.45l8.15 14.1H3.85L12 5.45zM11 16h2v2h-2v-2zm0-7h2v5h-2V9z"/></svg>
                </div>
                <div className="relative z-10">
                    <h1 className="text-4xl font-display font-black text-white">ACE COMMAND</h1>
                    <p className="text-[10px] text-brand-red font-mono uppercase tracking-[0.4em] font-bold">Protocol Overlord Interface</p>
                </div>
                <div className="flex gap-2 bg-black/40 p-1.5 rounded-xl border border-white/5 relative z-10">
                    {['operatives', 'deliveries', 'protocol'].map(s => (
                        <button 
                            key={s} 
                            onClick={() => setActiveSection(s)} 
                            className={`px-6 py-2.5 text-[10px] font-bold uppercase rounded-lg transition-all flex items-center gap-2 ${activeSection === s ? 'bg-brand-red text-white shadow-lg' : 'text-neutral-500 hover:text-white hover:bg-white/5'}`}
                        >
                            {s}
                            {s === 'deliveries' && pendingDeliveries > 0 && (
                                <span className="w-4 h-4 bg-white text-brand-red rounded-full flex items-center justify-center text-[8px] animate-pulse">{pendingDeliveries}</span>
                            )}
                        </button>
                    ))}
                </div>
            </div>

            {activeSection === 'deliveries' && (
                <div className="space-y-6 max-w-5xl">
                    <h3 className="text-brand-gold font-bold uppercase tracking-[0.3em] text-xs mb-8 ml-2 flex items-center gap-3">
                        <div className="w-2 h-2 rounded-full bg-brand-gold animate-pulse"></div>
                        Requisition Manifest Logs
                    </h3>
                    <div className="space-y-4">
                        {logs.length === 0 && (
                             <div className="p-20 text-center glass-panel rounded-3xl border-dashed border-2 border-white/5 opacity-20">
                                 <p className="text-sm font-mono uppercase tracking-widest">No active requisitions recorded.</p>
                             </div>
                        )}
                        {logs.map(log => (
                            <div key={log.id} className={`p-8 rounded-3xl border transition-all duration-500 flex flex-col md,35,35,0.05)]'}`}>
                                <div className="flex-1 space-y-4 text-center md:text-left">
                                    <div className="flex items-center gap-3 justify-center md:justify-start">
                                        <div className={`w-2 h-2 rounded-full ${log.delivered ? 'bg-neutral-700' : 'bg-brand-red animate-pulse'}`}></div>
                                        <span className="text-[10px] font-mono text-neutral-500 uppercase tracking-widest">LOG_REF: {log.id}</span>
                                    </div>
                                    <p className="text-lg font-display text-white leading-relaxed font-light">
                                        Operative <span className="text-brand-gold font-bold">{getLatestUsername(log.buyerId, log.buyerName)}</span> bought asset <span className="text-white bg-white/10 px-2 py-0.5 rounded font-bold">"{log.artTitle}"</span> at <span className="text-neutral-400 font-mono italic">{formatLogDate(log.timestamp)}</span> for <span className="text-brand-gold font-bold">{log.price} PTS</span>.
                                    </p>
                                    <p className="text-[9px] text-neutral-600 font-mono uppercase tracking-[0.2em]">Identifier: {log.buyerId}</p>
                                </div>
                                
                                <div className="shrink-0">
                                    {!log.delivered ? (
                                        <button 
                                            onClick={() => handleMarkDelivered(log.id)} 
                                            className="px-8 py-4 bg-emerald-600 hover)="px-8 py-4 bg-white/5 border border-white/10 rounded-xl flex items-center gap-3 text-emerald-500 text-[10px] font-black uppercase tracking-[0.2em]">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                                            Manifest Fulfilled
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {activeSection === 'operatives' && (
                <div className="space-y-6">
                    <div className="flex gap-4">
                        <input 
                            type="text" 
                            placeholder="Search operatives by ID or Name..." 
                            value={searchTerm}
                            onChange={e => setSearchTerm(e.target.value)}
                            className="flex-1 bg-black/50 border border-white/10 rounded-2xl p-5 text-white font-mono placeholder-neutral-700 focus:border-brand-red outline-none transition-all shadow-inner"
                        />
                    </div>
                    
                    <div className="grid grid-cols-1 gap-4">
                        {filteredUsers.map(user => (
                            <div key={user.studentId} className={`glass-panel p-6 rounded-2xl border ${user.isBanned ? 'border-red-500/30 bg-red-950/5' : 'border-white/5'} transition-all hover:bg-white/2`}>
                                {editingUser === user.studentId ? (
                                    <div className="space-y-4 p-4 animate-in slide-in-from-left-2">
                                        <h3 className="text-xs font-bold text-brand-red uppercase tracking-widest mb-4">Identity Editor Overlay</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                            <div className="space-y-2">
                                                <label className="text-[10px] uppercase font-bold text-neutral-500 ml-1">Display Alias</label>
                                                <input type="text" value={editForm.username} onChange={e => setEditForm({...editForm, username)} className="w-full bg-black p-3 border border-white/10 rounded-xl text-sm text-white focus:border-brand-red outline-none" />
                                            </div>
                                            <div className="space-y-2">
                                                <label className="text-[10px] uppercase font-bold text-neutral-500 ml-1">Point Balance</label>
                                                <input type="number" value={editForm.points} onChange={e => setEditForm({...editForm, points)})} className="w-full bg-black p-3 border border-white/10 rounded-xl text-sm text-white font-mono focus:border-brand-red outline-none" />
                                            </div>
                                            <div className="space-y-2">
                                                <label className="text-[10px] uppercase font-bold text-neutral-500 ml-1">Rank Card</label>
                                                <select value={editForm.rank} onChange={e => setEditForm({...editForm, rank)} className="w-full bg-black p-3 border border-white/10 rounded-xl text-sm text-white focus:border-brand-red outline-none">
                                                    {rankOrder.map(r => <option key={r} value={r}>{r}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <div className="flex gap-4 justify-end pt-4">
                                            <button onClick={() => setEditingUser(null)} className="px-6 py-2 text-[10px] font-black text-neutral-500 uppercase tracking-widest">Abort</button>
                                            <button onClick={() => saveEdit(user.studentId)} className="px-10 py-3 bg-emerald-600 text-white rounded-xl font-black text-[10px] uppercase tracking-widest shadow-xl hover)="flex items-center justify-between">
                                        <div className="flex items-center gap-6">
                                            <div className="transform group-hover:scale-110 transition-transform">
                                                <CardVisual rankId={user.currentCard} size="sm" />
                                            </div>
                                            <div>
                                                <h4 className="font-display font-black text-white text-xl tracking-tight leading-none">{user.username} <span className="text-neutral-600 text-xs font-mono font-normal ml-2">[{user.studentId}]</span></h4>
                                                <p className="text-[10px] text-neutral-500 font-mono uppercase tracking-[0.2em] mt-2">{user.currentRank} â€¢ {user.totalPoints.toLocaleString()} PTS</p>
                                                {user.isBanned && <span className="inline-block text-[8px] font-black text-red-500 uppercase tracking-[0.3em] border border-red-500/30 px-2 py-0.5 rounded-full bg-red-500/5 mt-3 shadow-[0_0_15px_rgba(239,68,68,0.1)]">Account Restricted</span>}
                                            </div>
                                        </div>
                                        <div className="flex gap-3">
                                            <button onClick={() => startEdit(user)} className="p-3 bg-white/5 hover:bg-white/10 rounded-xl text-neutral-400 hover:text-white transition-all shadow-xl" title="Edit Identity"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>
                                            {user.isBanned ? (
                                                <button onClick={() => handleRecoverOperative(user.studentId)} className="p-3 bg-emerald-950/20 text-emerald-500 rounded-xl border border-emerald-900/40 shadow-xl" title="Unban Operative"><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg></button>
                                            )={() => handleBanOperative(user.studentId)} className="p-3 bg-red-950/20 text-red-500 rounded-xl border border-red-900/40 shadow-xl" title="Ban Operative"><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg></button>
                                            )}
                                            <button onClick={() => handlePurgeOperative(user.studentId)} className="p-3 bg-neutral-900 text-neutral-600 hover:text-red-500 rounded-xl border border-white/5 transition-colors shadow-xl" title="Purge Record"><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {activeSection === 'protocol' && settings && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="glass-panel p-10 rounded-[32px] border border-white/5 space-y-8 shadow-2xl">
                        <h3 className="text-xl font-display font-black text-white uppercase tracking-[0.2em] border-b border-white/5 pb-6 flex items-center gap-3">
                             <div className="w-2 h-8 bg-brand-red"></div>
                             System Infrastructure
                        </h3>
                        <div className="flex items-center justify-between p-4 bg-black/20 rounded-2xl border border-white/5">
                            <div>
                                <span className="text-sm font-bold text-white uppercase tracking-widest">Emergency Lockdown</span>
                                <p className="text-[10px] text-neutral-500 font-mono mt-1">Freezes all system activity immediately.</p>
                            </div>
                            <button 
                                onClick={() => handleUpdateProtocol('emergencyLockdown', !settings.emergencyLockdown)}
                                className={`w-14 h-7 rounded-full transition-all relative ${settings.emergencyLockdown ? 'bg-red-600' : 'bg-neutral-800'}`}
                            >
                                <div className={`absolute top-1 w-5 h-5 rounded-full bg-white shadow-lg transition-all ${settings.emergencyLockdown ? 'left-8' : 'left-1'}`}></div>
                            </button>
                        </div>
                        <div className="flex items-center justify-between p-4 bg-black/20 rounded-2xl border border-white/5">
                            <div>
                                <span className="text-sm font-bold text-white uppercase tracking-widest">Guest Access</span>
                                <p className="text-[10px] text-neutral-500 font-mono mt-1">Allows read-only access for unregistered users.</p>
                            </div>
                            <button 
                                onClick={() => handleUpdateProtocol('allowGuestAccess', !settings.allowGuestAccess)}
                                className={`w-14 h-7 rounded-full transition-all relative ${settings.allowGuestAccess ? 'bg-emerald-600' : 'bg-neutral-800'}`}
                            >
                                <div className={`absolute top-1 w-5 h-5 rounded-full bg-white shadow-lg transition-all ${settings.allowGuestAccess ? 'left-8' : 'left-1'}`}></div>
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default AceControls;

</script>

<script type="module-shim" data-module="./components/ArtGallery.js">

import React, { useState, useEffect } from 'react';
import { User, ArtPiece } from '../types';
import { storage } from '../services/storageService';

const TimerDisplay = ({ expiresAt, onExpire }: { expiresAt) => void }) => {
    const [timeLeft, setTimeLeft] = useState('');

    useEffect(() => {
        const calculateTime = () => {
            const now = new Date().getTime();
            const distance = new Date(expiresAt).getTime() - now;

            if (distance < 0) {
                onExpire();
                return 'EXPIRED';
            }

            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);

            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        const timer = setInterval(() => {
            setTimeLeft(calculateTime());
        }, 1000);

        setTimeLeft(calculateTime());
        return () => clearInterval(timer);
    }, [expiresAt, onExpire]);

    return (
        <div className="text-[10px] font-mono font-bold text-brand-red bg-black/80 px-2 py-1 rounded border border-brand-red/50 backdrop-blur-md shadow-lg">
            EXPIRES IN);
};

export default function ArtGallery({ currentUser, onPurchase }: { currentUser) => void }) {
    const [artPieces, setArtPieces] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showUpload, setShowUpload] = useState(false);
    const [newArt, setNewArt] = useState({ 
        title, 
        imageUrl, 
        artistId, 
        description, 
        price,
        durationHours);

    useEffect(() => { loadArt(); }, []);

    const loadArt = async () => {
        setLoading(true);
        const art = await storage.getArtPieces();
        
        // Filter out expired items
        const now = new Date().getTime();
        const activeArt = art.filter(a => new Date(a.expiresAt).getTime() > now);
        
        setArtPieces(activeArt);
        setLoading(false);
    };

    const handleUpload = async (e) => {
        e.preventDefault();
        
        const expirationDate = new Date();
        expirationDate.setHours(expirationDate.getHours() + newArt.durationHours);

        const art: ArtPiece = {
            id)}`,
            title,
            imageUrl,
            studentArtistId,
            description,
            price,
            ownerId,
            ownerName,
            createdAt).toISOString(),
            expiresAt)
        };
        await storage.uploadArt(art);
        setShowUpload(false);
        setNewArt({ title, imageUrl, artistId, description, price, durationHours);
        loadArt();
    };

    const handleDelete = async (e, artId) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (confirm("PROTOCOL ALERT)) {
            setArtPieces(prev => prev.filter(a => a.id !== artId));
            await storage.deleteArt(artId);
        }
    };

    if (loading && artPieces.length === 0) return (
        <div className="flex flex-col items-center justify-center p-20 space-y-4 text-center">
            <div className="w-16 h-1 bg-brand-red rounded-full overflow-hidden animate-pulse mx-auto"></div>
            <p className="text-xs font-mono text-neutral-500 uppercase tracking-widest">Scanning Secure Vault...</p>
        </div>
    );

    return (
        <div className="pb-32 space-y-12 animate-in fade-in duration-1000 relative">
            {/* Vault Header */}
            <div className="flex flex-col md:flex-row justify-between items-center bg-brand-obsidian p-10 rounded-3xl border border-white/5 relative overflow-hidden shadow-2xl">
                <div className="absolute top-0 right-0 p-8 opacity-5">
                    <svg className="w-24 h-24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                </div>
                <div className="relative z-10 text-center md:text-left">
                    <h1 className="text-5xl md:text-6xl font-display font-black text-white tracking-tighter">THE VAULT</h1>
                    <p className="text-brand-gold font-mono text-xs uppercase tracking-[0.4em] mt-2 font-bold">Secure Asset Repository</p>
                    <div className="mt-6 p-4 bg-red-950/20 border border-red-500/30 rounded-2xl max-w-lg shadow-[0_0_20px_rgba(220,38,38,0.1)]">
                        <p className="text-[12px] font-bold text-red-400 uppercase tracking-widest leading-relaxed">
                            Go into global network and cancel uplink. <br/>
                            Message the council asking if you can buy it. <br/>
                            First person to offer wins the item.
                        </p>
                    </div>
                </div>
                {currentUser.isAdmin && (
                    <button 
                        type="button"
                        onClick={() => setShowUpload(!showUpload)} 
                        className="mt-6 md)}
            </div>

            {/* Admin Upload Form */}
            {showUpload && (
                <form onSubmit={handleUpload} className="glass-panel p-8 rounded-3xl border border-brand-gold/30 space-y-6 animate-in slide-in-from-top-4 duration-500 relative z-[200]">
                    <h3 className="text-brand-gold font-bold uppercase tracking-widest text-sm">Asset Metadata Entry</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div className="space-y-2">
                             <label className="text-[10px] text-neutral-500 uppercase font-bold ml-1">Asset Title</label>
                             <input type="text" placeholder="Title" value={newArt.title} onChange={e => setNewArt({...newArt, title)} className="w-full bg-black/50 p-4 rounded-xl border border-white/10 text-white outline-none focus:border-brand-gold transition-colors" required />
                        </div>
                        <div className="space-y-2">
                             <label className="text-[10px] text-neutral-500 uppercase font-bold ml-1">Artist ID</label>
                             <input type="text" placeholder="S25XXXX" value={newArt.artistId} onChange={e => setNewArt({...newArt, artistId)} className="w-full bg-black/50 p-4 rounded-xl border border-white/10 text-white font-mono" required />
                        </div>
                        <div className="space-y-2">
                             <label className="text-[10px] text-neutral-500 uppercase font-bold ml-1">Image URL</label>
                             <input type="text" placeholder="https://..." value={newArt.imageUrl} onChange={e => setNewArt({...newArt, imageUrl)} className="w-full bg-black/50 p-4 rounded-xl border border-white/10 text-white" required />
                        </div>
                        <div className="space-y-2">
                             <label className="text-[10px] text-neutral-500 uppercase font-bold ml-1">Point Valuation (PTS)</label>
                             <input type="number" value={newArt.price} onChange={e => setNewArt({...newArt, price)})} className="w-full bg-black/50 p-4 rounded-xl border border-white/10 text-white font-mono" required />
                        </div>
                        <div className="space-y-2">
                             <label className="text-[10px] text-neutral-500 uppercase font-bold ml-1">Expiry (Hours)</label>
                             <input type="number" value={newArt.durationHours} onChange={e => setNewArt({...newArt, durationHours)})} className="w-full bg-black/50 p-4 rounded-xl border border-white/10 text-white font-mono" required />
                        </div>
                    </div>
                    <div className="space-y-2">
                        <label className="text-[10px] text-neutral-500 uppercase font-bold ml-1">Asset Intelligence</label>
                        <textarea placeholder="Description..." value={newArt.description} onChange={e => setNewArt({...newArt, description)} className="w-full bg-black/50 p-4 rounded-xl border border-white/10 h-32 text-white resize-none" />
                    </div>
                    <button type="submit" className="w-full bg-brand-gold py-5 text-black font-black uppercase text-xs tracking-[0.2em] rounded-xl shadow-2xl hover)}

            {/* Gallery Grid */}
            {artPieces.length === 0 && !loading ? (
                <div className="text-center py-32 flex flex-col items-center justify-center glass-panel rounded-3xl border-dashed border-2 border-white/5 opacity-30">
                    <div className="text-7xl mb-6">ðŸ”’</div>
                    <span className="text-3xl font-display font-black text-white uppercase tracking-widest">Inventory Depleted</span>
                    <p className="mt-4 text-neutral-500 font-mono text-xs uppercase">Check back for fresh asset drops</p>
                </div>
            )="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12">
                    {artPieces.map(art => (
                        <div key={art.id} className="flex flex-col group relative overflow-visible h-full">
                            
                            {/* Delete Button - Admin Only */}
                            <div className="absolute top-2 right-2 z-[9999] pointer-events-none">
                                {currentUser.isAdmin && (
                                    <button 
                                        type="button"
                                        onClick={(e) => handleDelete(e, art.id)}
                                        className="pointer-events-auto p-3 bg-black hover:bg-brand-red text-neutral-500 hover:text-white rounded-xl transition-all border border-white/10 shadow-2xl cursor-pointer active:scale-95"
                                        title="Purge Record"
                                    >
                                        <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}>
                                            <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                )}
                            </div>

                            <div className="flex-1 flex flex-col relative">
                                <div className="relative p-6 transition-all duration-700 group-hover:scale-[1.01]">
                                    {/* Frame Styling */}
                                    <div className="absolute inset-0 bg-neutral-900 shadow-[10px_10px_40px_rgba(0,0,0,0.8)] rounded-sm group-hover:bg-neutral-800 transition-colors"></div> 
                                    <div className="absolute inset-1.5 border border-neutral-700 rounded-sm"></div>
                                    <div className="absolute inset-6 bg-black shadow-[inset_0_0_30px_rgba(0,0,0,1)]"></div>

                                    {/* Asset Media */}
                                    <div className="relative aspect-[4/5] bg-neutral-950 overflow-hidden flex items-center justify-center border border-neutral-800/50">
                                        <img 
                                            src={art.imageUrl} 
                                            alt={art.title} 
                                            className="w-full h-full object-cover transform transition-transform duration-[1500ms] group-hover:scale-110"
                                        />
                                        
                                        {/* Expiry Timer */}
                                        <div className="absolute top-3 left-3 z-20">
                                            <TimerDisplay expiresAt={art.expiresAt} onExpire={loadArt} />
                                        </div>

                                        {/* Instruction Overlay */}
                                        <div className="absolute bottom-4 inset-x-4 bg-black/90 backdrop-blur-md p-3 border border-white/10 rounded-lg translate-y-2 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-500">
                                            <p className="text-[10px] font-bold text-emerald-400 text-center uppercase tracking-widest">Message Council to Secure</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-4 px-4 text-center pb-6">
                                    <h3 className="text-xl font-display font-bold text-white uppercase tracking-tighter mb-1 truncate">{art.title}</h3>
                                    <div className="flex justify-center items-center gap-4 border-t border-white/5 pt-3 mb-2">
                                        <p className="text-brand-gold font-mono text-[9px] uppercase tracking-widest opacity-80">ARTIST: {art.studentArtistId}</p>
                                        <div className="h-1 w-1 bg-neutral-700 rounded-full"></div>
                                        <span className="text-white font-mono font-black text-xs">{art.price} PTS</span>
                                    </div>
                                    <p className="text-[10px] text-neutral-500 font-light line-clamp-2 italic px-2">
                                        {art.description || "Intelligence encrypted."}
                                    </p>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

</script>

<script type="module-shim" data-module="./components/FocusRealm.js">
import React, { useState, useEffect, useRef } from 'react';
import { User } from '../types';
import { storage } from '../services/storageService';
import { POINT_VALUES } from '../constants';



const FocusRealm: React.FC<FocusRealmProps> = ({ currentUser, onActivity }) => {
    const [mode, setMode] = useState('timer');
    const [isActive, setIsActive] = useState(false);
    const [seconds, setSeconds] = useState(0);
    const [initialTime, setInitialTime] = useState(25 * 60); // Default 25 min for Pomodoro
    const [sessionPoints, setSessionPoints] = useState(0);
    const [leaderboard, setLeaderboard] = useState([]);

    const intervalRef = useRef(null);

    // Initialize Timer
    useEffect(() => {
        if (mode === 'timer') setSeconds(initialTime);
        else setSeconds(0);
        setIsActive(false);
    }, [mode, initialTime]);

    // Load Leaderboard
    useEffect(() => {
        const loadLeaderboard = async () => {
            const users = await storage.getAllUsers();
            // Filter guests out of leaderboard
            setLeaderboard(users.filter(u => !u.isGuest).sort((a,b) => (b.stats.minutesStudied || 0) - (a.stats.minutesStudied || 0)).slice(0, 5));
        };
        loadLeaderboard();
    }, [isActive]); // Refresh when session ends

    // Timer Logic
    useEffect(() => {
        if (isActive) {
            intervalRef.current = window.setInterval(() => {
                if (mode === 'stopwatch') {
                    setSeconds(s => s + 1);
                } else {
                    setSeconds(s => {
                        if (s <= 1) {
                            completeSession(initialTime); // Finished Countdown
                            return 0;
                        }
                        return s - 1;
                    });
                }
            }, 1000);
        } else if (intervalRef.current) {
            clearInterval(intervalRef.current);
            intervalRef.current = null;
        }
        return () => {
            if (intervalRef.current) {
                clearInterval(intervalRef.current);
                intervalRef.current = null;
            }
        };
    }, [isActive, mode, initialTime]);

    // Calculate pending points
    useEffect(() => {
        let minutes = 0;
        if (mode === 'stopwatch') {
            minutes = Math.floor(seconds / 60);
        } else {
            minutes = Math.floor((initialTime - seconds) / 60);
        }
        setSessionPoints(minutes * POINT_VALUES.STUDY_MINUTE);
    }, [seconds, mode, initialTime]);

    const toggleTimer = () => {
        if (currentUser.isGuest) {
            alert("ACCESS DENIED) to access.");
            return;
        }
        setIsActive(!isActive);
    };

    const stopSession = () => {
        if (mode === 'stopwatch') {
            completeSession(seconds);
        } else {
            // If timer manually stopped, grant partial points? 
            // Let's grant partial points for time elapsed.
            const elapsed = initialTime - seconds;
            completeSession(elapsed);
        }
    };

    const completeSession = async (durationSecs) => {
        setIsActive(false);
        if (intervalRef.current) {
            clearInterval(intervalRef.current);
            intervalRef.current = null;
        }

        const minutes = Math.floor(durationSecs / 60);
        if (minutes < 1) {
            if (mode === 'timer' && seconds === 0) {
                 // Full timer done but was short?
            } else {
                setSeconds(mode === 'timer' ? initialTime);
                return; // Less than 1 min, no points
            }
        }

        const pointsEarned = minutes * POINT_VALUES.STUDY_MINUTE;
        
        if (pointsEarned > 0) {
            const freshUser = await storage.getUser(currentUser.studentId);
            if (freshUser) {
                const updatedUser = {
                    ...freshUser,
                    totalPoints,
                    stats,
                        minutesStudied) + minutes
                    }
                };
                await storage.saveUser(updatedUser);
                onActivity();
                alert(`SESSION COMPLETE);
            }
        }
        
        setSeconds(mode === 'timer' ? initialTime);
    };

    const formatTime = (totalSeconds) => {
        const m = Math.floor(totalSeconds / 60);
        const s = totalSeconds % 60;
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    };

    return (
        <div className="pb-32 grid grid-cols-1 lg:grid-cols-3 gap-8 animate-in fade-in duration-700">
            
            {/* Main Timer Area */}
            <div className="lg:col-span-2 space-y-8">
                <div className="glass-panel p-10 rounded-3xl text-center relative overflow-hidden border border-white/10">
                    <div className="absolute inset-0 bg-gradient-to-br from-brand-deepRed/20 via-transparent to-transparent pointer-events-none"></div>
                    
                    {/* Visual Core */}
                    <div className="relative w-64 h-64 mx-auto mb-10 flex items-center justify-center">
                        <div className={`absolute inset-0 rounded-full border-2 border-brand-red/20 ${isActive ? 'animate-ping opacity-20' : ''}`}></div>
                        <div className={`absolute inset-4 rounded-full border border-brand-red/40 ${isActive ? 'animate-spin opacity-40' : ''}`} style={{animationDuration: '10s'}}></div>
                        <div className={`w-48 h-48 rounded-full bg-gradient-to-br from-neutral-900 to-black border-4 border-brand-red shadow-[0_0_50px_rgba(217,35,35,0.2)] flex items-center justify-center z-10 transition-all duration-1000 ${isActive ? 'shadow-[0_0_80px_rgba(217,35,35,0.6)] scale-105' : ''}`}>
                             <span className="text-6xl font-mono font-bold text-white tracking-wider">{formatTime(seconds)}</span>
                        </div>
                    </div>

                    <div className="flex justify-center gap-4 mb-8">
                        <button 
                            onClick={() => { setIsActive(false); setMode('timer'); }}
                            className={`px-6 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-all ${mode === 'timer' ? 'bg-white text-black' : 'text-neutral-500 hover:text-white'}`}
                        >
                            Timer
                        </button>
                        <button 
                            onClick={() => { setIsActive(false); setMode('stopwatch'); }}
                            className={`px-6 py-2 rounded-full text-xs font-bold uppercase tracking-widest transition-all ${mode === 'stopwatch' ? 'bg-white text-black' : 'text-neutral-500 hover:text-white'}`}
                        >
                            Stopwatch
                        </button>
                    </div>

                    {mode === 'timer' && !isActive && (
                        <div className="flex justify-center gap-2 mb-8">
                             {[15, 25, 45, 60].map(m => (
                                 <button 
                                    key={m}
                                    onClick={() => { setInitialTime(m*60); setSeconds(m*60); }}
                                    className={`w-12 h-12 rounded-full border border-white/10 text-xs font-mono hover:border-brand-red hover:text-brand-red transition-all ${initialTime === m*60 ? 'border-brand-red text-brand-red bg-brand-red/10' : 'text-neutral-500'}`}
                                 >
                                     {m}
                                 </button>
                             ))}
                        </div>
                    )}

                    <div className="flex justify-center gap-6">
                        {currentUser.isGuest ? (
                             <button 
                                disabled
                                className="px-12 py-4 rounded-xl font-bold uppercase tracking-[0.2em] bg-neutral-900 text-neutral-600 border border-neutral-800 cursor-not-allowed"
                             >
                                Guest Restricted
                             </button>
                        )={toggleTimer}
                                    className={`px-12 py-4 rounded-xl font-bold uppercase tracking-[0.2em] transition-all shadow-xl ${
                                        isActive 
                                        ? 'bg-neutral-800 text-neutral-400 border border-neutral-700 hover:text-white' 
                                        : 'bg-brand-red text-white hover:bg-white hover:text-black shadow-brand-red/30'
                                    }`}
                                >
                                    {isActive ? 'Pause' : 'Start Focus'}
                                </button>
                                {isActive && (
                                    <button 
                                        onClick={stopSession}
                                        className="px-8 py-4 rounded-xl font-bold uppercase tracking-[0.2em] border border-red-500 text-red-500 hover)}
                            </>
                        )}
                    </div>
                    
                    {isActive && (
                        <div className="mt-8 text-brand-gold font-mono text-xs uppercase tracking-widest animate-pulse">
                            Gaining +{sessionPoints} Points
                        </div>
                    )}
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                    <div className="glass-panel p-6 rounded-2xl border border-white/5">
                        <p className="text-neutral-500 text-[10px] uppercase tracking-widest mb-2">My Total Focus</p>
                        <p className="text-3xl font-display font-bold text-white">
                            {Math.floor((currentUser.stats.minutesStudied || 0) / 60)}<span className="text-sm text-neutral-500 ml-1">h</span> {(currentUser.stats.minutesStudied || 0) % 60}<span className="text-sm text-neutral-500 ml-1">m</span>
                        </p>
                    </div>
                    <div className="glass-panel p-6 rounded-2xl border border-white/5">
                        <p className="text-neutral-500 text-[10px] uppercase tracking-widest mb-2">Earned Today</p>
                        <p className="text-3xl font-display font-bold text-brand-gold">
                            +{sessionPoints}
                        </p>
                    </div>
                </div>
            </div>

            {/* Leaderboard Panel */}
            <div className="lg:col-span-1 glass-panel rounded-2xl p-6 border border-white/5 h-fit">
                <div className="flex items-center gap-3 mb-6 pb-4 border-b border-white/5">
                    <div className="w-8 h-8 rounded bg-brand-gold/10 flex items-center justify-center text-brand-gold">âš¡</div>
                    <h3 className="font-bold text-white uppercase tracking-widest text-sm">Top Focused</h3>
                </div>

                <div className="space-y-4">
                    {leaderboard.map((u, i) => (
                        <div key={u.studentId} className="flex items-center gap-4 group">
                             <div className={`w-6 h-6 rounded flex items-center justify-center font-mono text-xs font-bold ${i===0 ? 'bg-brand-gold text-black' : 'bg-neutral-800 text-neutral-500'}`}>
                                 {i + 1}
                             </div>
                             <div className="flex-1">
                                 <div className="text-sm font-bold text-neutral-300 group-hover:text-white">{u.username}</div>
                                 <div className="text-[10px] text-neutral-600 font-mono">{Math.floor((u.stats.minutesStudied || 0)/60)}h {(u.stats.minutesStudied||0)%60}m</div>
                             </div>
                             {i === 0 && <span className="text-lg">ðŸ‘‘</span>}
                        </div>
                    ))}
                    {leaderboard.length === 0 && <div className="text-neutral-600 text-xs italic">No data available</div>}
                </div>
            </div>
        </div>
    );
};

export default FocusRealm;
</script>

<script type="module-shim" data-module="./components/Portfolio.js">

import React, { useRef, useEffect, useState } from 'react';



// Helper component to handle media loading errors gracefully
const CampaignMedia = ({ src, type, className, alt, ...props }: any) => {
    const [imgSrc, setImgSrc] = useState(src);
    const [hasError, setHasError] = useState(false);
    
    useEffect(() => { 
        setImgSrc(src); 
        setHasError(false);
    }, [src]);
    
    const handleError = () => {
        if (!hasError) {
            setHasError(true);
            const placeholderText = (alt || 'Asset Offline').toUpperCase();
            setImgSrc(`https://placehold.co/800x800/0a0a0a/333/png?text=${encodeURIComponent(placeholderText)}`);
        }
    };

    return (
        <img 
            src={imgSrc} 
            alt={alt || 'Campaign Media'}
            className={className} 
            onError={handleError}
            {...props} 
        />
    );
};

const PopulationScanner = () => {
  const canvasRef = useRef(null);
  
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    let animationFrameId: number;
    let startTime = Date.now();
    
    // Grid config: 60 cols * 50 rows = 3000 dots
    const cols = 60;
    const rows = 50; 
    
    const resize = () => {
        const parent = canvas.parentElement;
        if(parent) {
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientWidth * 0.7; // 10);
    window.addEventListener('resize', resize);

    const render = () => {
        const now = Date.now();
        const cycle = 8000; // 8 seconds total loop
        const t = (now - startTime) % cycle;
        
        // Phases
        // 0 - 3500ms)
        // 3500 - 5500ms)
        // 5500 - 8000ms)
        
        const w = canvas.width;
        const h = canvas.height;
        const paddingX = w * 0.05;
        const paddingY = h * 0.05;
        const availableW = w - paddingX * 2;
        const availableH = h - paddingY * 2;
        
        const dotW = availableW / cols;
        const dotH = availableH / rows;
        const radius = Math.min(dotW, dotH) * 0.35;

        // Clear
        ctx.fillStyle = '#050505';
        ctx.fillRect(0, 0, w, h);

        const centerX = Math.floor(cols / 2);
        const centerY = Math.floor(rows / 2);

        // Scanline position (0 to 1)
        let scanProgress = 0;
        if (t > 3500 && t < 5500) {
            scanProgress = (t - 3500) / 2000;
        } else if (t >= 5500) {
            scanProgress = 1; // Completed
        }

        for (let i = 0; i < cols; i++) {
            for (let j = 0; j < rows; j++) {
                const x = paddingX + i * dotW + dotW/2;
                const y = paddingY + j * dotH + dotH/2;
                
                const isTarget = i === centerX && j === centerY;
                
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);

                if (t < 3500) {
                    // ISOLATED PHASE
                    if (isTarget) {
                        const pulse = Math.sin(now / 200) * 0.5 + 0.5; // 0 to 1
                        ctx.fillStyle = `rgba(217, 35, 35, ${0.5 + pulse * 0.5})`; // Brand Red
                        ctx.shadowBlur = 10 * pulse;
                        ctx.shadowColor = '#d92323';
                    } else {
                        ctx.fillStyle = '#1a1a1a'; // Very dark grey
                        ctx.shadowBlur = 0;
                    }
                } else {
                    // SCAN/INTEGRATED PHASE
                    // Calculate scanline Y
                    const scanY = paddingY + scanProgress * availableH;
                    
                    if (y < scanY) {
                        // Already Scanned -> Turn Gold
                        // Ripple effect based on distance from center for 'Integrated' feel
                        if (t >= 5500) {
                             const dist = Math.sqrt(Math.pow(i - centerX, 2) + Math.pow(j - centerY, 2));
                             const wave = Math.sin(dist * 0.2 - (now / 200)) * 0.3 + 0.7;
                             ctx.fillStyle = `rgba(226, 177, 91, ${wave})`; // Brand Gold
                        } else {
                             ctx.fillStyle = '#e2b15b';
                        }
                        ctx.shadowBlur = 0;
                    } else if (y >= scanY && y < scanY + dotH * 2) {
                        // The Scanline itself
                        ctx.fillStyle = '#ffffff';
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = '#ffffff';
                    } else {
                         // Not yet scanned
                         if (isTarget) {
                            ctx.fillStyle = '#d92323';
                         } else {
                            ctx.fillStyle = '#1a1a1a';
                         }
                    }
                }
                ctx.fill();
            }
        }
        
        // Text Overlay Logic (Drawing on Canvas for perf sync)
        ctx.font = `bold ${Math.max(12, w/40)}px "JetBrains Mono"`;
        ctx.textAlign = 'right';
        ctx.textBaseline = 'bottom';
        
        if (t < 3500) {
             ctx.fillStyle = '#d92323';
             ctx.fillText('SIGNAL)', w - 20, h - 20);
        } else if (t < 5500) {
             ctx.fillStyle = '#ffffff';
             ctx.fillText('PROTOCOL, w - 20, h - 20);
        } else {
             ctx.fillStyle = '#e2b15b';
             ctx.fillText('IMPACT)', w - 20, h - 20);
        }
        
        // Count
        ctx.textAlign = 'left';
        ctx.fillStyle = '#333';
        ctx.fillText('STUDENTS,000', 20, h - 20);

        animationFrameId = requestAnimationFrame(render);
    };

    render();

    return () => {
        window.removeEventListener('resize', resize);
        cancelAnimationFrame(animationFrameId);
    };
  }, []);

  return <canvas ref={canvasRef} className="w-full h-auto rounded-2xl border border-white/10 bg-black shadow-2xl" />;
}

export default function Portfolio({ onEnterSystem }: PortfolioProps) {
  
  const journeyItems = [
    {
      id,
      src,
      title,
      subtitle,
      quote, imagine how hard I'll fight for you.\"",
      context,
      align,
    {
      id,
      src,
      title,
      subtitle,
      quote,
      context,
      align,
    {
      id,
      src,
      title,
      subtitle,
      quote, I document, I create. My work is a testament to the depth of thought I bring to the table.\"",
      context,
      align,
    {
      id,
      src,
      title,
      subtitle,
      quote,
      description, I was honoured to serve Standard Bearer for West Yorkshire. Carrying the flag is more than a ceremony; it is a pledge of duty, respect, and unwavering service to our county.",
      context,
      align: "left"
    }
  ];

  return (
    <div className="min-h-screen bg-black text-white selection:bg-brand-red selection:text-white font-sans">
      {/* Hero Section */}
      <section className="relative min-h-[100dvh] flex flex-col items-center justify-center overflow-hidden px-6 py-20">
        <div className="absolute inset-0 z-0 bg-black">
          <div className="absolute inset-0">
             <img 
                src="https://raw.githubusercontent.com/Charm-Master/a7f3c9b3qhufg-sdrIGR9h9hh-323422x91q-tmpr4d2-assetsm02-static-001r82398r/refs/heads/main/i2.jpeg"
                className="w-full h-full object-cover opacity-60"
                alt="Campaign Hero"
             />
          </div>
          <div className="absolute inset-0 bg-gradient-to-b from-black/20 via-black/40 to-black z-10"></div>
        </div>

        <div className="relative z-20 text-center max-w-6xl animate-in fade-in slide-in-from-bottom-12 duration-1000 mt-auto mb-auto">
          <div className="mb-6 flex items-center justify-center gap-4">
             <div className="h-px w-8 md:w-16 bg-brand-red"></div>
             <h2 className="text-brand-red font-mono text-xs md,35,35,0.8)]">
                Vote Waris â€¢ Greenhead College
             </h2>
             <div className="h-px w-8 md:w-16 bg-brand-red"></div>
          </div>
          
          <h1 className="text-6xl sm:text-7xl md:text-9xl font-display font-black tracking-tighter mb-8 leading-[0.9] drop-shadow-xl relative break-words">
            <span className="text-white/30 backdrop-blur-[2px]">THE MAN <br/> BEHIND</span> <span className="text-brand-red">THE PLAN</span>
          </h1>
          
          <p className="max-w-xl mx-auto text-neutral-200 text-lg md:text-xl font-light mb-12 leading-relaxed drop-shadow-md mix-blend-screen px-4">
            Revolutionizing Greenhead College through the <strong className="text-white">Spades Protocol</strong>. 
            Gamified engagement. Real rewards. Student power.
          </p>

          <div className="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-6 w-full px-4">
            <button 
              onClick={() => document.getElementById('manifesto')?.scrollIntoView({ behavior)}
              className="w-full sm:w-auto px-8 py-4 border border-white/20 rounded-full hover:bg-white hover:text-black transition-all font-bold uppercase tracking-widest text-xs min-w-[200px] backdrop-blur-sm bg-black/20"
            >
              Why Vote Waris?
            </button>
            <button 
              onClick={onEnterSystem}
              className="w-full sm,35,35,0.4)] min-w-[200px] flex items-center justify-center gap-2"
            >
              <span>Enter System</span>
              <svg className="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
            </button>
          </div>
        </div>
        
         <div className="absolute bottom-6 left-1/2 -translate-x-1/2 animate-bounce opacity-50 hidden sm:block">
            <svg className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7-7-7" /></svg>
        </div>
      </section>

      {/* Campaign Call to Action Banner */}
      <div className="w-full py-16 md:py-24 border-y border-white/5 bg-neutral-900/10 relative overflow-hidden flex items-center justify-center group">
          <div className="absolute inset-0 bg-gradient-to-r from-transparent via-brand-red/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-1000"></div>
          <h2 className="text-4xl sm:text-6xl md:text-8xl font-display font-black tracking-tighter text-white uppercase italic relative z-10 transition-all duration-700 group-hover:scale-[1.02]">
            VOTE <span className="text-brand-red drop-shadow-[0_0_15px_rgba(217,35,35,0.5)]">WARIS</span> 2026.
          </h2>
          <div className="absolute top-1/2 left-0 right-0 h-px bg-white/5 -translate-y-1/2 pointer-events-none"></div>
      </div>

      {/* Manifesto Section */}
      <section id="manifesto" className="py-32 px-6 max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-20 items-center">
        <div className="space-y-10 order-2 md:order-1">
            <div className="inline-block border border-brand-red/30 bg-brand-red/5 px-4 py-2 rounded uppercase font-bold text-xs tracking-widest text-brand-red mb-2">
                Candidate Profile
            </div>
            <h2 className="text-5xl md:text-7xl font-display font-black leading-[0.9]">
              NOT JUST A <br/> <span className="text-neutral-600">CANDIDATE.</span>
            </h2>
            <div className="space-y-6 text-lg text-neutral-400 font-light leading-relaxed">
              <p>
                I am <strong className="text-white">Waris Taj Rattan Singh Dhaliwal</strong>. 
              </p>
              <p>
                I am a developer, a strategist, a published author, and a student who believes Greenhead College deserves a digital revolution. 
                Traditional campaigns are built on posters. This campaign is built on <strong>code</strong>.
              </p>
              <p>
                The <strong>Spades Protocol</strong> is more than a platformâ€”it's a promise. A promise that your engagement 
                matters, your voice is counted, and your effort is rewarded.
              </p>
            </div>
            
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 pt-4">
              <div className="p-6 border-l-2 border-brand-red bg-neutral-900/20 backdrop-blur-sm">
                <div className="text-brand-red font-mono text-xs uppercase tracking-widest mb-2 font-bold">The Goal</div>
                <p className="text-sm text-neutral-300">To replace empty speeches with a working app. A system where you can vote, earn points, and actually lead.</p>
              </div>
              <div className="p-6 border-l-2 border-brand-gold bg-neutral-900/20 backdrop-blur-sm">
                <div className="text-brand-gold font-mono text-xs uppercase tracking-widest mb-2 font-bold">The Method</div>
                <p className="text-sm text-neutral-300">Simple. You log in, you study to earn rank, and you use your rank to vote on real college changes.</p>
              </div>
            </div>
        </div>
        
        <div className="relative group order-1 md:order-2">
            <div className="absolute inset-0 bg-brand-red/10 blur-[100px] rounded-full group-hover:bg-brand-red/20 transition-all duration-1000"></div>
            
            <div className="relative z-10 rounded-3xl overflow-hidden border border-white/10 shadow-2xl bg-black">
               <CampaignMedia 
                 src="https://raw.githubusercontent.com/Charm-Master/a7f3c9b3qhufg-sdrIGR9h9hh-323422x91q-tmpr4d2-assetsm02-static-001r82398r/refs/heads/main/v2.jfif" 
                 className="w-full h-auto block" 
                 alt="Candidate Portrait" 
               />
               <div className="absolute bottom-6 left-6 right-6 p-4 bg-black/80 backdrop-blur-md border border-white/10 rounded-xl flex items-center justify-between">
                  <div>
                    <div className="text-white font-bold uppercase tracking-wider text-sm">Vote Spades</div>
                    <div className="text-brand-gold font-mono text-[10px]">Election ID: #S253456</div>
                  </div>
                  <div className="text-2xl">â™ </div>
               </div>
            </div>
        </div>
      </section>

      {/* The Calculus of Power Section (Rebuilt) */}
      <section className="py-24 bg-[#030303] border-y border-white/5 relative overflow-hidden">
         <div className="absolute inset-0 bg-[url('https)] opacity-5"></div>
         
         <div className="max-w-7xl mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-16 items-center">
            
            {/* Left: Calculation Text */}
            <div className="relative z-10 space-y-10 order-2 md:order-1">
                <div className="border-l-4 border-brand-red pl-8 py-2">
                    <h2 className="text-4xl md,500 IN THE YEAR. <br/>
                        <span className="text-neutral-600">3,000 IN THE COLLEGE.</span>
                    </h2>
                </div>
                
                <div className="space-y-6">
                    <div className="flex items-center gap-4">
                        <div className="bg-white/5 px-4 py-2 rounded-lg border border-white/10 font-mono text-xl text-white">
                            1 Ã· 3,000
                        </div>
                        <span className="text-neutral-500 text-lg">=</span>
                        <div className="bg-brand-red/10 px-4 py-2 rounded-lg border border-brand-red/30 font-mono text-xl text-brand-red font-bold">
                            0.03%
                        </div>
                    </div>
                    
                    <p className="text-2xl text-neutral-300 font-light leading-relaxed">
                        The current system limits your influence to 0.03%. <br/>
                        <span className="text-white font-bold">We change the equation.</span>
                    </p>
                </div>

                <div className="pt-6 border-t border-white/10">
                    <p className="text-neutral-400 text-sm leading-relaxed max-w-lg mb-6">
                         Through the <strong className="text-white">Spades Protocol</strong>, we don't just count your vote. We execute it.
                         We give you <strong className="text-brand-gold">100% Impact</strong>. We ensure your voice constitutes the command, not just a suggestion.
                    </p>
                    <div className="inline-flex items-center gap-3 text-brand-gold font-bold uppercase tracking-widest text-xs bg-brand-gold/10 px-4 py-2 rounded border border-brand-gold/20">
                        <span className="w-2 h-2 bg-brand-gold rounded-full animate-pulse"></span>
                        We guarantee the vote.
                    </div>
                </div>
            </div>

            {/* Right: Population Scanner Visualization */}
            <div className="relative z-10 order-1 md:order-2">
                 <div className="relative group cursor-crosshair">
                     <div className="absolute -inset-1 bg-gradient-to-r from-brand-red to-brand-gold opacity-20 blur-xl group-hover:opacity-40 transition-opacity duration-1000"></div>
                     <PopulationScanner />
                     <div className="absolute bottom-4 right-4 text-[10px] text-neutral-500 font-mono pointer-events-none">
                        LIVE POPULATION MATRIX
                     </div>
                 </div>
            </div>

         </div>
      </section>

      {/* The Pillars */}
      <section className="bg-[#050505] py-32 border-y border-white/5 relative overflow-hidden">
        <div className="absolute top-0 inset-x-0 h-px bg-gradient-to-r from-transparent via-brand-red/50 to-transparent"></div>
        
        <div className="max-w-7xl mx-auto px-6 relative z-10">
            <div className="text-center mb-20">
              <h3 className="font-mono text-brand-gold text-xs uppercase tracking-[0.5em] mb-4">Core Directives</h3>
              <h2 className="text-4xl md:text-5xl font-display font-black text-white">THE THREE PILLARS</h2>
            </div>
            
            <div className="grid grid-cols-1 md,
                    title, 
                    subtitle,
                    desc, cast your vote, and make change happen instantly.",
                    icon,
                  { 
                    id,
                    title, 
                    subtitle,
                    desc, climb the ranks, and unlock real privileges. Hard work pays off here.",
                    icon,
                  { 
                    id,
                    title, 
                    subtitle,
                    desc, trade resources, or showcase your art. It's a student-run economy built for students.",
                    icon, i) => (
                  <div key={i} className="group relative p-10 bg-[#0a0a0a] border border-white/5 rounded-3xl hover:border-brand-red/30 transition-all duration-500 hover:-translate-y-2">
                    <div className="absolute inset-0 bg-gradient-to-b from-brand-red/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-3xl"></div>
                    
                    <div className="relative z-10 flex flex-col items-center text-center">
                        <div className="w-16 h-16 rounded-2xl bg-black border border-white/10 flex items-center justify-center mb-8 group-hover,35,35,0.2)] transition-all">
                            <svg className="w-8 h-8 text-neutral-400 group-hover:text-brand-red transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d={pillar.icon} />
                            </svg>
                        </div>
                        
                        <div className="text-brand-red/50 font-mono text-6xl font-black absolute top-4 right-6 opacity-20 select-none">{pillar.id}</div>
                        
                        <h4 className="text-2xl font-bold mb-2 text-white">{pillar.title}</h4>
                        <p className="text-brand-gold font-mono text-xs uppercase tracking-widest mb-6">{pillar.subtitle}</p>
                        <p className="text-neutral-500 text-sm leading-relaxed">{pillar.desc}</p>
                    </div>
                  </div>
                ))}
            </div>
        </div>
      </section>

      {/* The Journey */}
      <section className="py-32 px-6 border-b border-white/5 bg-neutral-900/10">
          <div className="max-w-7xl mx-auto space-y-32">
             <div className="text-center mb-24">
                <h3 className="font-mono text-brand-gold text-xs uppercase tracking-[0.5em] mb-4">The Journey</h3>
                <h2 className="text-4xl md, index) => (
                 <div key={item.id} className={`flex flex-col md:flex-row items-center gap-12 md:gap-20 ${item.align === 'left' ? 'md:flex-row-reverse' : ''}`}>
                     
                     <div className="flex-1 space-y-8 text-center md:text-left">
                         <div className={`inline-flex items-center gap-2 px-3 py-1 rounded-full border border-white/10 bg-white/5 text-[10px] font-mono uppercase tracking-widest text-brand-gold ${item.align === 'left' ? 'md:flex-row-reverse' : ''}`}>
                             <span className="w-1.5 h-1.5 rounded-full bg-brand-red animate-pulse"></span>
                             {item.context}
                         </div>
                         
                         <h2 className="text-4xl md:text-6xl font-display font-black leading-[0.9] text-white">
                             {item.title}
                         </h2>
                         <h3 className="text-brand-red font-mono text-sm uppercase tracking-[0.3em] font-bold">
                             {item.subtitle}
                         </h3>
                         
                         <div className="relative p-6 md:p-0">
                             <span className="absolute top-0 left-0 text-6xl font-serif text-white/5 -translate-y-4 -translate-x-4">â€œ</span>
                             <p className="text-lg md).description && (
                                <p className="mt-6 text-sm md).description}
                                </p>
                             )}
                         </div>
                     </div>

                     <div className="flex-1 w-full max-w-lg md:max-w-none">
                         <div className="relative group rounded-2xl overflow-hidden border border-white/10 shadow-2xl bg-black">
                             <div className="absolute inset-0 bg-gradient-to-tr from-brand-red/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 z-20 pointer-events-none"></div>
                             <CampaignMedia 
                                src={item.src} 
                                alt={item.title}
                                className="w-full h-auto block transform transition-transform duration-1000 group-hover:scale-105"
                             />
                             <div className="absolute bottom-4 right-4 z-30 opacity-50 group-hover:opacity-100 transition-opacity">
                                 <svg className="w-8 h-8 text-white drop-shadow-md" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
                             </div>
                         </div>
                     </div>
                 </div>
             ))}
          </div>
      </section>

      {/* Call to Action */}
      <section className="py-40 text-center px-6 relative overflow-hidden">
         <div className="absolute inset-0 bg-[url('https)] opacity-20"></div>
         <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black"></div>
         
         <div className="relative z-10 max-w-4xl mx-auto">
             <h2 className="text-6xl md:text-9xl font-display font-black mb-12 text-white tracking-tighter">
                READY TO <br/> <span className="text-brand-red">ASCEND?</span>
             </h2>
             <p className="text-neutral-400 text-lg mb-12 max-w-2xl mx-auto">
                 The system is online. The rank hierarchy is established. <br/>
                 All that is missing is <strong>you</strong>.
             </p>
             <button 
               onClick={onEnterSystem}
               className="group relative px-16 py-6 bg-white text-black font-black uppercase tracking-[0.3em] text-sm hover:bg-brand-red hover:text-white transition-all transform hover:scale-105 overflow-hidden rounded-lg"
             >
               <span className="relative z-10">Initialize Protocol</span>
               <div className="absolute inset-0 bg-brand-red transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300 -z-0"></div>
             </button>
         </div>
      </section>

      <footer className="py-12 border-t border-white/5 bg-black">
        <div className="max-w-7xl mx-auto px-6 flex flex-col md);
}

</script>

<script type="module-shim" data-module="./components/Guide.js">
import React from 'react';
import { RANKS, POINT_VALUES } from '../constants';

const Guide: React.FC = () => {
    return (
        <div className="max-w-4xl mx-auto space-y-12 pb-32 animate-in fade-in duration-700">
             <div className="text-center py-12 relative">
                <div className="absolute inset-0 bg-gradient-to-b from-brand-red/5 to-transparent blur-3xl rounded-full opacity-20 pointer-events-none"></div>
                <h1 className="text-5xl md,255,255,0.1)]">SYSTEM GUIDE</h1>
                <p className="text-brand-gold font-mono text-xs uppercase tracking-[0.5em] font-bold bg-black/50 inline-block px-4 py-2 rounded-full border border-brand-gold/20">Protocol Manual v2.4</p>
            </div>

            {/* Introduction */}
            <div className="glass-panel p-10 rounded-3xl border border-white/10 bg-gradient-to-br from-neutral-900/80 to-black relative overflow-hidden group hover:border-brand-red/30 transition-colors duration-500">
                <div className="absolute top-0 right-0 w-32 h-32 bg-brand-red/10 blur-[80px] rounded-full group-hover:bg-brand-red/20 transition-all"></div>
                <h3 className="text-2xl font-bold text-white mb-6 uppercase tracking-widest text-center">Protocol Overview</h3>
                <p className="text-neutral-300 text-lg font-light leading-relaxed text-center max-w-3xl mx-auto">
                    Spades is a meritocratic ecosystem. It replaces popularity contests with <span className="text-white font-medium">verifiable effort</span>. 
                    You ascend by engaging with the system and demonstrating academic discipline.
                </p>
            </div>

            {/* Three Pillars */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="glass-panel p-8 rounded-3xl border border-white/10 bg-gradient-to-b from-brand-red/5 to-transparent text-center hover:transform hover:-translate-y-2 transition-all duration-300">
                    <div className="w-12 h-12 bg-brand-red/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-brand-red/20">
                         <span className="text-2xl">ðŸ—£ï¸</span>
                    </div>
                    <h3 className="text-brand-red font-bold uppercase tracking-widest text-xs mb-3">Pillar I</h3>
                    <h4 className="text-white font-bold text-xl mb-3">Your Voice</h4>
                    <p className="text-sm text-neutral-400 font-light leading-relaxed">Vote on proposals. The higher your rank, the heavier your vote.</p>
                </div>
                <div className="glass-panel p-8 rounded-3xl border border-white/10 bg-gradient-to-b from-brand-gold/5 to-transparent text-center hover:transform hover:-translate-y-2 transition-all duration-300">
                    <div className="w-12 h-12 bg-brand-gold/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-brand-gold/20">
                         <span className="text-2xl">ðŸ†</span>
                    </div>
                    <h3 className="text-brand-gold font-bold uppercase tracking-widest text-xs mb-3">Pillar II</h3>
                    <h4 className="text-white font-bold text-xl mb-3">Rewards</h4>
                    <p className="text-sm text-neutral-400 font-light leading-relaxed">Earn points for academic focus and civic duty. Points unlock power.</p>
                </div>
                <div className="glass-panel p-8 rounded-3xl border border-white/10 bg-gradient-to-b from-blue-500/5 to-transparent text-center hover:transform hover:-translate-y-2 transition-all duration-300">
                    <div className="w-12 h-12 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/20">
                         <span className="text-2xl">ðŸ¤</span>
                    </div>
                    <h3 className="text-blue-400 font-bold uppercase tracking-widest text-xs mb-3">Pillar III</h3>
                    <h4 className="text-white font-bold text-xl mb-3">Community</h4>
                    <p className="text-sm text-neutral-400 font-light leading-relaxed">Trade resources and engage in a student-run economy.</p>
                </div>
            </div>

            {/* Economy & Points */}
            <div className="glass-panel p-10 rounded-3xl border border-white/10">
                <h3 className="text-2xl font-bold text-white mb-8 uppercase tracking-widest flex items-center gap-3">
                    <span className="w-2 h-2 bg-brand-gold rounded-full animate-pulse"></span>
                    Economy & Influence
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                    <div>
                        <p className="text-neutral-400 text-sm mb-8 leading-relaxed">
                            The system is balanced to reward <strong>Academic Focus</strong> and <strong>Civic Participation</strong>. 
                            Creating content does not grant points; interacting with policy does.
                        </p>
                        <ul className="space-y-4">
                            <li className="flex justify-between items-center p-4 bg-white/5 rounded-xl border border-brand-gold/20 hover:bg-white/10 transition-colors">
                                <span className="text-white font-bold text-sm">Focus Realm (Studying)</span>
                                <span className="text-brand-gold font-mono font-bold text-sm">2 PTS / MIN</span>
                            </li>
                            <li className="flex justify-between items-center p-4 bg-white/5 rounded-xl border border-brand-gold/20 hover:bg-white/10 transition-colors">
                                <span className="text-white font-bold text-sm">Casting a Vote (Council)</span>
                                <span className="text-brand-gold font-mono font-bold text-sm">5 PTS</span>
                            </li>
                            <li className="flex justify-between items-center p-4 bg-white/5 rounded-xl border border-white/5 opacity-50">
                                <span className="text-neutral-500 text-sm">Posting Content</span>
                                <span className="text-neutral-600 font-mono text-sm">0 PTS</span>
                            </li>
                        </ul>
                    </div>
                    <div className="flex flex-col justify-center text-center p-8 bg-black/40 rounded-2xl border border-white/10 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-gold/20 via-brand-gold to-brand-gold/20"></div>
                        <div className="text-5xl mb-6">âš–ï¸</div>
                        <h4 className="text-white font-bold text-xl mb-2">Weighted Voting</h4>
                        <p className="text-xs text-neutral-400 mb-6 px-4">
                            Rank determines impact. A senior officer's vote outweighs a novice's.
                        </p>
                         <ul className="text-xs text-neutral-500 font-mono space-y-2">
                            <li className="flex justify-between px-4"><span>Student</span> <span className="text-white">1x Influence</span></li>
                            <li className="flex justify-between px-4"><span>Contributor</span> <span className="text-white">2x Influence</span></li>
                            <li className="flex justify-between px-4"><span>Scholar</span> <span className="text-white">5x Influence</span></li>
                            <li className="flex justify-between px-4 border-t border-white/10 pt-2 mt-2"><span className="text-brand-gold font-bold">COUNCIL</span> <span className="text-brand-gold font-bold">50x Influence</span></li>
                        </ul>
                    </div>
                </div>
            </div>

            {/* The Vault & Integrity Section */}
            <div className="glass-panel p-10 rounded-3xl border border-emerald-500/20 bg-gradient-to-br from-emerald-950/30 to-black">
                <div className="flex items-start gap-6">
                    <div className="p-4 bg-emerald-500/10 rounded-2xl border border-emerald-500/20 hidden md:block">
                        <svg className="w-8 h-8 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div>
                        <h3 className="text-2xl font-bold text-white mb-4 uppercase tracking-widest">The Vault & Academic Integrity</h3>
                        <p className="text-neutral-300 text-sm leading-relaxed mb-6">
                            The Vault allows students to purchase artwork and resources using points earned from studying. 
                            <br/><br/>
                            <strong className="text-emerald-400">WARNING, <span className="text-white underline decoration-emerald-500/50">study time is audited against real-world grades</span>. 
                        </p>
                        <div className="p-4 bg-black/40 border border-white/10 rounded-xl text-xs text-neutral-400 font-mono leading-relaxed">
                            <span className="text-red-400 font-bold mr-2">ANTI-FRAUD PROTOCOL) but their real-world grades do not reflect this effort, purchased Vault assets will be revoked and points reset. Fraudulent activity prevents artwork distribution.
                        </div>
                    </div>
                </div>
            </div>

            {/* Hierarchy */}
            <div className="glass-panel p-10 rounded-3xl border border-white/10">
                <div className="text-center mb-10">
                    <h3 className="text-2xl font-bold text-white uppercase tracking-widest mb-2">Rank Structure</h3>
                    <p className="text-brand-red text-xs font-mono uppercase tracking-[0.2em] font-bold">The Spades High Council: Jack â€¢ Queen â€¢ King â€¢ Ace</p>
                </div>
                <div className="grid grid-cols-2 md).map((rank) => (
                        <div key={rank.id} className={`p-5 rounded-2xl border flex flex-col items-center text-center hover, 'Qâ™ ', 'Kâ™ ', 'Aâ™ '].includes(rank.id) 
                            ? 'bg-brand-red/5 border-brand-red/30 shadow-[0_0_20px_rgba(217,35,35,0.1)]' 
                            : 'bg-black/40 border-white/5'
                        }`}>
                            <div className="text-3xl font-display font-bold text-white mb-3">{rank.id.replace('â™ ','')}</div>
                            <div className="text-[10px] text-brand-red uppercase font-bold mb-1 tracking-wider">{rank.tier}</div>
                            <div className="text-[9px] text-neutral-500 font-mono mb-2">{rank.minPoints} PTS</div>
                             <div className="text-[9px] text-brand-gold font-mono bg-brand-gold/10 px-2 py-0.5 rounded border border-brand-gold/20">Power))}
                </div>
            </div>

            {/* Focus Strategy */}
            <div className="glass-panel p-10 rounded-3xl border border-brand-red/20 bg-gradient-to-r from-brand-red/10 to-transparent">
                <h3 className="text-xl font-bold text-white mb-4">Acceleration Strategy</h3>
                <p className="text-neutral-300 text-sm leading-relaxed mb-6">
                    <strong>Focus is currency.</strong> The system is designed to accelerate those who utilize the Focus Realm. 
                    1 Hour of study equals 120 Points. This is the fastest path to the Council.
                </p>
            </div>
        </div>
    );
};

export default Guide;
</script>

<script type="module-shim" data-module="./components/Settings.js">
import React, { useState } from 'react';
import { User } from '../types';
import { storage } from '../services/storageService';



const Settings: React.FC<SettingsProps> = ({ currentUser, onUpdate }) => {
    const [passwords, setPasswords] = useState({ current, new, confirm);
    const [msg, setMsg] = useState({ text, type);

    const handlePasswordChange = async (e) => {
        e.preventDefault();
        setMsg({ text, type);

        if (passwords.new !== passwords.confirm) {
            setMsg({ text, type);
            return;
        }
        if (passwords.new.length < 8) {
            setMsg({ text, type);
            return;
        }
        
        // Verify current password (using the local user object for check, ideally verify with storage but sync issue might occur)
        if (currentUser.passwordHash !== passwords.current) {
            setMsg({ text, type);
            return;
        }

        await storage.updatePassword(currentUser.studentId, passwords.new);
        setMsg({ text, type);
        setPasswords({ current, new, confirm);
        onUpdate(); // Trigger refresh
    };

    return (
        <div className="max-w-2xl mx-auto space-y-8 pb-32 animate-in fade-in duration-700">
             <div className="text-center py-8">
                <h1 className="text-4xl font-display font-black text-white tracking-tight mb-2">SETTINGS</h1>
                <p className="text-brand-gold font-mono text-xs uppercase tracking-[0.4em]">Account Security</p>
            </div>

            <div className="glass-panel p-8 rounded-2xl border border-white/5">
                <h3 className="text-lg font-bold text-white mb-6 uppercase tracking-wider">Update Security Key</h3>
                <form onSubmit={handlePasswordChange} className="space-y-6">
                    <div>
                        <label className="block text-[10px] uppercase font-bold text-neutral-500 mb-2">Current Password</label>
                        <input 
                            type="password" 
                            value={passwords.current}
                            onChange={e => setPasswords({...passwords, current)}
                            className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-white focus:border-brand-red outline-none"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-[10px] uppercase font-bold text-neutral-500 mb-2">New Password</label>
                        <input 
                            type="password" 
                            value={passwords.new}
                            onChange={e => setPasswords({...passwords, new)}
                            className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-white focus:border-brand-red outline-none"
                            required
                        />
                    </div>
                    <div>
                        <label className="block text-[10px] uppercase font-bold text-neutral-500 mb-2">Confirm New Password</label>
                        <input 
                            type="password" 
                            value={passwords.confirm}
                            onChange={e => setPasswords({...passwords, confirm)}
                            className="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-white focus:border-brand-red outline-none"
                            required
                        />
                    </div>

                    {msg.text && (
                        <div className={`p-3 rounded text-xs font-bold uppercase ${msg.type === 'error' ? 'bg-red-900/20 text-red-500' : 'bg-emerald-900/20 text-emerald-500'}`}>
                            {msg.text}
                        </div>
                    )}

                    <button type="submit" className="px-8 py-3 bg-brand-red text-white font-bold uppercase tracking-widest text-xs rounded-lg hover:bg-red-600 transition-colors">
                        Update Key
                    </button>
                </form>
            </div>

            <div className="glass-panel p-8 rounded-2xl border border-white/5 opacity-50">
                 <h3 className="text-lg font-bold text-white mb-2 uppercase tracking-wider">System Info</h3>
                 <p className="text-sm text-neutral-400 font-mono">ID: {currentUser.studentId}</p>
                 <p className="text-sm text-neutral-400 font-mono">Rank: {currentUser.currentCard}</p>
                 <p className="text-sm text-neutral-400 font-mono">Joined).toLocaleDateString()}</p>
            </div>
        </div>
    );
};

export default Settings;
</script>

<script type="module-shim" data-module="./services/audioUtils.js">
import { Blob } from '@google/genai';

export function base64ToUint8Array(base64){
  const binaryString = atob(base64);
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  return bytes;
}

export function uint8ArrayToBase64(bytes){
  let binary = '';
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

export async function decodeAudioData(
  data,
  ctx,
  sampleRate,
  numChannels,
){
  const dataInt16 = new Int16Array(data.buffer);
  const frameCount = dataInt16.length / numChannels;
  const buffer = ctx.createBuffer(numChannels, frameCount, sampleRate);

  for (let channel = 0; channel < numChannels; channel++) {
    const channelData = buffer.getChannelData(channel);
    for (let i = 0; i < frameCount; i++) {
      channelData[i] = dataInt16[i * numChannels + channel] / 32768.0;
    }
  }
  return buffer;
}

export function createPcmBlob(data){
  const l = data.length;
  const int16 = new Int16Array(l);
  for (let i = 0; i < l; i++) {
    int16[i] = data[i] * 32768;
  }
  return {
    data)),
    mimeType: 'audio/pcm;rate=16000',
  };
}
</script>

<script type="module-shim" data-module="./services/storageService.js">

import { User, Post, ArtPiece, PurchaseLog, SystemSettings } from '../types';

const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

class StorageService {
  private get(key){
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item){
    localStorage.setItem(key, JSON.stringify(value));
    // Internal event to trigger update in same window
    window.dispatchEvent(new Event('storage_update'));
  }

  async getUser(studentId){
    await delay(30); 
    const users = this.get<Record<string, User>>('users') || {};
    return users[studentId] || null;
  }

  async userExists(studentId){
    const users = this.get<Record<string, User>>('users') || {};
    return !!users[studentId];
  }

  async saveUser(user){
    const users = this.get<Record<string, User>>('users') || {};
    users[user.studentId] = user;
    this.set('users', users);
  }

  async deleteUser(studentId){
    const users = this.get<Record<string, User>>('users') || {};
    delete users[studentId];
    this.set('users', users);
  }

  async updatePassword(studentId, newPass){
    const users = this.get<Record<string, User>>('users') || {};
    if (users[studentId]) {
      users[studentId].passwordHash = newPass;
      users[studentId].requiresPasswordChange = false;
      this.set('users', users);
    }
  }

  async updateUserStatus(studentId, updates){
    const users = this.get<Record<string, User>>('users') || {};
    if (users[studentId]) {
        users[studentId] = { ...users[studentId], ...updates };
        this.set('users', users);
    }
  }

  async getAllUsers(){
    const users = this.get<Record<string, User>>('users') || {};
    return Object.values(users);
  }

  async getPosts(){
    return this.get('posts') || [];
  }

  async savePost(post){
    const posts = this.get('posts') || [];
    const index = posts.findIndex(p => p.id === post.id);
    if (index >= 0) posts[index] = post;
    else posts.unshift(post);
    this.set('posts', posts);
  }

  async deletePost(postId){
    let posts = this.get('posts') || [];
    const updatedPosts = posts.filter(p => p.id !== postId);
    this.set('posts', updatedPosts);
  }

  async deleteComment(postId, commentId){
      let posts = this.get('posts') || [];
      const postIndex = posts.findIndex(p => p.id === postId);
      if (postIndex !== -1) {
          const post = posts[postIndex];
          if (post.comments) {
              const updatedComments = post.comments.filter(c => c.id !== commentId);
              const updatedPost = { ...post, comments: updatedComments };
              posts[postIndex] = updatedPost;
              this.set('posts', posts);
          }
      }
  }

  async getArtPieces(){
    return this.get('art_pieces') || [];
  }

  async uploadArt(art){
    const artPieces = this.get('art_pieces') || [];
    artPieces.unshift(art);
    this.set('art_pieces', artPieces);
  }
  
  async deleteArt(artId){
      let artPieces = this.get('art_pieces') || [];
      const updatedArt = artPieces.filter(a => a.id !== artId);
      this.set('art_pieces', updatedArt);
  }

  async purchaseArt(studentId, artId){ success: boolean; message: string }> {
      const users = this.get<Record<string, User>>('users') || {};
      const artPieces = this.get('art_pieces') || [];
      
      const user = users[studentId];
      const artIndex = artPieces.findIndex(a => a.id === artId);

      if (!user) return { success, message: "User identity not found in database." };
      if (artIndex === -1) return { success, message: "Asset record not found." };

      const art = artPieces[artIndex];

      if (art.ownerId) return { success, message) return { success, message: "Insufficient point balance for acquisition." };

      // Update User
      user.totalPoints -= art.price;
      user.inventory = [...(user.inventory || []), art.id];
      users[studentId] = user;

      // Update Art
      art.ownerId = user.studentId;
      art.ownerName = user.username;
      artPieces[artIndex] = art;

      // Persist
      this.set('users', users);
      this.set('art_pieces', artPieces);

      // Log for Ace
      const log: PurchaseLog = {
          id)}`,
          buyerId,
          buyerName,
          artId,
          artTitle,
          price,
          timestamp).toISOString(),
          delivered: false
      };
      
      const logs = this.get('purchase_logs') || [];
      logs.unshift(log);
      this.set('purchase_logs', logs);

      return { success, message){
      return this.get('purchase_logs') || [];
  }

  async markDelivered(logId){
    const logs = this.get('purchase_logs') || [];
    const index = logs.findIndex(l => l.id === logId);
    if (index !== -1) {
      logs[index].delivered = true;
      this.set('purchase_logs', logs);
    }
  }

  async getSettings(){
    return this.get('system_settings') || {
      minRankToPost,
      allowPublicSignups,
      allowGuestAccess,
      emergencyLockdown){
    const current = await this.getSettings();
    this.set('system_settings', { ...current, ...updates });
  }

  async init(){
    if (!localStorage.getItem('users')) {
      const admin: User = {
        studentId,
        username,
        passwordHash,
        currentRank,
        currentCard,
        totalPoints,
        joinDate).toISOString(),
        lastActive).toISOString(),
        yearGroup,
        house,
        stats, commentsCreated, votesGiven, resourcesShared, moderationsPerformed, minutesStudied,
        isAdmin,
        requiresPasswordChange,
        inventory, { [admin.studentId]: admin });
    }
    
    if (!localStorage.getItem('system_settings')) {
        this.set('system_settings', {
            minRankToPost,
            allowPublicSignups,
            allowGuestAccess,
            emergencyLockdown);
    }
  }
}

export const storage = new StorageService();

</script>

<script type="module-shim" data-module="./services/geminiService.js">

import { GoogleGenAI } from "@google/genai";

const apiKey = process.env.API_KEY || ''; 

/**
 * Sanitizes content by replacing profanity, slurs, and toxic language with hashtags.
 * Uses Gemini if available, otherwise falls back to a basic local filter.
 */
export const sanitizeContent = async (content)=> {
  if (!apiKey) {
    // Local fallback for basic profanity
    const badWords = ['fuck', 'shit', 'piss', 'cunt', 'nigger', 'faggot', 'retard', 'bastard', 'bitch', 'asshole', 'dick', 'pussy'];
    let sanitized = content;
    badWords.forEach(word => {
      const regex = new RegExp(`\\b${word}\\b`, 'gi');
      sanitized = sanitized.replace(regex, '#'.repeat(word.length));
    });
    return sanitized;
  }

  try {
    const ai = new GoogleGenAI({ apiKey });
    const model = 'gemini-3-flash-preview';
    
    const prompt = `
      You are a content filter for a high-security student platform.
      Your task is to take the provided text and replace EVERY instance of swearing, profanity, slurs, or highly toxic language with hashtags (#) of equal length to the word (e.g., "fuck" becomes "####").
      Do not change any other part of the sentence. Maintain original punctuation and casing for non-flagged words.
      
      Input Text: "${content}"
      
      Respond ONLY with the sanitized text string.
    `;

    const response = await ai.models.generateContent({
      model,
      contents,
    });
    
    return response.text?.trim() || content;

  } catch (error) {
    console.error("Gemini sanitization failed", error);
    return content; 
  }
};

export const checkContentSafety = async (content){ safe: boolean; reason=> {
  if (!apiKey) {
    return { safe: true };
  }

  try {
    const ai = new GoogleGenAI({ apiKey });
    const model = 'gemini-3-flash-preview';
    
    const prompt = `
      Analyze the following text for a student platform. 
      Check for, Explicit Threats of Violence, or Illegal content.
      Minor profanity will be handled by a different filter, so focus on high-severity risks.
      
      Text, "reason": string | null }
    `;

    const response = await ai.models.generateContent({
      model,
      contents,
    });
    
    const text = response.text;
    if (!text) return { safe: true };

    const cleanJson = text.replace(/```json/g, '').replace(/```/g, '').trim();
    return JSON.parse(cleanJson);

  } catch (error) {
    console.error("Gemini safety check failed", error);
    return { safe: true };
  }
};

</script>


<script type="module">
// ===== EMBEDDED IMAGES =====
const __images = {"/public/campaign/portrait.jpg": "data:image/jpeg;base64,PLACEHOLDERIMAGEFILE", "/public/campaign/action_1.jpg": "data:image/jpeg;base64,", "/public/campaign/action_2.jpg": "data:image/jpeg;base64,PLACEHOLDERIMAGEFILEPleasQ==", "/public/campaign/action_3.jpg": "data:image/jpeg;base64,"};

// Override fetch for image loading
const originalFetch = window.fetch;
window.fetch = function(url, options) {
    if (typeof url === 'string' && __images[url]) {
        return Promise.resolve(new Response(__images[url]));
    }
    return originalFetch(url, options);
};

// ===== MODULE LOADER =====
const modules = {};
const moduleCache = {};

// Collect all embedded modules
document.querySelectorAll('script[type="module-shim"]').forEach(script => {
    const modulePath = script.getAttribute('data-module');
    modules[modulePath] = script.textContent;
});

// Create a custom module loader
function loadModule(path) {
    // Normalize path
    if (path.startsWith('./') || path.startsWith('../')) {
        // Local module
        if (!path.endsWith('.js')) {
            // Try with .js extension
            if (modules[path + '.js']) {
                path = path + '.js';
            }
        }
        
        if (moduleCache[path]) {
            return moduleCache[path];
        }
        
        if (!modules[path]) {
            console.error('Module not found:', path);
            return {};
        }
        
        // Create a module scope
        const moduleExports = {};
        const moduleObject = { exports: moduleExports };
        
        try {
            // Transform the module code to work with our loader
            let code = modules[path];
            
            // Replace import statements with our loader calls
            code = code.replace(/import\s+(.+?)\s+from\s+['"](.+?)['"]/g, (match, imports, source) => {
                if (source.startsWith('./') || source.startsWith('../')) {
                    // Local import
                    return `const ${imports} = loadModule('${source}');`;
                } else {
                    // External import - keep as is
                    return match;
                }
            });
            
            // Replace export default with module.exports
            code = code.replace(/export\s+default\s+/, 'module.exports = ');
            
            // Replace named exports
            code = code.replace(/export\s+\{([^}]+)\}/g, (match, exports) => {
                const exportNames = exports.split(',').map(e => e.trim());
                return exportNames.map(name => `module.exports.${name} = ${name};`).join('\n');
            });
            
            code = code.replace(/export\s+(const|let|var|function|class)\s+(\w+)/g, (match, keyword, name) => {
                return `${keyword} ${name}`;
            });
            
            // Execute the module
            const func = new Function('module', 'exports', 'loadModule', 'require', code + '\nreturn module.exports;');
            const result = func(moduleObject, moduleExports, loadModule, loadModule);
            
            moduleCache[path] = result || moduleObject.exports;
            return moduleCache[path];
            
        } catch (error) {
            console.error('Error loading module:', path, error);
            return {};
        }
    }
    
    // External module - return empty object
    return {};
}

// Initialize the app
try {
    loadModule('./index.js');
} catch (error) {
    console.error('Failed to initialize app:', error);
}
</script>

</body>
</html>
