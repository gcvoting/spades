<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spades | Presidential Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              display: ['Outfit', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            colors: {
              brand: {
                obsidian: '#050505',
                charcoal: '#0a0a0a',
                card: '#121212',
                red: '#d92323',
                deepRed: '#500808',
                gold: '#e2b15b',
                goldDim: '#8a6d3b',
              }
            },
            animation: {
              'pulse-slow': 'pulse 8s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'float': 'float 10s ease-in-out infinite',
              'shine': 'shine 6s linear infinite',
              'shimmer': 'shimmer 3s ease-in-out infinite alternate',
              'glow': 'glow 4s ease-in-out infinite alternate',
            },
            keyframes: {
              float: {
                '0%, 100%': { transform: 'translateY(0)' },
                '50%': { transform: 'translateY(-15px)' },
              },
              shine: {
                '0%': { backgroundPosition: '200% center' },
                '100%': { backgroundPosition: '-200% center' },
              },
              shimmer: {
                '0%': { opacity: 0.5 },
                '100%': { opacity: 1 },
              },
              glow: {
                '0%': { boxShadow: '0 0 10px rgba(217, 35, 35, 0.1)' },
                '100%': { boxShadow: '0 0 30px rgba(217, 35, 35, 0.3), 0 0 15px rgba(226, 177, 91, 0.1)' }
              }
            }
          }
        }
      }
    </script>
    <style>
      body {
        background-color: #020202;
        color: #f5f5f5;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .cinematic-bg {
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        z-index: -1;
        background: radial-gradient(circle at 50% -20%, #1a0505 0%, #020202 50%);
        pointer-events: none;
      }
      .noise-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1;
        opacity: 0.04;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        pointer-events: none;
        mix-blend-mode: overlay;
      }
      ::-webkit-scrollbar { width: 4px; }
      ::-webkit-scrollbar-track { background: #020202; }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #d92323; }
      .glass-panel {
        background: rgba(10, 10, 10, 0.6);
        backdrop-filter: blur(24px) saturate(180%);
        -webkit-backdrop-filter: blur(24px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      }
      .gradient-text-gold {
        background: linear-gradient(135deg, #fceeb5 0%, #e2b15b 50%, #8a6d3b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .gradient-text-red {
        background: linear-gradient(135deg, #ff6b6b 0%, #d92323 50%, #500808 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar { width: 4px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
      .perspective-1000 { perspective: 1000px; }
      @keyframes wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.5); } }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom": "https://esm.sh/react-dom@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "@google/genai": "https://esm.sh/@google/genai@1.32.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "path": "https://esm.sh/path@^0.12.7",
    "vite": "https://esm.sh/vite@^7.3.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
</head>
<body>
    <div class="cinematic-bg"></div>
    <div class="noise-overlay"></div>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useCallback, useRef, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI, Modality, Type } from '@google/genai';

        /** --- CONSTANTS & TYPES --- **/
        const RANKS = {
          "2♠": { id: "2♠", name: "2 of Spades", minPoints: 0, maxPoints: 199, tier: "Prospect", permissions: ["view", "vote"], voteWeight: 1 },
          "3♠": { id: "3♠", name: "3 of Spades", minPoints: 200, maxPoints: 499, tier: "Student", permissions: ["view", "vote", "post", "comment"], voteWeight: 1 },
          "4♠": { id: "4♠", name: "4 of Spades", minPoints: 500, maxPoints: 999, tier: "Student", permissions: ["view", "vote", "post", "comment"], voteWeight: 1 },
          "5♠": { id: "5♠", name: "5 of Spades", minPoints: 1000, maxPoints: 2499, tier: "Student", permissions: ["view", "vote", "post", "comment"], voteWeight: 1 },
          "6♠": { id: "6♠", name: "6 of Spades", minPoints: 2500, maxPoints: 4999, tier: "Contributor", permissions: ["view", "vote", "post", "comment", "createPoll", "award"], voteWeight: 2 },
          "7♠": { id: "7♠", name: "7 of Spades", minPoints: 5000, maxPoints: 7999, tier: "Contributor", permissions: ["view", "vote", "post", "comment", "createPoll", "award"], voteWeight: 2 },
          "8♠": { id: "8♠", name: "8 of Spades", minPoints: 8000, maxPoints: 11999, tier: "Contributor", permissions: ["view", "vote", "post", "comment", "createPoll", "award"], voteWeight: 2 },
          "9♠": { id: "9♠", name: "9 of Spades", minPoints: 12000, maxPoints: 17999, tier: "Scholar", permissions: ["view", "vote", "post", "comment", "createPoll", "award", "submitPolicy", "studyGroups"], voteWeight: 5 },
          "10♠": { id: "10♠", name: "10 of Spades", minPoints: 18000, maxPoints: 24999, tier: "Scholar", permissions: ["view", "vote", "post", "comment", "createPoll", "award", "submitPolicy", "studyGroups"], voteWeight: 5 },
          "J♠": { id: "J♠", name: "Jack of Spades", minPoints: 25000, maxPoints: 34999, tier: "Voice", permissions: ["view", "vote", "post", "comment", "createPoll", "award", "submitPolicy", "studyGroups", "instantPost", "nominate"], voteWeight: 10 },
          "Q♠": { id: "Q♠", name: "Queen of Spades", minPoints: 35000, maxPoints: 49999, tier: "Advisor", permissions: ["view", "vote", "post", "comment", "createPoll", "award", "submitPolicy", "studyGroups", "instantPost", "nominate", "moderate", "messageCouncil"], voteWeight: 25 },
          "K♠": { id: "K♠", name: "King of Spades", minPoints: 50000, maxPoints: 74999, tier: "Council", permissions: ["view", "vote", "post", "comment", "createPoll", "award", "submitPolicy", "studyGroups", "instantPost", "nominate", "moderate", "messageCouncil", "messageAce", "createChallenge", "finalModeration"], voteWeight: 50 },
          "A♠": { id: "A♠", name: "Ace of Spades", minPoints: 75000, maxPoints: 9999999, tier: "President", permissions: ["all"], voteWeight: 100 }
        };

        const POINT_VALUES = { POST: 0, COMMENT: 0, VOTE_ACTION: 10, LOGIN: 5, STUDY_MINUTE: 2 };

        /** --- STORAGE SERVICE --- **/
        class StorageService {
          private get(key) { const item = localStorage.getItem(key); return item ? JSON.parse(item) : null; }
          private set(key, value) { localStorage.setItem(key, JSON.stringify(value)); window.dispatchEvent(new Event('storage_update')); }
          async getUser(id) { const users = this.get('users') || {}; return users[id] || null; }
          async userExists(id) { const users = this.get('users') || {}; return !!users[id]; }
          async saveUser(user) { const users = this.get('users') || {}; users[user.studentId] = user; this.set('users', users); }
          async deleteUser(id) { const users = this.get('users') || {}; delete users[id]; this.set('users', users); }
          async updatePassword(id, pass) { const users = this.get('users') || {}; if (users[id]) { users[id].passwordHash = pass; users[id].requiresPasswordChange = false; this.set('users', users); } }
          async updateUserStatus(id, updates) { const users = this.get('users') || {}; if (users[id]) { users[id] = { ...users[id], ...updates }; this.set('users', users); } }
          async getAllUsers() { const users = this.get('users') || {}; return Object.values(users); }
          async getPosts() { return this.get('posts') || []; }
          async savePost(post) { const posts = this.get('posts') || []; const index = posts.findIndex(p => p.id === post.id); if (index >= 0) posts[index] = post; else posts.unshift(post); this.set('posts', posts); }
          async deletePost(id) { let posts = this.get('posts') || []; this.set('posts', posts.filter(p => p.id !== id)); }
          async getArtPieces() { return this.get('art_pieces') || []; }
          async uploadArt(art) { const artPieces = this.get('art_pieces') || []; artPieces.unshift(art); this.set('art_pieces', artPieces); }
          async deleteArt(id) { let art = this.get('art_pieces') || []; this.set('art_pieces', art.filter(a => a.id !== id)); }
          async getPurchaseLogs() { return this.get('purchase_logs') || []; }
          async markDelivered(id) { let logs = this.get('purchase_logs') || []; const idx = logs.findIndex(l => l.id === id); if (idx > -1) { logs[idx].delivered = true; this.set('purchase_logs', logs); } }
          async getSettings() { return this.get('system_settings') || { minRankToPost: '2♠', allowGuestAccess: true }; }
          async updateSettings(updates) { const cur = await this.getSettings(); this.set('system_settings', { ...cur, ...updates }); }
          async init() {
            if (!localStorage.getItem('users')) {
              const admin = {
                studentId: 'S253456', username: 'Ace', passwordHash: 'ayanokoji', currentRank: 'Ace of Spades',
                currentCard: 'A♠', totalPoints: 1000000, joinDate: new Date().toISOString(), stats: { postsCreated: 0, commentsCreated: 0, votesGiven: 0, minutesStudied: 0 },
                isAdmin: true, requiresPasswordChange: true, inventory: []
              };
              this.set('users', { [admin.studentId]: admin });
            }
          }
        }
        const storage = new StorageService();

        /** --- GEMINI UTILS --- **/
        const sanitizeContent = async (content) => {
          try {
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            const response = await ai.models.generateContent({
              model: 'gemini-3-flash-preview',
              contents: `Replace slurs/profanity in: "${content}" with hashtags of matching length. Reply only with sanitized text.`
            });
            return response.text?.trim() || content;
          } catch { return content; }
        };

        /** --- AUDIO HELPERS --- **/
        function decodeBase64(b64) { const bs = atob(b64); const bt = new Uint8Array(bs.length); for (let i = 0; i < bs.length; i++) bt[i] = bs.charCodeAt(i); return bt; }
        async function decodeAudioData(data, ctx, sr, nc) {
          const d16 = new Int16Array(data.buffer); const fc = d16.length / nc; const buf = ctx.createBuffer(nc, fc, sr);
          for (let c = 0; c < nc; c++) { const cd = buf.getChannelData(c); for (let i = 0; i < fc; i++) cd[i] = d16[i * nc + c] / 32768.0; }
          return buf;
        }

        /** --- CORE COMPONENTS --- **/
        const CardVisual = ({ rankId, size = 'md', className = '' }) => {
          const sz = { sm: 'w-10 h-14 text-[10px] rounded', md: 'w-28 h-40 text-xl rounded-xl', lg: 'w-56 h-80 text-5xl rounded-2xl' };
          const v = rankId.replace('♠', ''); const isAce = v === 'A'; const isFace = ['J','Q','K'].includes(v);
          return (
            <div className={`relative bg-[#080808] border border-white/10 flex flex-col items-center justify-center font-display font-bold select-none shadow-2xl transition-all duration-500 overflow-hidden ${sz[size]} ${className} ${isAce ? 'border-brand-red/40' : isFace ? 'border-brand-gold/20' : ''}`}>
                <div className="absolute top-1 left-1.5 flex flex-col items-center leading-none"><span className={isAce ? 'text-brand-red' : isFace ? 'text-brand-gold' : ''}>{v}</span><span className="text-[0.5em] text-neutral-600">♠</span></div>
                <div className={`text-2xl transition-transform group-hover:scale-110 ${isAce ? 'text-brand-red scale-125' : isFace ? 'text-brand-gold' : 'text-neutral-800'}`}>♠</div>
                <div className="absolute bottom-1 right-1.5 flex flex-col items-center rotate-180 leading-none"><span className={isAce ? 'text-brand-red' : isFace ? 'text-brand-gold' : ''}>{v}</span><span className="text-[0.5em] text-neutral-600">♠</span></div>
            </div>
          );
        };

        const PopulationScanner = () => {
          const canvasRef = useRef(null);
          useEffect(() => {
            const canvas = canvasRef.current; if (!canvas) return; const ctx = canvas.getContext('2d'); let frame;
            const cols = 50, rows = 40;
            const resize = () => { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.width * 0.7; };
            resize(); window.addEventListener('resize', resize);
            const render = () => {
              const now = Date.now(); ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, canvas.width, canvas.height);
              for(let i=0; i<cols; i++) { for(let j=0; j<rows; j++) {
                const x = i * (canvas.width/cols) + (canvas.width/cols/2), y = j * (canvas.height/rows) + (canvas.height/rows/2);
                const dist = Math.sqrt(Math.pow(i-cols/2,2) + Math.pow(j-rows/2,2));
                const pulse = Math.sin(now/600 - dist/8) * 0.5 + 0.5;
                ctx.beginPath(); ctx.arc(x, y, 1.2, 0, Math.PI*2);
                ctx.fillStyle = i===Math.floor(cols/2) && j===Math.floor(rows/2) ? '#d92323' : `rgba(226, 177, 91, ${pulse * 0.15})`; ctx.fill();
              }}
              frame = requestAnimationFrame(render);
            }; render(); return () => { cancelAnimationFrame(frame); window.removeEventListener('resize', resize); };
          }, []);
          return <canvas ref={canvasRef} className="w-full h-auto rounded-3xl border border-white/5 bg-black shadow-2xl" />;
        };

        const TimerDisplay = ({ expiresAt }) => {
            const [tl, setTl] = useState('');
            useEffect(() => {
                const i = setInterval(() => {
                    const d = new Date(expiresAt).getTime() - Date.now();
                    if (d <= 0) setTl('EXPIRED');
                    else { const h = Math.floor(d/3600000); const m = Math.floor((d%3600000)/60000); setTl(`${h}h ${m}m`); }
                }, 1000); return () => clearInterval(i);
            }, [expiresAt]);
            return <div className="text-[10px] font-mono text-brand-red bg-black/80 px-2 py-1 rounded border border-brand-red/30">ENDS: {tl}</div>;
        };

        /** --- MAIN VIEWS --- **/
        const Portfolio = ({ onEnter }) => (
          <div className="min-h-screen bg-black text-white font-sans selection:bg-brand-red">
            <section className="relative h-screen flex flex-col items-center justify-center overflow-hidden">
                <div className="absolute inset-0">
                    <img src="https://images.unsplash.com/photo-1550751827-4bd374c3f58b?auto=format&fit=crop&q=80&w=2070" className="w-full h-full object-cover opacity-20 grayscale" />
                    <div className="absolute inset-0 bg-gradient-to-b from-black/10 via-black/50 to-black"></div>
                </div>
                <div className="relative z-10 text-center max-w-5xl px-6 animate-in fade-in slide-in-from-bottom-12 duration-1000">
                    <h2 className="text-brand-red font-mono text-xs uppercase tracking-[0.4em] font-bold mb-6">Vote Waris • Greenhead College</h2>
                    <h1 className="text-7xl md:text-9xl font-display font-black tracking-tighter mb-8 leading-[0.85]">THE MAN BEHIND <br/><span className="gradient-text-red">THE PLAN</span></h1>
                    <p className="text-xl text-neutral-400 mb-12 max-w-2xl mx-auto font-light">Revolutionizing engagement through the <strong className="text-white">Spades Protocol</strong>.</p>
                    <button onClick={onEnter} className="px-12 py-5 bg-brand-red rounded-full font-bold uppercase tracking-widest text-[10px] shadow-2xl shadow-brand-red/40 hover:scale-105 transition-all">Enter Protocol</button>
                </div>
            </section>
            <section className="py-32 px-6 max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-20 items-center">
                <div className="space-y-10">
                    <h2 className="text-6xl font-display font-black leading-[0.9]">NOT JUST A <br/><span className="text-neutral-700">CANDIDATE.</span></h2>
                    <p className="text-neutral-400 text-lg leading-relaxed font-light">I am a strategist, developer, and student who believes Greenhead deserves a digital revolution. Spades ensures your voice is a command.</p>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="p-6 bg-white/5 border border-white/10 rounded-2xl"><div className="text-brand-red font-mono text-[10px] uppercase mb-1">Impact</div><div className="text-3xl font-bold">100%</div></div>
                        <div className="p-6 bg-white/5 border border-white/10 rounded-2xl"><div className="text-brand-gold font-mono text-[10px] uppercase mb-1">Reach</div><div className="text-3xl font-bold">3,000</div></div>
                    </div>
                </div>
                <div className="relative group"><PopulationScanner /></div>
            </section>
          </div>
        );

        const DashboardView = ({ user }) => (
          <div className="space-y-8 pb-32 animate-in fade-in duration-700">
             <div className="flex justify-between items-end border-b border-white/5 pb-8">
                <div><h3 className="text-brand-red font-mono text-[10px] uppercase tracking-[0.4em] font-bold">Status: ONLINE</h3><h1 className="text-6xl font-display font-black tracking-tighter">{user.username}</h1></div>
                <div className="text-right text-xl font-bold font-display tracking-wide">{user.studentId}</div>
             </div>
             <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div className="lg:col-span-7 glass-panel p-10 rounded-[40px] flex gap-10 items-center border border-brand-red/10 relative overflow-hidden group">
                    <CardVisual rankId={user.currentCard} size="lg" className="shrink-0" />
                    <div className="space-y-4">
                        <div className="inline-block px-3 py-1 bg-brand-red/10 border border-brand-red/20 rounded-full text-[10px] text-brand-red font-black uppercase tracking-widest">{RANKS[user.currentCard].tier} Clearance</div>
                        <h2 className="text-4xl font-display font-black leading-tight">{user.currentRank}</h2>
                        <div className="h-1.5 bg-black rounded-full overflow-hidden border border-white/5 mt-4"><div className="h-full bg-brand-red shadow-[0_0_15px_rgba(217,35,35,0.6)] transition-all duration-1000" style={{ width: `${Math.min(100, (user.totalPoints/RANKS[user.currentCard].maxPoints)*100)}%` }}></div></div>
                    </div>
                </div>
                <div className="lg:col-span-5 grid grid-cols-2 gap-4">
                    <div className="glass-panel p-8 rounded-[32px] flex flex-col justify-between hover:bg-white/5 transition-all">
                        <i className="fas fa-fire text-brand-red text-xl"></i>
                        <div><p className="text-[10px] text-neutral-600 font-bold mb-1 uppercase tracking-widest">Impact</p><p className="text-4xl font-display font-black">{user.stats.postsCreated + user.stats.commentsCreated}</p></div>
                    </div>
                    <div className="glass-panel p-8 rounded-[32px] flex flex-col justify-between hover:bg-white/5 transition-all">
                        <i className="fas fa-bolt text-brand-gold text-xl"></i>
                        <div><p className="text-[10px] text-neutral-600 font-bold mb-1 uppercase tracking-widest">Influence</p><p className="text-4xl font-display font-black">{RANKS[user.currentCard].voteWeight}x</p></div>
                    </div>
                </div>
             </div>
          </div>
        );

        const ChatView = () => {
          const [messages, setMessages] = useState([]); const [input, setInput] = useState(''); const [thinking, setThinking] = useState(false); const [search, setSearch] = useState(false); const scrollRef = useRef(null);
          useEffect(() => { scrollRef.current?.scrollTo({ top: scrollRef.current.scrollHeight, behavior: 'smooth' }); }, [messages]);
          const handleSend = async () => {
             if (!input.trim() || thinking) return;
             const userMsg = { id: Date.now(), role: 'user', text: input, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) };
             setMessages(p => [...p, userMsg]); setInput(''); setThinking(true);
             try {
                const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                const config = search ? { tools: [{ googleSearch: {} }] } : {};
                const stream = await ai.models.generateContentStream({ model: 'gemini-3-flash-preview', contents: input, config });
                const modelId = Date.now() + 1;
                setMessages(p => [...p, { id: modelId, role: 'model', text: '', time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), urls: [] }]);
                let fullText = '';
                for await (const chunk of stream) {
                    fullText += chunk.text;
                    const urls = chunk.candidates?.[0]?.groundingMetadata?.groundingChunks?.filter(c=>c.web).map(c=>({ uri:c.web.uri, title:c.web.title })) || [];
                    setMessages(p => p.map(m => m.id === modelId ? { ...m, text: fullText, urls: [...(m.urls||[]), ...urls] } : m));
                }
             } catch (e) { console.error(e); } finally { setThinking(false); }
          };
          return (
            <div className="glass-panel h-[75vh] rounded-[48px] flex flex-col overflow-hidden border border-white/5 shadow-2xl">
                <div className="p-8 border-b border-white/5 flex items-center justify-between">
                    <h3 className="font-display font-bold text-lg tracking-tight flex items-center gap-3"><div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>Intelligence Uplink</h3>
                    <button onClick={()=>setSearch(!search)} className={`px-4 py-2 rounded-full text-[10px] font-bold uppercase transition-all ${search ? 'bg-emerald-500/20 text-emerald-500' : 'bg-white/5 text-neutral-500'}`}>Grounding {search ? 'ON' : 'OFF'}</button>
                </div>
                <div ref={scrollRef} className="flex-1 overflow-y-auto p-10 space-y-8 custom-scrollbar">
                    {messages.map(m => (
                        <div key={m.id} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                            <div className="max-w-[80%] space-y-2">
                                <div className={`p-6 rounded-[32px] text-sm leading-relaxed ${m.role === 'user' ? 'bg-brand-red text-white rounded-tr-none' : 'bg-white/5 text-neutral-300 rounded-tl-none border border-white/5'}`}>{m.text || 'Thinking...'}</div>
                                {m.urls?.length > 0 && <div className="flex gap-2">{m.urls.slice(0,2).map((u,i)=><a key={i} href={u.uri} target="_blank" className="text-[8px] text-brand-gold uppercase font-mono">Source {i+1}</a>)}</div>}
                            </div>
                        </div>
                    ))}
                </div>
                <div className="p-8 border-t border-white/5 flex gap-4 bg-black/30 backdrop-blur-md">
                    <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSend()} className="flex-1 bg-black/50 p-5 rounded-[24px] border border-white/5 outline-none focus:border-brand-red" placeholder="Enter transmission..." />
                    <button onClick={handleSend} className="bg-brand-red px-10 rounded-[24px] font-black uppercase text-[10px] tracking-widest hover:scale-95 transition-all">Transmit</button>
                </div>
            </div>
          );
        };

        const StudioView = () => {
          const [prompt, setPrompt] = useState(''); const [type, setType] = useState('image'); const [gallery, setGallery] = useState([]); const [genning, setGenning] = useState(false);
          const handleGen = async () => {
             if (!prompt.trim() || genning) return; setGenning(true);
             try {
                const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                if (type === 'image') {
                    const res = await ai.models.generateContent({ model: 'gemini-2.5-flash-image', contents: prompt, config: { imageConfig: { aspectRatio: "16:9" } } });
                    const part = res.candidates[0].content.parts.find(p => p.inlineData);
                    if (part) setGallery(p => [{ id: Date.now(), url: `data:image/png;base64,${part.inlineData.data}`, prompt, type: 'image' }, ...p]);
                } else {
                    if (!(await window.aistudio.hasSelectedApiKey())) { await window.aistudio.openSelectKey(); }
                    let op = await ai.models.generateVideos({ model: 'veo-3.1-fast-generate-preview', prompt, config: { numberOfVideos: 1, resolution: '720p', aspectRatio: '16:9' } });
                    while (!op.done) { await new Promise(r => setTimeout(r, 10000)); op = await ai.operations.getVideosOperation({ operation: op }); }
                    const dl = op.response?.generatedVideos?.[0]?.video?.uri;
                    if (dl) {
                       const res = await fetch(`${dl}&key=${process.env.API_KEY}`); const blob = await res.blob();
                       setGallery(p => [{ id: Date.now(), url: URL.createObjectURL(blob), prompt, type: 'video' }, ...p]);
                    }
                }
             } catch (e) { console.error(e); } finally { setGenning(false); setPrompt(''); }
          };
          return (
            <div className="space-y-10 pb-32">
                <div className="glass-panel p-12 rounded-[56px] border border-white/5 space-y-8 shadow-2xl relative overflow-hidden group">
                    <div className="flex justify-between items-center">
                        <h2 className="text-4xl font-display font-black italic tracking-tighter">Media Studio</h2>
                        <div className="flex p-1.5 glass rounded-2xl border border-white/5">
                            <button onClick={()=>setType('image')} className={`px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest ${type==='image' ? 'bg-brand-red text-white' : 'text-neutral-500'}`}>Image</button>
                            <button onClick={()=>setType('video')} className={`px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest ${type==='video' ? 'bg-brand-gold text-black' : 'text-neutral-500'}`}>Video (Veo)</button>
                        </div>
                    </div>
                    <textarea value={prompt} onChange={e=>setPrompt(e.target.value)} className="w-full bg-black/50 p-8 rounded-[32px] border border-white/10 h-32 outline-none focus:border-brand-red resize-none" placeholder="Describe your vision..." />
                    <button onClick={handleGen} disabled={genning} className={`w-full py-5 rounded-[24px] font-black uppercase tracking-[0.3em] text-[10px] transition-all ${genning ? 'bg-neutral-800' : 'bg-brand-red hover:scale-[1.01]'}`}>{genning ? 'Synthesizing...' : 'Generate Asset'}</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                    {gallery.map(i => (
                        <div key={i.id} className="glass-panel rounded-[40px] overflow-hidden border border-white/5 group relative shadow-2xl hover:-translate-y-2 transition-all">
                            {i.type === 'image' ? <img src={i.url} className="w-full aspect-video object-cover" /> : <video src={i.url} className="w-full aspect-video object-cover" controls />}
                            <div className="absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition-all p-8 flex flex-col justify-end">
                                <p className="text-[10px] italic text-neutral-300 mb-4 line-clamp-3">"{i.prompt}"</p>
                                <a href={i.url} download className="bg-white/10 p-3 rounded-full text-center text-[8px] font-black uppercase tracking-widest">Download Asset</a>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
          );
        };

        const LiveView = () => {
            const [isActive, setIsActive] = useState(false); const [status, setStatus] = useState('Disconnected');
            const sessionRef = useRef(null); const streamRef = useRef(null); const audioCtxRef = useRef(null);
            const start = async () => {
                setStatus('Connecting...');
                try {
                    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                    streamRef.current = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioCtxRef.current = new AudioContext({ sampleRate: 16000 });
                    const promise = ai.live.connect({
                        model: 'gemini-2.5-flash-native-audio-preview-09-2025',
                        callbacks: {
                            onopen: () => { setIsActive(true); setStatus('Link Established'); },
                            onmessage: async (msg) => {
                                const data = msg.serverContent?.modelTurn?.parts[0]?.inlineData?.data;
                                if (data) {
                                    const outCtx = new AudioContext({ sampleRate: 24000 });
                                    const buf = await decodeAudioData(decodeBase64(data), outCtx, 24000, 1);
                                    const src = outCtx.createBufferSource(); src.buffer = buf; src.connect(outCtx.destination); src.start();
                                }
                            },
                            onclose: () => { setIsActive(false); setStatus('Disconnected'); }
                        },
                        config: { responseModalities: [Modality.AUDIO] }
                    });
                    sessionRef.current = await promise;
                } catch (e) { setStatus('Error'); console.error(e); }
            };
            return (
                <div className="h-[65vh] flex flex-col items-center justify-center space-y-16 py-20 relative">
                    <div className="absolute inset-0 bg-brand-red/5 blur-[120px] rounded-full pointer-events-none transition-all duration-1000" style={{ transform: isActive ? 'scale(1.5)' : 'scale(0.5)' }}></div>
                    <div className={`w-64 h-64 rounded-full border-2 glass flex items-center justify-center relative z-10 transition-all duration-700 ${isActive ? 'border-brand-red shadow-[0_0_80px_rgba(217,35,35,0.3)] scale-110' : 'border-white/10 grayscale'}`}>
                        <div className="flex gap-2">{[...Array(8)].map((_,i)=><div key={i} className={`w-1.5 rounded-full bg-brand-red transition-all duration-300 ${isActive ? 'animate-pulse' : 'h-2 bg-neutral-800'}`} style={{ height: isActive ? `${20+Math.random()*60}px` : '10px', animationDelay: `${i*100}ms` }}></div>)}</div>
                    </div>
                    <div className="text-center space-y-4">
                        <h2 className="text-5xl font-display font-black tracking-tight">Voice Link Protocol</h2>
                        <p className="text-neutral-500 font-mono text-[10px] uppercase tracking-[0.5em]">{status}</p>
                    </div>
                    <button onClick={isActive ? ()=>window.location.reload() : start} className={`px-16 py-6 rounded-full font-black uppercase tracking-[0.4em] text-[10px] shadow-2xl relative z-10 ${isActive ? 'bg-white/5 border border-brand-red text-brand-red' : 'bg-brand-red text-white shadow-brand-red/40 hover:scale-105 transition-all'}`}>{isActive ? 'Kill Connection' : 'Establish Voice Link'}</button>
                </div>
            );
        };

        const ArtGallery = () => {
            const [art, setArt] = useState([]);
            useEffect(() => { storage.getArtPieces().then(setArt); }, []);
            return (
                <div className="space-y-12 pb-32">
                    <div className="text-center py-10 relative">
                        <div className="absolute inset-0 bg-brand-gold/5 blur-[100px] rounded-full"></div>
                        <h1 className="text-6xl font-display font-black text-white tracking-tighter mb-2 uppercase">The Vault</h1>
                        <p className="text-brand-gold font-mono text-xs uppercase tracking-[0.4em] font-bold">Secure Asset Repository</p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12">
                        {art.map(item => (
                            <div key={item.id} className="glass-panel rounded-[40px] p-8 border border-white/5 group transition-all hover:-translate-y-2">
                                <div className="aspect-[4/5] rounded-3xl overflow-hidden bg-neutral-900 mb-6 border border-white/10 relative"><img src={item.imageUrl} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-[2s]" /></div>
                                <h3 className="text-2xl font-display font-bold text-white mb-2 uppercase">{item.title}</h3>
                                <div className="flex justify-between items-center pt-4 border-t border-white/5">
                                    <span className="text-brand-gold font-mono font-bold tracking-widest uppercase">{item.price} PTS</span>
                                    <button className="px-6 py-2 bg-brand-red text-white text-[10px] font-black uppercase rounded-full shadow-lg">Secure</button>
                                </div>
                            </div>
                        ))}
                    </div>
                    {art.length === 0 && <div className="py-40 text-center opacity-10 flex flex-col items-center gap-6"><i className="fas fa-lock text-7xl"></i><p className="font-display font-black text-2xl uppercase tracking-widest">Inventory Depleted</p></div>}
                </div>
            );
        };

        const FocusRealm = ({ user, onActivity }) => {
            const [secs, setSecs] = useState(25 * 60); const [active, setActive] = useState(false);
            useEffect(() => {
                let timer; if(active && secs > 0) timer = setInterval(()=>setSecs(s=>s-1), 1000);
                else if(secs === 0 && active) { setActive(false); onActivity(50, 25); alert("SESSION COMPLETE: +50 PTS"); }
                return () => clearInterval(timer);
            }, [active, secs]);
            const format = s => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            return (
                <div className="max-w-4xl mx-auto py-20 text-center space-y-12 animate-in fade-in zoom-in duration-700">
                    <div className="relative w-80 h-80 mx-auto flex items-center justify-center">
                        <div className={`absolute inset-0 rounded-full border-2 border-white/5 transition-all duration-1000 ${active ? 'animate-ping border-brand-red/20' : ''}`}></div>
                        <div className={`w-64 h-64 rounded-full border-8 border-brand-red flex items-center justify-center bg-black shadow-2xl relative z-10 transition-all duration-700 ${active ? 'scale-110 shadow-brand-red/40' : 'grayscale opacity-50'}`}><span className="text-7xl font-mono font-black text-white">{format(secs)}</span></div>
                    </div>
                    <div className="space-y-6">
                        <h2 className="text-4xl font-display font-black uppercase tracking-tighter">Focus Realm</h2>
                        <p className="text-neutral-500 text-sm max-w-sm mx-auto leading-relaxed">Concentrate on your objective. Rank progression is accelerated through verified focus sessions.</p>
                        <div className="flex justify-center gap-6 pt-6">
                            <button onClick={()=>setActive(!active)} className={`px-12 py-5 rounded-2xl font-black uppercase text-[10px] tracking-[0.3em] transition-all shadow-2xl ${active ? 'bg-neutral-800 text-neutral-400' : 'bg-brand-red text-white shadow-brand-red/30 hover:scale-105'}`}>{active ? 'Pause Session' : 'Initiate Session'}</button>
                            <button onClick={()=>{setActive(false); setSecs(25*60);}} className="px-6 py-5 bg-white/5 rounded-2xl text-neutral-600 hover:text-white border border-white/5 transition-all"><i className="fas fa-undo"></i></button>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ onLogin, onBack }) => {
            const [id, setId] = useState(''); const [pass, setPass] = useState(''); const [error, setError] = useState('');
            const handleSubmit = async (e) => {
                e.preventDefault(); if (!id.startsWith('S25')) return setError('INVALID FORMAT (S25XXXX)');
                const user = await storage.getUser(id);
                if (user && user.passwordHash === pass) onLogin(user);
                else {
                    const newUser = { studentId: id, username: 'Agent ' + id.slice(-4), passwordHash: pass, currentRank: '2 of Spades', currentCard: '2♠', totalPoints: 100, joinDate: new Date().toISOString(), stats: { postsCreated: 0, commentsCreated: 0, votesGiven: 0, minutesStudied: 0 }, house: 'Phoenix', isAdmin: id === 'S253456', inventory: [] };
                    await storage.saveUser(newUser); onLogin(newUser);
                }
            };
            return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-brand-obsidian relative">
                    <button onClick={onBack} className="absolute top-12 left-12 text-neutral-600 hover:text-white transition-colors"><i className="fas fa-arrow-left text-2xl"></i></button>
                    <div className="glass-panel p-16 rounded-[64px] w-full max-w-xl space-y-12 border border-white/5 shadow-2xl">
                        <div className="text-center"><h1 className="text-5xl font-display font-black uppercase tracking-tighter">Authenticate</h1><p className="text-brand-red font-mono text-[10px] uppercase tracking-[0.5em] mt-4 font-bold">Protocol Access Required</p></div>
                        <form onSubmit={handleSubmit} className="space-y-8">
                            <input value={id} onChange={e=>setId(e.target.value.toUpperCase())} placeholder="S25XXXX" className="w-full bg-black/50 p-6 rounded-[24px] border border-white/5 outline-none focus:border-brand-red font-mono text-lg transition-all" />
                            <input type="password" value={pass} onChange={e=>setPass(e.target.value)} placeholder="••••••••" className="w-full bg-black/50 p-6 rounded-[24px] border border-white/5 outline-none focus:border-brand-red font-mono text-lg transition-all" />
                            {error && <p className="text-xs text-brand-red font-bold text-center">{error}</p>}
                            <button className="w-full bg-brand-red py-6 rounded-[24px] font-black uppercase tracking-[0.4em] text-[10px] shadow-2xl active:translate-y-1 transition-all">Establish Link</button>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('portfolio'); const [user, setUser] = useState(null); const [tab, setTab] = useState('dashboard');
            useEffect(() => { storage.init(); }, []);
            const handleActivity = async (pts, mins) => {
                const u = await storage.getUser(user.studentId);
                const updated = { ...u, totalPoints: u.totalPoints + pts, stats: { ...u.stats, minutesStudied: (u.stats.minutesStudied || 0) + mins } };
                await storage.saveUser(updated); setUser(updated);
            };
            if (view === 'portfolio') return <Portfolio onEnter={() => setView('auth')} />;
            if (view === 'auth') return <AuthScreen onLogin={(u)=>{setUser(u); setView('app');}} onBack={() => setView('portfolio')} />;
            const tabs = [
                { id: 'dashboard', label: 'Home', icon: 'fa-home' },
                { id: 'chat', label: 'Intelligence', icon: 'fa-brain' },
                { id: 'studio', label: 'Media Studio', icon: 'fa-palette' },
                { id: 'live', label: 'Voice Link', icon: 'fa-microphone' },
                { id: 'focus', label: 'Focus Realm', icon: 'fa-clock' },
                { id: 'vault', label: 'The Vault', icon: 'fa-lock' },
                { id: 'feed', label: 'Network', icon: 'fa-rss' },
                { id: 'council', label: 'Council', icon: 'fa-gavel' },
                { id: 'settings', label: 'Settings', icon: 'fa-cog' }
            ];
            return (
                <div className="flex bg-black min-h-screen">
                    <aside className="w-80 h-screen fixed left-0 top-0 glass-panel border-r border-white/5 flex flex-col p-10 hidden lg:flex shadow-2xl z-50">
                        <h1 className="text-4xl font-display font-black text-brand-red mb-16 tracking-tighter">SPADES</h1>
                        <nav className="flex-1 space-y-3">
                            {tabs.map(t => (
                                <button key={t.id} onClick={()=>setTab(t.id)} className={`w-full flex items-center gap-5 p-5 rounded-[20px] transition-all ${tab===t.id ? 'bg-brand-red text-white shadow-2xl' : 'text-neutral-500 hover:text-white hover:bg-white/5'}`}>
                                    <i className={`fas ${t.icon} w-6 text-center`}></i><span className="font-bold text-[10px] uppercase tracking-[0.2em]">{t.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="mt-auto flex items-center gap-5 pt-8 border-t border-white/5 group">
                            <CardVisual rankId={user.currentCard} size="sm" className="group-hover:rotate-6 transition-transform" />
                            <div className="flex-1 min-w-0">
                                <p className="font-display font-black text-sm truncate uppercase tracking-tight">{user.username}</p>
                                <button onClick={()=>window.location.reload()} className="text-[9px] text-neutral-600 hover:text-brand-red uppercase font-black transition-colors tracking-widest">Kill Session</button>
                            </div>
                        </div>
                    </aside>
                    <main className="flex-1 lg:ml-80 p-8 lg:p-16">
                        <div className="max-w-6xl mx-auto min-h-[calc(100vh-8rem)]">
                            {tab === 'dashboard' && <DashboardView user={user} />}
                            {tab === 'chat' && <ChatView />}
                            {tab === 'studio' && <StudioView />}
                            {tab === 'live' && <LiveView />}
                            {tab === 'focus' && <FocusRealm user={user} onActivity={handleActivity} />}
                            {tab === 'vault' && <ArtGallery />}
                            {tab === 'feed' && <div className="py-40 text-center opacity-10 flex flex-col items-center gap-6"><i className="fas fa-rss text-6xl"></i><p className="font-display font-black text-2xl uppercase tracking-[0.3em]">Network Congested</p></div>}
                            {tab === 'council' && <div className="py-40 text-center opacity-10 flex flex-col items-center gap-6"><i className="fas fa-gavel text-6xl"></i><p className="font-display font-black text-2xl uppercase tracking-[0.3em]">Council Recessed</p></div>}
                            {tab === 'settings' && <div className="py-40 text-center opacity-10 flex flex-col items-center gap-6"><i className="fas fa-cog text-6xl"></i><p className="font-display font-black text-2xl uppercase tracking-[0.3em]">Module Restricted</p></div>}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>